<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2196F3">
    <meta name="description" content="プロフェッショナルシフト管理アプリ - Excel連携・基準UPH自動抽出対応">
    <title>シフト管理プロ v4.1 - 完全版（基準UPH自動抽出）</title>
    
    <!-- PWA用のアイコンとメタデータ -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiMyMTk2RjMiIHJ4PSI0Ii8+PHBhdGggZD0iTTYgOWgxMnYySDE2em0wIDRoMTJ2MkgxNnptMC00aDEyVjlIMTZ6IiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFJklEQVR4nO3d0W4TMRRF0fH//5TyQKnUqI7tmdzeaxFVtO3c2bPGnknSdd33fQBHffrXCwBnCQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQ9hdNHBXz0j6qYwAAAABJRU5ErkJggg==">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2196F3;
            --primary-dark: #1976D2;
            --secondary-color: #4CAF50;
            --accent-color: #FF9800;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --glass: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        [data-theme="dark"] {
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --glass: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(51, 65, 85, 0.3);
        }

        .viewer-app-btn {
            background: linear-gradient(45deg, #FF9800, #FFB74D);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 8px;
        }

        .viewer-app-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
            background: linear-gradient(45deg, #F57C00, #FF9800);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Noto Sans JP', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            animation: slideDown 0.6s ease-out;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 2.5rem;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-toggle {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            background: var(--surface);
        }

        .install-btn {
            background: linear-gradient(45deg, var(--accent-color), #FF6F00);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
        }

        .step-container {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            animation: slideUp 0.6s ease-out;
            animation-fill-mode: both;
        }

        .step-container:nth-child(2) { animation-delay: 0.1s; }
        .step-container:nth-child(3) { animation-delay: 0.2s; }
        .step-container:nth-child(4) { animation-delay: 0.3s; }

        .step-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .step-number {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .step-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .step-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-top: 4px;
        }

        .upload-zone {
            border: 3px dashed var(--border);
            border-radius: 16px;
            padding: 48px 24px;
            text-align: center;
            background: var(--surface);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: var(--primary-color);
            background: linear-gradient(45deg, rgba(33, 150, 243, 0.05), rgba(76, 175, 80, 0.05));
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 16px;
            animation: bounce 2s infinite;
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .file-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .progress-container {
            margin-top: 16px;
            display: none;
        }

        .progress-bar {
            background: var(--border);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .file-info {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            display: none;
        }

        .select-section {
            display: none;
        }

        .sheet-select {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 200px;
        }

        .sheet-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .date-controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .generate-btn {
            background: linear-gradient(45deg, var(--secondary-color), #388E3C);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        .results-container {
            display: none;
        }

        .calculation-panel {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .calc-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .calc-card {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(76, 175, 80, 0.1));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .calc-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .calc-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .calc-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .calc-unit {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .calc-input {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            width: 100%;
            max-width: 120px;
            margin: 4px auto;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .table-container {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: auto;
        }

        .table-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .shift-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .shift-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .shift-table th:first-child {
            border-radius: 8px 0 0 8px;
        }

        .shift-table th:last-child {
            border-radius: 0 8px 8px 0;
        }

        .shift-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .shift-table tr:hover {
            background: rgba(33, 150, 243, 0.05);
        }

        .working {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(139, 195, 74, 0.1)) !important;
        }

        .confirmed {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.15), rgba(63, 81, 181, 0.15)) !important;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .confirmed .row-confirm-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        .confirmed .row-confirm-btn:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
        }

        .editable-cell {
            background: rgba(255, 193, 7, 0.1) !important;
            cursor: text;
            border-radius: 4px;
            transition: all 0.2s ease;
            min-width: 60px;
            position: relative;
        }

        .editable-cell:hover {
            background: rgba(255, 193, 7, 0.2) !important;
        }

        .editable-cell:focus {
            background: var(--surface) !important;
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }

        .time-cell {
            min-width: 80px;
            font-family: 'Courier New', monospace;
            text-align: center;
        }

        .status-cell {
            padding: 6px 8px;
        }

        .status-select {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 70px;
        }

        .status-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        .status-select option {
            background: var(--surface);
            color: var(--text-primary);
        }

        .action-cell {
            padding: 6px 8px;
            text-align: center;
            width: 100px;
        }

        .row-reset-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 28px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            margin-right: 4px;
        }

        .row-reset-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .row-reset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .row-reset-btn:hover::before {
            left: 100%;
        }

        .row-reset-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .row-reset-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.5);
        }

        .row-confirm-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 28px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .row-confirm-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .row-confirm-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, #43A047 0%, #2E7D32 100%);
        }

        .row-confirm-btn:hover::before {
            left: 100%;
        }

        .row-confirm-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .row-confirm-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5);
        }

        .add-row-btn {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #43A047 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
            flex-shrink: 0;
        }

        .add-row-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, #43A047 0%, #388E3C 100%);
        }

        .add-row-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            flex: 1;
            justify-content: flex-end;
        }

        .action-btn {
            background: linear-gradient(45deg, var(--accent-color), #F57C00);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.3);
        }

        .action-btn.primary {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
        }

        .action-btn.success {
            background: linear-gradient(45deg, var(--secondary-color), #388E3C);
        }

        .action-btn.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .status-message.show {
            transform: translateX(0);
        }

        .status-message.success {
            background: linear-gradient(45deg, var(--secondary-color), #43A047);
        }

        .status-message.error {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .hidden {
            display: none !important;
        }

        /* 基準UPH自動抽出関連のスタイル */
        .uph-auto-indicator {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
            display: inline-block;
        }

        .uph-manual-indicator {
            background: linear-gradient(45deg, #FF9800, #FFC107);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
            display: inline-block;
        }

        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                padding: 12px;
            }

            .header {
                padding: 20px;
                border-radius: 16px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .logo {
                font-size: 2rem;
            }

            .title {
                font-size: 1.5rem;
            }

            .step-container {
                padding: 20px;
                border-radius: 16px;
            }

            .upload-zone {
                padding: 32px 16px;
            }

            .date-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .calc-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .action-buttons {
                justify-content: center;
            }

            .shift-table {
                font-size: 0.8rem;
            }

            .shift-table th,
            .shift-table td {
                padding: 8px 6px;
            }

            .status-select {
                max-width: 60px;
                font-size: 0.8rem;
                padding: 2px 4px;
            }

            .row-reset-btn,
            .row-confirm-btn {
                width: 32px;
                height: 24px;
                font-size: 0.7rem;
                border-radius: 6px;
            }

            .action-cell {
                width: 80px;
            }
        }

        @media (max-width: 480px) {
            .step-header {
                flex-direction: column;
                text-align: center;
            }

            .calc-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .header,
            .table-controls,
            .install-btn,
            .theme-toggle,
            .row-reset-btn,
            .row-confirm-btn {
                display: none;
            }

            .step-container {
                background: white;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">📊</div>
                    <div>
                        <h1 class="title">シフト管理プロ</h1>
                        <p class="subtitle">Professional Shift Management v4.1 完全版（基準UPH自動抽出）</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="toggleTheme()" title="ダークモード切替">
                        <span id="themeIcon">🌙</span>
                    </button>
                    <a href="./fukugen.html" target="_blank" class="viewer-app-btn">
                        📊 詳細データ復元
                    </a>
                    <a href="./mobile.html" target="_blank" class="viewer-app-btn" style="background: linear-gradient(45deg, #9C27B0, #E91E63);">
                        📱 モバイル版
                    </a>                    
                    <button class="install-btn" id="installBtn" onclick="installApp()">
                        📱 アプリをインストール
                    </button>
                </div>
            </div>
        </header>

        <!-- Step 1: File Upload -->
        <section class="step-container">
            <div class="step-header">
                <div class="step-number">1</div>
                <div>
                    <h2 class="step-title">Excelファイルをアップロード</h2>
                    <p class="step-description">月間シフト表のExcelファイル（.xlsx/.xls）をドラッグ＆ドロップまたはクリックして選択<br>
                    📈 基準UPHが自動的に検出され、日付に応じて反映されます<br>
                    ⚠️ 会社名が空白の行は自動的に除外されます</p>
                </div>
            </div>
            
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">📁</div>
                <div class="upload-text">ファイルをドラッグ＆ドロップ</div>
                <div class="upload-hint">または、クリックしてファイルを選択してください</div>
                <input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls">
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressText">ファイルを読み込み中...</div>
            </div>
            
            <div class="file-info" id="fileInfo">
                <div id="fileName"></div>
            </div>
        </section>

        <!-- Step 2: Sheet Selection -->
        <section class="step-container select-section" id="sheetSection">
            <div class="step-header">
                <div class="step-number">2</div>
                <div>
                    <h2 class="step-title">シートを選択</h2>
                    <p class="step-description">分析したい勤務シート（日勤・夜勤）を選択してください<br>
                    🎯 選択したシートから自動的に基準UPHが抽出されます</p>
                </div>
            </div>
            
            <select class="sheet-select" id="sheetSelect">
                <option value="">シートを選択してください</option>
            </select>
        </section>

        <!-- Step 3: Date Selection and Generation -->
        <section class="step-container" id="dateSection">
            <div class="step-header">
                <div class="step-number">3</div>
                <div>
                    <h2 class="step-title">日付選択とシフト表生成</h2>
                    <p class="step-description">表示したい日付を選択してシフト表を生成してください<br>
                    📅 日付変更時に基準UPHが自動的に更新されます</p>
                </div>
            </div>
            
            <div class="date-controls">
                <label for="targetDate">📅 対象日付:</label>
                <input type="date" class="date-input" id="targetDate">
                <button class="generate-btn" id="generateBtn" onclick="generateDailyShift()" disabled>
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="generateText">🚀 シフト表を生成</span>
                </button>
            </div>
        </section>

        <!-- Results Section -->
        <div class="results-container" id="resultsContainer">
            <!-- Calculation Panel -->
            <div class="calculation-panel" id="calculationPanel">
                <div class="calc-header">
                    <div class="step-number">📈</div>
                    <div>
                        <h3>LH計算・分析</h3>
                        <p class="step-description">労働時間と生産性の詳細分析（夜勤手当・残業代込み）<br>
                        🔄 基準UPHは従業員リストから自動抽出されます</p>
                    </div>
                </div>
                <div class="calc-grid" id="calcGrid"></div>
            </div>

            <!-- Data Table -->
            <div class="table-container" id="tableContainer">
                <div class="table-controls">
                    <button class="add-row-btn" onclick="addNewRow()">
                        ➕ 行を追加
                    </button>
                    
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="generateAttendanceCheck()">
                            📋 出退勤確認表
                        </button>
                        <button class="action-btn" onclick="sendToViewer()">
                            🚀 ビューアで編集
                        </button>
                        <button class="action-btn" onclick="exportToExcel()">
                            📊 詳細データ
                        </button>
                        <button class="action-btn" onclick="exportCompanySummary()">
                            📈 会社別集計
                        </button>
                        <button class="action-btn success" onclick="exportCombinedSummary()">
                            🔄 日勤+夜勤合算
                        </button>
                        <button class="action-btn" onclick="testViewerConnection()" style="background: linear-gradient(45deg, #9E9E9E, #757575);">
                            🔧 送信テスト
                        </button>
                        <button class="action-btn danger" onclick="resetData()">
                            🔄 完全リセット
                        </button>
                    </div>
                </div>
                
                <table class="shift-table" id="shiftTable"></table>
            </div>
        </div>
    </div>

    <!-- Status Message -->
    <div class="status-message" id="statusMessage"></div>

    <script>
        // Global variables
        let workbook = null;
        let workbookData = null;
        let dateColumns = [];
        let originalShiftData = [];
        let planValue = 12200;
        let fcstValue = 16273;
        let baseUPH = 22;
        let isNightShift = false;
        let deferredPrompt = null;
        let isUPHAutoExtracted = false;
        let allCompanies = [];

        // App initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            registerServiceWorker();
            setupPWA();
        });

        function exportToExcel() {
            if (!document.querySelector('.shift-table')) {
                showStatus('エクスポートするデータがありません', 'error');
                return;
            }

            try {
                const targetDate = document.getElementById('targetDate').value;
                const selectedSheet = document.getElementById('sheetSelect').value;
                const dateObj = new Date(targetDate);
                const formattedDate = `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月${dateObj.getDate()}日 ${selectedSheet}シフト表`;

                const data = [];
                data.push([formattedDate]);
                data.push([`基準UPH: ${baseUPH} ${isUPHAutoExtracted ? '(自動抽出)' : '(手動設定)'}`]);
                data.push([]);

                const headers = ['会社名', '時間帯', 'メイン業務', '氏名', '性別', '時給', '交通費', '開始時間', '終了時間', '休憩', '勤務状況', '勤務LH', '夜勤時間', '残業時間'];
                data.push(headers);

                const tableData = getCurrentTableData();
                tableData.forEach(emp => {
                    const startTime = parseTime(emp.startTime);
                    const endTime = parseTime(emp.endTime);
                    const breakTime = parseTime(emp.break);
                    
                    const workHours = emp.isWorking && startTime !== null && endTime !== null ? 
                        calculateWorkHours(startTime, endTime, breakTime) : 0;
                    const nightHours = emp.isWorking && startTime !== null && endTime !== null ? 
                        calculateNightShiftHours(startTime, endTime, breakTime) : 0;
                    const overtimeHours = emp.isWorking ? Math.max(0, workHours - 8) : 0;
                    
                    data.push([
                        emp.company, emp.timeSlot, emp.mainJob, emp.name, emp.gender,
                        emp.hourlyWage, emp.transportation, emp.startTime, emp.endTime,
                        emp.break, emp.status, 
                        workHours > 0 ? workHours.toFixed(2) : '',
                        nightHours > 0 ? nightHours.toFixed(2) : '',
                        overtimeHours > 0 ? overtimeHours.toFixed(2) : ''
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [
                    { width: 15 }, { width: 10 }, { width: 12 }, { width: 15 }, { width: 8 }, { width: 10 },
                    { width: 12 }, { width: 10 }, { width: 10 }, { width: 8 }, { width: 10 }, { width: 10 }, { width: 10 }, { width: 10 }
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '詳細データ');
                
                const fileName = targetDate ? `${targetDate}_${selectedSheet}_詳細データ.xlsx` : `${selectedSheet}_詳細データ.xlsx`;
                XLSX.writeFile(wb, fileName);
                showStatus('詳細データをダウンロードしました', 'success');
                
            } catch (error) {
                console.error('エクスポートエラー:', error);
                showStatus('エクスポートに失敗しました: ' + error.message, 'error');
            }
        }

        function exportCompanySummary() {
            if (!document.querySelector('.shift-table')) {
                showStatus('エクスポートするデータがありません', 'error');
                return;
            }

            if (!allCompanies || allCompanies.length === 0) {
                showStatus('会社リストが抽出されていません', 'error');
                return;
            }

            try {
                const companySummary = generateCompanySummary();
                
                const targetDate = document.getElementById('targetDate').value;
                const selectedSheet = document.getElementById('sheetSelect').value;
                const dateObj = new Date(targetDate);
                const formattedDate = `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月${dateObj.getDate()}日 ${selectedSheet}`;

                const data = [];
                data.push([formattedDate + ' 会社別集計']);
                data.push([`基準UPH: ${baseUPH} ${isUPHAutoExtracted ? '(自動抽出)' : '(手動設定)'}`]);
                data.push([]);
                
                data.push(['HC']);
                // 全会社を固定順序で出力
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { hc: 0, totalLH: 0, totalCost: 0 };
                    data.push([company, summary.hc || '']);
                });
                
                const totalHC = Object.values(companySummary).reduce((sum, s) => sum + s.hc, 0);
                data.push(['', totalHC]);
                data.push([]);
                
                data.push(['経費']);
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { hc: 0, totalLH: 0, totalCost: 0 };
                    const cost = summary.totalCost || 0;
                    data.push([company, cost > 0 ? Math.round(cost) : '']);
                });
                data.push(['', Math.round(Object.values(companySummary).reduce((sum, s) => sum + s.totalCost, 0))]);
                data.push([]);
                
                data.push(['LH']);
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { hc: 0, totalLH: 0, totalCost: 0 };
                    const lh = summary.totalLH || 0;
                    data.push([company, lh > 0 ? Math.round(lh) : '']);
                });
                data.push(['', Math.round(Object.values(companySummary).reduce((sum, s) => sum + s.totalLH, 0))]);

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{ width: 15 }, { width: 12 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '会社別集計');
                
                const fileName = targetDate ? `${targetDate}_${selectedSheet}_会社別集計.xlsx` : `${selectedSheet}_会社別集計.xlsx`;
                XLSX.writeFile(wb, fileName);
                showStatus('会社別集計データをダウンロードしました', 'success');
                
            } catch (error) {
                console.error('会社別集計エラー:', error);
                showStatus('会社別集計エクスポートに失敗しました: ' + error.message, 'error');
            }
        }

        function generateCompanySummary() {
            const tableData = getCurrentTableData();
            const companySummary = {};
            
            tableData.forEach(emp => {
                if (emp.isWorking && emp.company.trim()) {
                    const company = emp.company.trim();
                    const hourlyWageStr = emp.hourlyWage || '0';
                    const transportationStr = emp.transportation || '0';
                    
                    const hourlyWage = parseFloat(String(hourlyWageStr).replace(/[^\d.]/g, '')) || 0;
                    const transportation = parseFloat(String(transportationStr).replace(/[^\d.]/g, '')) || 0;
                    
                    if (!companySummary[company]) {
                        companySummary[company] = { hc: 0, totalLH: 0, totalCost: 0 };
                    }
                    
                    companySummary[company].hc += 1;
                    
                    const startTime = parseTime(emp.startTime);
                    const endTime = parseTime(emp.endTime);
                    const breakTime = parseTime(emp.break);
                    
                    if (startTime !== null && endTime !== null) {
                        const workHours = calculateWorkHours(startTime, endTime, breakTime);
                        const nightHours = calculateNightShiftHours(startTime, endTime, breakTime);
                        const overtimeHours = Math.max(0, workHours - 8);
                        
                        companySummary[company].totalLH += workHours;
                        
                        const regularHours = Math.max(0, workHours - overtimeHours);
                        const baseCost = regularHours * hourlyWage;
                        const overtimeBaseCost = overtimeHours * hourlyWage;
                        const nightAllowance = nightHours * hourlyWage * 0.25;
                        const overtimeAllowance = overtimeHours * hourlyWage * 0.25;
                        
                        companySummary[company].totalCost += baseCost + overtimeBaseCost + nightAllowance + overtimeAllowance + transportation;
                    } else {
                        companySummary[company].totalCost += transportation;
                    }
                }
            });
            
            return companySummary;
        }

        function exportCombinedSummary() {
            if (!workbook) {
                showStatus('Excelファイルが読み込まれていません', 'error');
                return;
            }

            if (!allCompanies || allCompanies.length === 0) {
                showStatus('会社リストが抽出されていません', 'error');
                return;
            }

            const hasDay = workbook.SheetNames.includes('日勤');
            const hasNight = workbook.SheetNames.includes('夜勤');
            
            if (!hasDay && !hasNight) {
                showStatus('日勤・夜勤シートが見つかりません', 'error');
                return;
            }

            try {
                const companySummary = generateCombinedCompanySummary();

                const targetDate = document.getElementById('targetDate').value;
                const dateObj = new Date(targetDate);
                const formattedDate = `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月${dateObj.getDate()}日`;

                const data = [];
                data.push([formattedDate + ' 日勤+夜勤合算集計']);
                
                const availableShifts = [];
                if (hasDay) availableShifts.push('日勤');
                if (hasNight) availableShifts.push('夜勤');
                data.push([`対象シフト: ${availableShifts.join('・')}`]);
                data.push([`基準UPH: ${baseUPH} ${isUPHAutoExtracted ? '(自動抽出)' : '(手動設定)'}`]);
                data.push([]);
                
                data.push(['HC', '', '日勤', '夜勤', '合計']);
                // 全会社を固定順序で出力
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { 
                        hc: 0, totalLH: 0, totalCost: 0, 
                        dayShiftHC: 0, nightShiftHC: 0 
                    };
                    data.push([
                        company, 
                        '', 
                        summary.dayShiftHC || '', 
                        summary.nightShiftHC || '', 
                        summary.hc || ''
                    ]);
                });
                
                const totalHC = Object.values(companySummary).reduce((sum, s) => sum + s.hc, 0);
                const totalDayHC = Object.values(companySummary).reduce((sum, s) => sum + (s.dayShiftHC || 0), 0);
                const totalNightHC = Object.values(companySummary).reduce((sum, s) => sum + (s.nightShiftHC || 0), 0);
                data.push(['合計', '', totalDayHC, totalNightHC, totalHC]);
                data.push([]);
                
                data.push(['経費']);
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { 
                        hc: 0, totalLH: 0, totalCost: 0, 
                        dayShiftHC: 0, nightShiftHC: 0 
                    };
                    const cost = summary.totalCost || 0;
                    data.push([company, cost > 0 ? Math.round(cost) : '']);
                });
                data.push(['合計', Math.round(Object.values(companySummary).reduce((sum, s) => sum + s.totalCost, 0))]);
                data.push([]);
                
                data.push(['LH']);
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { 
                        hc: 0, totalLH: 0, totalCost: 0, 
                        dayShiftHC: 0, nightShiftHC: 0 
                    };
                    const lh = summary.totalLH || 0;
                    data.push([company, lh > 0 ? Math.round(lh) : '']);
                });
                data.push(['合計', Math.round(Object.values(companySummary).reduce((sum, s) => sum + s.totalLH, 0))]);

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{ width: 15 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 10 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '日勤夜勤合算集計');
                
                const fileName = targetDate ? `${targetDate}_日勤夜勤合算集計.xlsx` : '日勤夜勤合算集計.xlsx';
                XLSX.writeFile(wb, fileName);
                showStatus('日勤+夜勤合算集計データをダウンロードしました', 'success');
                
            } catch (error) {
                console.error('合算集計エラー:', error);
                showStatus('合算集計エクスポートに失敗しました: ' + error.message, 'error');
            }
        }

        function generateCombinedCompanySummary() {
            const targetDateStr = document.getElementById('targetDate').value;
            if (!targetDateStr || !workbook) return null;

            const targetDate = new Date(targetDateStr);
            const companySummary = {};
            
            const shiftsToProcess = ['日勤', '夜勤'];
            
            shiftsToProcess.forEach(sheetName => {
                if (!workbook.SheetNames.includes(sheetName)) return;
                
                try {
                    const worksheet = workbook.Sheets[sheetName];
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (!sheetData || sheetData.length < 2) return;
                    
                    const headerRow = sheetData[0];
                    const sheetDateColumns = [];
                    
                    headerRow.forEach((cell, index) => {
                        if (typeof cell === 'number' && cell >= 45000) {
                            const excelDate = new Date((cell - 25569) * 86400 * 1000);
                            sheetDateColumns.push({
                                index: index,
                                excelValue: cell,
                                date: excelDate
                            });
                        }
                    });
                    
                    let targetColumnIndex = -1;
                    let minDiff = Infinity;
                    
                    sheetDateColumns.forEach(col => {
                        const diff = Math.abs(col.date.getTime() - targetDate.getTime());
                        if (diff < minDiff) {
                            minDiff = diff;
                            targetColumnIndex = col.index;
                        }
                    });
                    
                    if (targetColumnIndex === -1) return;
                    
                    const excludeKeywords = [
                        'PLAN', 'FCST', 'UPH', 'HC', 'LH', 
                        '出勤HC', '出勤LH', '必要LH', '過不足', 'HC換算',
                        '夜勤手当', '残業手当', '総費用', '平均単価',
                        '実績UPH', '基準UPH', 'FCST数量', 'PLAN数量'
                    ];
                    
                    for (let i = 1; i < sheetData.length; i++) {
                        const row = sheetData[i];
                        if (!row || row.length === 0) continue;
                        
                        const employeeData = {
                            company: row[0] != null ? String(row[0]) : '',
                            timeSlot: row[1] != null ? String(row[1]) : '',
                            mainJob: row[2] != null ? String(row[2]) : '',
                            name: row[3] != null ? String(row[3]) : '',
                            gender: row[4] != null ? String(row[4]) : '',
                            hourlyWage: row[5] != null ? String(row[5]) : '',
                            transportation: row[6] != null ? String(row[6]) : '',
                            startTime: row[7] != null ? String(row[7]) : '',
                            endTime: row[8] != null ? String(row[8]) : '',
                            break: row[9] != null ? String(row[9]) : '',
                            status: row[targetColumnIndex] != null ? String(row[targetColumnIndex]) : ''
                        };
                        
                        const shouldExclude = excludeKeywords.some(keyword => {
                            return employeeData.company.includes(keyword) ||
                                   employeeData.timeSlot.includes(keyword) ||
                                   employeeData.mainJob.includes(keyword) ||
                                   employeeData.name.includes(keyword) ||
                                   employeeData.gender.includes(keyword);
                        });
                        
                        if (shouldExclude) continue;
                        if (!employeeData.company.trim()) continue;
                        if (!employeeData.name.trim() && !employeeData.company.trim()) continue;
                        if (employeeData.name.trim() && /^\d+$/.test(employeeData.name.trim())) continue;
                        
                        if (employeeData.status === '◯') {
                            const company = employeeData.company.trim();
                            const hourlyWageStr = employeeData.hourlyWage || '0';
                            const transportationStr = employeeData.transportation || '0';
                            
                            const hourlyWage = parseFloat(String(hourlyWageStr).replace(/[^\d.]/g, '')) || 0;
                            const transportation = parseFloat(String(transportationStr).replace(/[^\d.]/g, '')) || 0;
                            
                            if (!companySummary[company]) {
                                companySummary[company] = {
                                    hc: 0, totalLH: 0, totalCost: 0,
                                    dayShiftHC: 0, nightShiftHC: 0
                                };
                            }
                            
                            companySummary[company].hc += 1;
                            
                            if (sheetName === '夜勤') {
                                companySummary[company].nightShiftHC += 1;
                            } else {
                                companySummary[company].dayShiftHC += 1;
                            }
                            
                            const startTime = parseTime(employeeData.startTime);
                            const endTime = parseTime(employeeData.endTime);
                            const breakTime = parseTime(employeeData.break);
                            
                            if (startTime !== null && endTime !== null) {
                                const isCurrentNightShift = sheetName === '夜勤';
                                const workHours = calculateWorkHoursForSheet(startTime, endTime, breakTime, isCurrentNightShift);
                                const nightHours = calculateNightShiftHours(startTime, endTime, breakTime);
                                const overtimeHours = Math.max(0, workHours - 8);
                                
                                companySummary[company].totalLH += workHours;
                                
                                const regularHours = Math.max(0, workHours - overtimeHours);
                                const baseCost = regularHours * hourlyWage;
                                const overtimeBaseCost = overtimeHours * hourlyWage;
                                const nightAllowance = nightHours * hourlyWage * 0.25;
                                const overtimeAllowance = overtimeHours * hourlyWage * 0.25;
                                
                                companySummary[company].totalCost += baseCost + overtimeBaseCost + nightAllowance + overtimeAllowance + transportation;
                            } else {
                                companySummary[company].totalCost += transportation;
                            }
                        }
                    }
                } catch (error) {
                    console.error(`${sheetName}シートの処理エラー:`, error);
                }
            });
            
            return companySummary;
        }

        function calculateWorkHoursForSheet(startTime, endTime, breakTime, isNightShift) {
            if (startTime === null || endTime === null) {
                return 0;
            }
            
            let workHours;
            
            if (isNightShift) {
                if (endTime < startTime) {
                    workHours = (24 + endTime) - startTime;
                } else {
                    workHours = endTime - startTime;
                }
            } else {
                if (endTime < startTime) {
                    workHours = endTime - startTime + 24;
                } else {
                    workHours = endTime - startTime;
                }
            }
            
            if (breakTime !== null && breakTime > 0) {
                workHours -= breakTime;
            }
            
            return Math.max(0, workHours);
        }

        function resetData() {
            if (confirm('すべてのデータをリセットしますか？')) {
                document.body.style.opacity = '0.5';
                setTimeout(() => {
                    location.reload();
                }, 300);
            }
        }

        function testViewerConnection() {
            console.log('=== ビューア接続テスト開始 ===');
            
            const testData = {
                employeeData: [
                    {
                        '会社名': 'テスト会社A',
                        '時間帯': '日勤',
                        'メイン業務': 'テスト業務',
                        '氏名': 'テスト太郎',
                        '性別': '男',
                        '時給': '1000',
                        '交通費': '500',
                        '開始時間': '9:00',
                        '終了時間': '18:00',
                        '休憩': '1:00',
                        '勤務状況': '◯',
                        '勤務LH': '8.00',
                        '夜勤時間': '0.00',
                        '残業時間': '0.00'
                    }
                ],
                shiftTitle: 'テストシフト表 - ' + new Date().toLocaleString('ja-JP'),
                isNightShift: false,
                baseUPH: 25,
                planValue: 15000,
                fcstValue: 18000,
                transferTimestamp: Date.now()
            };

            console.log('テストデータ:', testData);

            const isFileProtocol = window.location.protocol === 'file:';
            
            if (isFileProtocol) {
                try {
                    localStorage.setItem('shiftDataTransfer', JSON.stringify(testData));
                    localStorage.setItem('shiftDataTransfer_timestamp', Date.now().toString());
                    console.log('file://プロトコル: localStorageにテストデータを保存');
                } catch (error) {
                    console.error('localStorage保存エラー:', error);
                    showStatus('localStorageへの保存に失敗しました', 'error');
                    return;
                }
            } else {
                localStorage.setItem('shiftDataTransfer', JSON.stringify(testData));
            }
            
            const viewerWindow = window.open('./viewer.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (!viewerWindow) {
                showStatus('ポップアップがブロックされました', 'error');
                return;
            }

            setTimeout(() => {
                try {
                    viewerWindow.postMessage({
                        type: 'SHIFT_DATA_TRANSFER',
                        data: testData
                    }, '*');
                    console.log('PostMessageでテストデータを送信');
                } catch (error) {
                    console.error('PostMessage送信エラー:', error);
                }
            }, 1000);

            showStatus('テストデータでビューアを開きました', 'success');
            console.log('=== ビューア接続テスト完了 ===');
        }

        function initializeApp() {
            document.getElementById('targetDate').value = new Date().toISOString().split('T')[0];
            setupFileUpload();
            document.getElementById('sheetSelect').addEventListener('change', handleSheetChange);
            document.getElementById('targetDate').addEventListener('change', handleDateChange);
            loadTheme();
            cleanupOldTransferData();
            if (window.location.protocol === 'file:') {
                setTimeout(showFileProtocolWarning, 2000);
            }
            showStatus('アプリが準備完了しました', 'success');
        }

        function showFileProtocolWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(45deg, #FF5722, #F44336);
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                max-width: 380px;
                z-index: 1001;
                font-size: 0.9rem;
                line-height: 1.4;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;
            
            warningDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px;">⚠️ Webサーバーを推奨</div>
                <div style="margin-bottom: 12px;">
                    現在file://プロトコルで実行中です。<br>
                    「🚀 ビューアで編集」機能が制限される可能性があります。<br>
                    <strong>Webサーバーでの実行を強く推奨します。</strong>
                </div>
                <button onclick="this.parentElement.remove(); showServerInstructions();" 
                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
                               color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer;">
                    📖 サーバー起動方法
                </button>
                <button onclick="this.parentElement.remove();" 
                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
                               color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-left: 8px;">
                    ❌ 理解しました
                </button>
            `;
            
            document.body.appendChild(warningDiv);
            setTimeout(() => {
                if (warningDiv.parentElement) {
                    warningDiv.remove();
                }
            }, 15000);
        }

        function cleanupOldTransferData() {
            try {
                const storedData = localStorage.getItem('shiftDataTransfer');
                if (storedData) {
                    const transferData = JSON.parse(storedData);
                    const currentTime = Date.now();
                    const dataAge = currentTime - transferData.transferTimestamp;
                    if (dataAge > 300000) {
                        localStorage.removeItem('shiftDataTransfer');
                        console.log('古い転送データをクリーンアップしました');
                    }
                }
            } catch (error) {
                localStorage.removeItem('shiftDataTransfer');
            }
        }

        function handleDateChange() {
            if (workbookData && dateColumns.length > 0) {
                extractPlanValue();
                extractFcstValue();
                extractBaseUPH();
                if (document.getElementById('resultsContainer').style.display !== 'none') {
                    const currentData = getCurrentTableData();
                    if (currentData && currentData.length > 0) {
                        updateCalculations(currentData);
                        showStatus(`日付変更に伴い基準UPH: ${baseUPH} に更新されました`, 'success');
                    }
                }
            }
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
                    const CACHE_NAME = 'shift-app-v4-1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `))
                .then(registration => {
                    console.log('ServiceWorker registered successfully');
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed');
                });
            }
        }

        function setupPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installBtn').style.display = 'block';
            });
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showStatus('アプリがインストールされました！', 'success');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBtn').style.display = 'none';
                });
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
            }
        }

        function setupFileUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            uploadZone.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        function handleFileSelect(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showStatus('Excelファイル（.xlsx/.xls）を選択してください', 'error');
                return;
            }
            showProgress(true);
            setTimeout(() => {
                processFile(file);
            }, 100);
        }

        function showProgress(show, progress = 0) {
            const container = document.getElementById('progressContainer');
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            
            if (show) {
                container.style.display = 'block';
                fill.style.width = progress + '%';
                if (progress === 0) {
                    text.textContent = 'ファイルを読み込み中...';
                } else if (progress < 50) {
                    text.textContent = 'データを解析中...';
                } else if (progress < 90) {
                    text.textContent = 'シート情報を取得中...';
                } else {
                    text.textContent = '処理完了';
                }
            } else {
                container.style.display = 'none';
            }
        }

        function processFile(file) {
            const reader = new FileReader();
            
            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    const progress = (e.loaded / e.total) * 100;
                    showProgress(true, progress);
                }
            };
            
            reader.onload = function(e) {
                try {
                    showProgress(true, 90);
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    document.getElementById('fileName').textContent = `✅ ${file.name} (${formatFileSize(file.size)})`;
                    document.getElementById('fileInfo').style.display = 'block';
                    setupSheetSelection();
                    showProgress(false);
                    showStatus('ファイルが正常に読み込まれました', 'success');
                } catch (error) {
                    showProgress(false);
                    showStatus('ファイルの読み込みに失敗しました: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function setupSheetSelection() {
            const sheetSelect = document.getElementById('sheetSelect');
            const sheetSection = document.getElementById('sheetSection');
            
            sheetSelect.innerHTML = '<option value="">シートを選択してください</option>';
            
            const targetSheets = ['日勤', '夜勤'];
            let hasSheets = false;
            
            targetSheets.forEach(sheetName => {
                if (workbook.SheetNames.includes(sheetName)) {
                    const option = document.createElement('option');
                    option.value = sheetName;
                    option.textContent = `${sheetName}シフト`;
                    sheetSelect.appendChild(option);
                    hasSheets = true;
                }
            });
            
            if (!hasSheets) {
                sheetSelect.innerHTML = '<option value="">日勤・夜勤シートが見つかりません</option>';
                showStatus('ファイルに「日勤」または「夜勤」シートが見つかりません', 'error');
                return;
            }
            
            // 全会社リストを抽出
            extractAllCompanies();
            
            sheetSection.style.display = 'block';
        }

        function extractAllCompanies() {
            const companiesSet = new Set();
            const targetSheets = ['日勤', '夜勤'];
            
            const excludeKeywords = [
                'PLAN', 'FCST', 'UPH', 'HC', 'LH', 
                '出勤HC', '出勤LH', '必要LH', '過不足', 'HC換算',
                '夜勤手当', '残業手当', '総費用', '平均単価',
                '実績UPH', '基準UPH', 'FCST数量', 'PLAN数量'
            ];
            
            targetSheets.forEach(sheetName => {
                if (!workbook.SheetNames.includes(sheetName)) return;
                
                try {
                    const worksheet = workbook.Sheets[sheetName];
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (!sheetData || sheetData.length < 2) return;
                    
                    for (let i = 1; i < sheetData.length; i++) {
                        const row = sheetData[i];
                        if (!row || row.length === 0) continue;
                        
                        const companyName = row[0] != null ? String(row[0]).trim() : '';
                        
                        // 除外キーワードをチェック
                        const shouldExclude = excludeKeywords.some(keyword => 
                            companyName.includes(keyword)
                        );
                        
                        if (shouldExclude) continue;
                        if (!companyName) continue;
                        if (/^\d+$/.test(companyName)) continue; // 数字のみは除外
                        
                        companiesSet.add(companyName);
                    }
                } catch (error) {
                    console.error(`${sheetName}シートの会社抽出エラー:`, error);
                }
            });
            
            // Gworkerを最初に、その後はアルファベット順・あいうえお順でソート
            allCompanies = Array.from(companiesSet).sort((a, b) => {
                if (a === 'Gworker') return -1;
                if (b === 'Gworker') return 1;
                return a.localeCompare(b, 'ja');
            });
            
            console.log('抽出された全会社リスト:', allCompanies);
        }

        function handleSheetChange(event) {
            const selectedSheet = event.target.value;
            if (!selectedSheet || !workbook) {
                document.getElementById('generateBtn').disabled = true;
                return;
            }

            isNightShift = selectedSheet === '夜勤';

            try {
                const worksheet = workbook.Sheets[selectedSheet];
                workbookData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                analyzeDateColumns();
                extractPlanValue();
                extractFcstValue();
                extractBaseUPH();
                
                document.getElementById('generateBtn').disabled = false;
                const uphStatus = isUPHAutoExtracted ? '（自動抽出）' : '（デフォルト）';
                showStatus(`「${selectedSheet}」シートが選択されました（基準UPH: ${baseUPH} ${uphStatus}）`, 'success');
            } catch (error) {
                showStatus('シートの読み込みに失敗しました: ' + error.message, 'error');
                document.getElementById('generateBtn').disabled = true;
            }
        }

        function analyzeDateColumns() {
            if (!workbookData || workbookData.length < 2) return;
            
            const headerRow = workbookData[0];
            dateColumns = [];
            
            headerRow.forEach((cell, index) => {
                if (typeof cell === 'number' && cell >= 45000) {
                    const excelDate = new Date((cell - 25569) * 86400 * 1000);
                    dateColumns.push({
                        index: index,
                        excelValue: cell,
                        date: excelDate
                    });
                }
            });
            
            console.log(`${dateColumns.length}個の日付列が見つかりました`);
        }

        function extractPlanValue() {
            if (!workbookData || workbookData.length < 2) return;
            
            const targetDateStr = document.getElementById('targetDate').value;
            if (!targetDateStr) return;
            
            const targetDate = new Date(targetDateStr);
            let targetColumnIndex = -1;
            let minDiff = Infinity;
            
            dateColumns.forEach(col => {
                const diff = Math.abs(col.date.getTime() - targetDate.getTime());
                if (diff < minDiff) {
                    minDiff = diff;
                    targetColumnIndex = col.index;
                }
            });
            
            if (targetColumnIndex === -1) return;
            
            for (let i = 0; i < workbookData.length; i++) {
                const row = workbookData[i];
                if (row && row[4] != null) {
                    const cellValue = String(row[4]).toUpperCase();
                    if (cellValue.includes('PLAN')) {
                        const planRow = workbookData[i];
                        const planCell = planRow[targetColumnIndex];
                        
                        if (typeof planCell === 'number' && planCell > 0 && planCell < 1000000) {
                            planValue = planCell;
                            return;
                        }
                        
                        if (planCell != null) {
                            const numMatch = String(planCell).match(/(\d+)/);
                            if (numMatch) {
                                const extractedNum = parseInt(numMatch[1]);
                                if (extractedNum > 0 && extractedNum < 1000000) {
                                    planValue = extractedNum;
                                    return;
                                }
                            }
                        }
                        break;
                    }
                }
            }
        }

        function extractFcstValue() {
            if (!workbookData || workbookData.length < 2) return;
            
            const targetDateStr = document.getElementById('targetDate').value;
            if (!targetDateStr) return;
            
            const targetDate = new Date(targetDateStr);
            let targetColumnIndex = -1;
            let minDiff = Infinity;
            
            dateColumns.forEach(col => {
                const diff = Math.abs(col.date.getTime() - targetDate.getTime());
                if (diff < minDiff) {
                    minDiff = diff;
                    targetColumnIndex = col.index;
                }
            });
            
            if (targetColumnIndex === -1) return;
            
            for (let i = 0; i < workbookData.length; i++) {
                const row = workbookData[i];
                if (row && row[4] != null) {
                    const cellValue = String(row[4]).toUpperCase();
                    if (cellValue.includes('FCST')) {
                        const fcstRow = workbookData[i];
                        const fcstCell = fcstRow[targetColumnIndex];
                        
                        if (typeof fcstCell === 'number' && fcstCell > 0 && fcstCell < 1000000) {
                            fcstValue = fcstCell;
                            return;
                        }
                        
                        if (fcstCell != null) {
                            const numMatch = String(fcstCell).match(/(\d+)/);
                            if (numMatch) {
                                const extractedNum = parseInt(numMatch[1]);
                                if (extractedNum > 0 && extractedNum < 1000000) {
                                    fcstValue = extractedNum;
                                    return;
                                }
                            }
                        }
                        break;
                    }
                }
            }
        }

        function extractBaseUPH() {
            if (!workbookData || workbookData.length < 2) return;
            
            const targetDateStr = document.getElementById('targetDate').value;
            if (!targetDateStr) return;
            
            const targetDate = new Date(targetDateStr);
            let targetColumnIndex = -1;
            let minDiff = Infinity;
            
            dateColumns.forEach(col => {
                const diff = Math.abs(col.date.getTime() - targetDate.getTime());
                if (diff < minDiff) {
                    minDiff = diff;
                    targetColumnIndex = col.index;
                }
            });
            
            if (targetColumnIndex === -1) return;
            
            const uphPatterns = ['基準UPH', 'UPH', '基準', 'BASE UPH', 'BASEUPH', '標準UPH'];
            
            for (let i = 0; i < workbookData.length; i++) {
                const row = workbookData[i];
                if (!row) continue;
                
                for (let j = 0; j < Math.min(row.length, 10); j++) {
                    if (row[j] != null) {
                        const cellValue = String(row[j]).toUpperCase().replace(/\s/g, '');
                        
                        const isUPHRow = uphPatterns.some(pattern => 
                            cellValue.includes(pattern.toUpperCase().replace(/\s/g, ''))
                        );
                        
                        if (isUPHRow) {
                            const uphCell = row[targetColumnIndex];
                            
                            if (typeof uphCell === 'number' && uphCell > 0 && uphCell < 1000) {
                                baseUPH = uphCell;
                                isUPHAutoExtracted = true;
                                console.log(`基準UPH ${baseUPH} を自動取得しました（行${i+1}, 列${targetColumnIndex+1}）`);
                                return;
                            }
                            
                            if (uphCell != null) {
                                const numMatch = String(uphCell).match(/(\d+\.?\d*)/);
                                if (numMatch) {
                                    const extractedNum = parseFloat(numMatch[1]);
                                    if (extractedNum > 0 && extractedNum < 1000) {
                                        baseUPH = extractedNum;
                                        isUPHAutoExtracted = true;
                                        console.log(`基準UPH ${baseUPH} を自動取得しました（文字列から解析）`);
                                        return;
                                    }
                                }
                            }
                            break;
                        }
                    }
                }
            }
            
            isUPHAutoExtracted = false;
            console.log(`基準UPHが見つかりませんでした。デフォルト値 ${baseUPH} を使用します。`);
        }

        function generateDailyShift() {
            if (!workbookData || dateColumns.length === 0) {
                showStatus('データが読み込まれていません', 'error');
                return;
            }

            const targetDateStr = document.getElementById('targetDate').value;
            if (!targetDateStr) {
                showStatus('日付を選択してください', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const generateText = document.getElementById('generateText');
            
            generateBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            generateText.textContent = '生成中...';

            setTimeout(() => {
                try {
                    const targetDate = new Date(targetDateStr);
                    
                    let targetColumnIndex = -1;
                    let minDiff = Infinity;
                    
                    dateColumns.forEach(col => {
                        const diff = Math.abs(col.date.getTime() - targetDate.getTime());
                        if (diff < minDiff) {
                            minDiff = diff;
                            targetColumnIndex = col.index;
                        }
                    });

                    if (targetColumnIndex === -1) {
                        throw new Error('指定された日付に対応する列が見つかりません');
                    }

                    const shiftData = [];
                    let workingCount = 0;
                    let excludedCompanyCount = 0;
                    
                    const excludeKeywords = [
                        'PLAN', 'FCST', 'UPH', 'HC', 'LH', 
                        '出勤HC', '出勤LH', '必要LH', '過不足', 'HC換算',
                        '夜勤手当', '残業手当', '総費用', '平均単価',
                        '実績UPH', '基準UPH', 'FCST数量', 'PLAN数量'
                    ];
                    
                    for (let i = 1; i < workbookData.length; i++) {
                        const row = workbookData[i];
                        if (!row || row.length === 0) continue;
                        
                        const employeeData = {
                            company: row[0] != null ? String(row[0]) : '',
                            timeSlot: row[1] != null ? String(row[1]) : '',
                            mainJob: row[2] != null ? String(row[2]) : '',
                            name: row[3] != null ? String(row[3]) : '',
                            gender: row[4] != null ? String(row[4]) : '',
                            hourlyWage: row[5] != null ? String(row[5]) : '',
                            transportation: row[6] != null ? String(row[6]) : '',
                            startTime: row[7] != null ? String(row[7]) : '',
                            endTime: row[8] != null ? String(row[8]) : '',
                            break: row[9] != null ? String(row[9]) : '',
                            status: row[targetColumnIndex] != null ? String(row[targetColumnIndex]) : ''
                        };
                        
                        const shouldExclude = excludeKeywords.some(keyword => {
                            return employeeData.company.includes(keyword) ||
                                   employeeData.timeSlot.includes(keyword) ||
                                   employeeData.mainJob.includes(keyword) ||
                                   employeeData.name.includes(keyword) ||
                                   employeeData.gender.includes(keyword);
                        });
                        
                        if (shouldExclude) continue;
                        
                        if (!employeeData.company.trim()) {
                            excludedCompanyCount++;
                            continue;
                        }
                        
                        if (!employeeData.name.trim() && !employeeData.company.trim()) continue;
                        if (employeeData.name.trim() && /^\d+$/.test(employeeData.name.trim())) continue;
                        
                        if (employeeData.status === '◯') {
                            employeeData.isWorking = true;
                            workingCount++;
                        } else if (employeeData.status && employeeData.status !== '') {
                            employeeData.isWorking = false;
                        } else {
                            continue;
                        }
                        
                        shiftData.push(employeeData);
                    }

                    originalShiftData = JSON.parse(JSON.stringify(shiftData));

                    extractPlanValue();
                    extractFcstValue();
                    extractBaseUPH();

                    displayResults(shiftData, targetDate, workingCount);
                    
                    generateBtn.disabled = false;
                    loadingSpinner.style.display = 'none';
                    generateText.textContent = '🚀 シフト表を生成';
                    
                    const uphStatus = isUPHAutoExtracted ? '（自動抽出）' : '（デフォルト）';
                    const excludeMessage = excludedCompanyCount > 0 ? ` | ${excludedCompanyCount}行除外` : '';
                    showStatus(`${targetDate.toLocaleDateString('ja-JP')}のシフト表を生成しました（基準UPH: ${baseUPH} ${uphStatus}）${excludeMessage}`, 'success');
                    
                    console.log(`シフト表生成完了:`, {
                        総行数: workbookData.length - 1,
                        有効行数: shiftData.length,
                        出勤者数: workingCount,
                        会社名空白除外: excludedCompanyCount
                    });
                    
                } catch (error) {
                    console.error('シフト表生成エラー詳細:', error);
                    
                    generateBtn.disabled = false;
                    loadingSpinner.style.display = 'none';
                    generateText.textContent = '🚀 シフト表を生成';
                    showStatus('シフト表の生成に失敗しました: ' + error.message, 'error');
                }
            }, 500);
        }

        function displayResults(data, date, workingCount) {
            document.getElementById('resultsContainer').style.display = 'block';
            updateCalculations(data);
            updateTable(data);
            document.getElementById('resultsContainer').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        function updateCalculations(data) {
            const calcGrid = document.getElementById('calcGrid');
            
            let totalLH = 0;
            let totalCost = 0;
            let totalNightAllowance = 0;
            let totalOvertimeAllowance = 0;
            let workingCount = 0;
            
            data.forEach(emp => {
                if (emp.isWorking) {
                    workingCount++;
                    
                    const startTime = parseTime(emp.startTime);
                    const endTime = parseTime(emp.endTime);
                    const breakTime = parseTime(emp.break);
                    
                    const hourlyWageStr = emp.hourlyWage != null ? String(emp.hourlyWage) : '0';
                    const transportationStr = emp.transportation != null ? String(emp.transportation) : '0';
                    
                    const hourlyWage = parseFloat(hourlyWageStr.replace(/[^\d.]/g, '')) || 0;
                    const transportation = parseFloat(transportationStr.replace(/[^\d.]/g, '')) || 0;
                    
                    if (startTime !== null && endTime !== null) {
                        const workHours = calculateWorkHours(startTime, endTime, breakTime);
                        const nightHours = calculateNightShiftHours(startTime, endTime, breakTime);
                        const overtimeHours = Math.max(0, workHours - 8);
                        
                        totalLH += workHours;
                        
                        const regularHours = Math.max(0, workHours - overtimeHours);
                        const baseCost = regularHours * hourlyWage;
                        const overtimeBaseCost = overtimeHours * hourlyWage;
                        const nightAllowance = nightHours * hourlyWage * 0.25;
                        totalNightAllowance += nightAllowance;
                        const overtimeAllowance = overtimeHours * hourlyWage * 0.25;
                        totalOvertimeAllowance += overtimeAllowance;
                        
                        totalCost += baseCost + overtimeBaseCost + nightAllowance + overtimeAllowance + transportation;
                    } else {
                        totalCost += transportation;
                    }
                }
            });
            
            const requiredLH = planValue / baseUPH;
            const shortage = totalLH - requiredLH;
            const currentUPH = totalLH > 0 ? planValue / totalLH : 0;
            const averageHourlyCost = totalLH > 0 ? totalCost / totalLH : 0;
            
            const uphIndicator = isUPHAutoExtracted ? 
                '<span class="uph-auto-indicator">自動</span>' : 
                '<span class="uph-manual-indicator">手動</span>';
            
            calcGrid.innerHTML = `
                <div class="calc-card">
                    <div class="calc-label">FCST数量</div>
                    <div class="calc-value">${fcstValue.toLocaleString()}</div>
                    <div class="calc-unit">個</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">出勤HC</div>
                    <div class="calc-value">${workingCount}</div>
                    <div class="calc-unit">人</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">出勤LH</div>
                    <div class="calc-value">${totalLH.toFixed(1)}</div>
                    <div class="calc-unit">時間</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">平均単価</div>
                    <div class="calc-value">¥${Math.round(averageHourlyCost).toLocaleString()}</div>
                    <div class="calc-unit">円/時</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">PLAN数量</div>
                    <input type="number" class="calc-input" value="${planValue}" onchange="updatePlan(this.value)">
                    <div class="calc-unit">個</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">基準UPH ${uphIndicator}</div>
                    <input type="number" class="calc-input" value="${baseUPH}" onchange="updateUPH(this.value)" step="0.1">
                    <div class="calc-unit">個/時 📊</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">必要LH</div>
                    <div class="calc-value">${requiredLH.toFixed(1)}</div>
                    <div class="calc-unit">時間</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">実績UPH</div>
                    <div class="calc-value" style="color: ${currentUPH >= baseUPH ? 'var(--secondary-color)' : '#f44336'}">${Math.round(currentUPH)}</div>
                    <div class="calc-unit">個/時</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">過不足</div>
                    <div class="calc-value" style="color: ${shortage >= 0 ? 'var(--secondary-color)' : '#f44336'}">${shortage.toFixed(1)}</div>
                    <div class="calc-unit">時間</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">夜勤手当</div>
                    <div class="calc-value">¥${Math.round(totalNightAllowance).toLocaleString()}</div>
                    <div class="calc-unit">円 (22-5時)</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">残業手当</div>
                    <div class="calc-value">¥${Math.round(totalOvertimeAllowance).toLocaleString()}</div>
                    <div class="calc-unit">円 (8h超)</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">総費用</div>
                    <div class="calc-value">¥${Math.round(totalCost).toLocaleString()}</div>
                    <div class="calc-unit">円 (手当込)</div>
                </div>
            `;
        }

        function updateTable(data) {
            const table = document.getElementById('shiftTable');
            
            const headers = ['会社名', '時間帯', 'メイン業務', '氏名', '性別', '時給', '交通費', '開始時間', '終了時間', '休憩', '勤務状況', '勤務LH', '夜勤H', '残業H', '操作'];
            
            let tableHTML = '<thead><tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            data.forEach((emp, index) => {
                const startTime = parseTime(emp.startTime);
                const endTime = parseTime(emp.endTime);
                const breakTime = parseTime(emp.break);
                
                const workHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateWorkHours(startTime, endTime, breakTime) : 0;
                const nightHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateNightShiftHours(startTime, endTime, breakTime) : 0;
                const overtimeHours = emp.isWorking ? Math.max(0, workHours - 8) : 0;
                
                const statusOptions = ['◯', '欠勤', '有休'];
                let statusSelect = '<select class="status-select" data-row-index="' + index + '" data-field="status">';
                statusOptions.forEach(option => {
                    const selected = emp.status === option ? ' selected' : '';
                    statusSelect += `<option value="${option}"${selected}>${option}</option>`;
                });
                statusSelect += '</select>';
                
                tableHTML += `
                    <tr class="${emp.isWorking ? 'working' : ''}" data-row-index="${index}">
                        <td class="editable-cell" contenteditable="true" data-field="company">${emp.company}</td>
                        <td class="editable-cell" contenteditable="true" data-field="timeSlot">${emp.timeSlot}</td>
                        <td class="editable-cell" contenteditable="true" data-field="mainJob">${emp.mainJob}</td>
                        <td class="editable-cell" contenteditable="true" data-field="name">${emp.name}</td>
                        <td class="editable-cell" contenteditable="true" data-field="gender">${emp.gender}</td>
                        <td class="editable-cell" contenteditable="true" data-field="hourlyWage">${emp.hourlyWage}</td>
                        <td class="editable-cell" contenteditable="true" data-field="transportation">${emp.transportation}</td>
                        <td class="editable-cell time-cell" contenteditable="true" data-field="startTime">${emp.startTime}</td>
                        <td class="editable-cell time-cell" contenteditable="true" data-field="endTime">${emp.endTime}</td>
                        <td class="editable-cell time-cell" contenteditable="true" data-field="break">${emp.break}</td>
                        <td class="status-cell">${statusSelect}</td>
                        <td>${workHours > 0 ? workHours.toFixed(2) : ''}</td>
                        <td>${nightHours > 0 ? nightHours.toFixed(2) : ''}</td>
                        <td>${overtimeHours > 0 ? overtimeHours.toFixed(2) : ''}</td>
                        <td class="action-cell">
                            <button class="row-reset-btn" onclick="resetRow(${index})" title="この行をリセット">↺</button>
                            <button class="row-confirm-btn" onclick="confirmRow(${index})" title="この行を確定">✓</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
            
            addEditListeners();
        }

        function addEditListeners() {
            const editableCells = document.querySelectorAll('.editable-cell');
            const statusSelects = document.querySelectorAll('.status-select');
            
            editableCells.forEach(cell => {
                cell.addEventListener('blur', function() {
                    const field = this.getAttribute('data-field');
                    const newValue = this.textContent.trim();
                    
                    if (['hourlyWage', 'transportation'].includes(field)) {
                        const numValue = parseFloat(newValue.replace(/[^\d.]/g, ''));
                        if (!isNaN(numValue) && numValue >= 0) {
                            if (field === 'hourlyWage') {
                                this.textContent = Math.round(numValue).toString();
                            } else if (field === 'transportation') {
                                this.textContent = Math.round(numValue).toString();
                            }
                        } else if (newValue === '') {
                            this.textContent = '';
                        } else {
                            showStatus('数値を入力してください', 'error');
                            return;
                        }
                    }
                    
                    if (['startTime', 'endTime', 'break', 'hourlyWage', 'transportation'].includes(field)) {
                        updateRowCalculations();
                    }
                    
                    this.style.background = 'rgba(76, 175, 80, 0.2)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 1000);
                    
                    showStatus('変更が保存されました', 'success');
                });
                
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                    
                    const field = this.getAttribute('data-field');
                    if (['hourlyWage', 'transportation'].includes(field)) {
                        const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
                        if (!allowedKeys.includes(e.key) && !e.ctrlKey && !e.metaKey) {
                            if (!/[0-9.]/.test(e.key)) {
                                e.preventDefault();
                                return false;
                            }
                            if (e.key === '.' && this.textContent.includes('.')) {
                                e.preventDefault();
                                return false;
                            }
                        }
                    }
                });
                
                cell.addEventListener('focus', function() {
                    const field = this.getAttribute('data-field');
                    if (['hourlyWage', 'transportation'].includes(field)) {
                        const range = document.createRange();
                        range.selectNodeContents(this);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });
            });
            
            statusSelects.forEach(select => {
                select.addEventListener('change', function() {
                    const newStatus = this.value;
                    const row = this.closest('tr');
                    
                    if (['欠勤', '有休'].includes(newStatus)) {
                        const startTimeCell = row.querySelector('[data-field="startTime"]');
                        const endTimeCell = row.querySelector('[data-field="endTime"]');
                        const breakCell = row.querySelector('[data-field="break"]');
                        
                        if (startTimeCell) startTimeCell.textContent = '';
                        if (endTimeCell) endTimeCell.textContent = '';
                        if (breakCell) breakCell.textContent = '';
                        
                        row.classList.remove('working');
                        showStatus(`${newStatus}に設定し、時間をクリアしました`, 'success');
                    } else if (newStatus === '◯') {
                        row.classList.add('working');
                        
                        const startTimeCell = row.querySelector('[data-field="startTime"]');
                        const endTimeCell = row.querySelector('[data-field="endTime"]');
                        const breakCell = row.querySelector('[data-field="break"]');
                        
                        if (startTimeCell && !startTimeCell.textContent.trim()) {
                            startTimeCell.textContent = isNightShift ? '22:00' : '8:00';
                        }
                        if (endTimeCell && !endTimeCell.textContent.trim()) {
                            endTimeCell.textContent = isNightShift ? '7:00' : '17:00';
                        }
                        if (breakCell && !breakCell.textContent.trim()) {
                            breakCell.textContent = '1:00';
                        }
                        
                        showStatus('出勤に設定しました', 'success');
                    } else {
                        row.classList.remove('working');
                    }
                    
                    updateRowCalculations();
                    
                    this.style.background = 'rgba(76, 175, 80, 0.2)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 1000);
                });
            });
        }

        function addNewRow() {
            const newEmployee = {
                company: '',
                timeSlot: '',
                mainJob: '',
                name: '',
                gender: '',
                hourlyWage: '',
                transportation: '',
                startTime: '',
                endTime: '',
                break: '',
                status: '',
                isWorking: false
            };
            
            const table = document.getElementById('shiftTable');
            const tbody = table.querySelector('tbody');
            const currentRows = tbody.querySelectorAll('tr');
            const newIndex = currentRows.length;
            
            const statusOptions = ['◯', '欠勤', '有休'];
            let statusSelect = '<select class="status-select" data-row-index="' + newIndex + '" data-field="status">';
            statusSelect += '<option value="">選択してください</option>';
            statusOptions.forEach(option => {
                statusSelect += `<option value="${option}">${option}</option>`;
            });
            statusSelect += '</select>';
            
            const newRowHTML = `
                <tr class="" data-row-index="${newIndex}">
                    <td class="editable-cell" contenteditable="true" data-field="company">${newEmployee.company}</td>
                    <td class="editable-cell" contenteditable="true" data-field="timeSlot">${newEmployee.timeSlot}</td>
                    <td class="editable-cell" contenteditable="true" data-field="mainJob">${newEmployee.mainJob}</td>
                    <td class="editable-cell" contenteditable="true" data-field="name">${newEmployee.name}</td>
                    <td class="editable-cell" contenteditable="true" data-field="gender">${newEmployee.gender}</td>
                    <td class="editable-cell" contenteditable="true" data-field="hourlyWage">${newEmployee.hourlyWage}</td>
                    <td class="editable-cell" contenteditable="true" data-field="transportation">${newEmployee.transportation}</td>
                    <td class="editable-cell time-cell" contenteditable="true" data-field="startTime">${newEmployee.startTime}</td>
                    <td class="editable-cell time-cell" contenteditable="true" data-field="endTime">${newEmployee.endTime}</td>
                    <td class="editable-cell time-cell" contenteditable="true" data-field="break">${newEmployee.break}</td>
                    <td class="status-cell">${statusSelect}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="action-cell">
                        <button class="row-reset-btn" onclick="resetRow(${newIndex})" title="この行をリセット">↺</button>
                        <button class="row-confirm-btn" onclick="confirmRow(${newIndex})" title="この行を確定">✓</button>
                    </td>
                </tr>
            `;
            
            tbody.insertAdjacentHTML('beforeend', newRowHTML);
            addEditListeners();
            
            const newRow = tbody.querySelector(`tr[data-row-index="${newIndex}"]`);
            const firstEditableCell = newRow.querySelector('.editable-cell');
            if (firstEditableCell) {
                firstEditableCell.focus();
            }
            
            showStatus('新しい行を追加しました', 'success');
        }

        function confirmRow(rowIndex) {
            const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (!row) {
                showStatus('確定する行が見つかりません', 'error');
                return;
            }
            
            const nameCell = row.querySelector('[data-field="name"]');
            const employeeName = nameCell ? nameCell.textContent.trim() : '';
            
            if (row.classList.contains('confirmed')) {
                row.classList.remove('confirmed');
                
                const confirmBtn = row.querySelector('.row-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = '✓';
                    confirmBtn.title = 'この行を確定';
                    confirmBtn.style.background = '';
                }
                
                const name = employeeName || '行';
                showStatus(`${name}の確定を解除しました`, 'success');
            } else {
                if (!employeeName.trim()) {
                    showStatus('氏名は必須項目です', 'error');
                    return;
                }
                
                row.classList.add('confirmed');
                
                const confirmBtn = row.querySelector('.row-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = '✓';
                    confirmBtn.title = '確定済み（クリックで解除）';
                }
                
                const name = employeeName || '行';
                showStatus(`${name}を確定しました`, 'success');
                
                row.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    row.style.transform = '';
                }, 200);
            }
        }

        function getCurrentTableData() {
            const rows = document.querySelectorAll('#shiftTable tbody tr');
            const data = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const statusSelect = row.querySelector('.status-select');
                const status = statusSelect ? statusSelect.value : '';
                
                const getData = (index) => {
                    return cells[index] ? cells[index].textContent.trim() : '';
                };
                
                data.push({
                    company: getData(0),
                    timeSlot: getData(1),
                    mainJob: getData(2),
                    name: getData(3),
                    gender: getData(4),
                    hourlyWage: getData(5),
                    transportation: getData(6),
                    startTime: getData(7),
                    endTime: getData(8),
                    break: getData(9),
                    status: status,
                    isWorking: status === '◯'
                });
            });
            
            return data;
        }

        function updateRowCalculations() {
            const currentData = getCurrentTableData();
            updateCalculations(currentData);
            
            const rows = document.querySelectorAll('#shiftTable tbody tr');
            rows.forEach((row, index) => {
                const emp = currentData[index];
                if (!emp) return;
                
                const startTime = parseTime(emp.startTime);
                const endTime = parseTime(emp.endTime);
                const breakTime = parseTime(emp.break);
                
                const workHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateWorkHours(startTime, endTime, breakTime) : 0;
                const nightHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateNightShiftHours(startTime, endTime, breakTime) : 0;
                const overtimeHours = emp.isWorking ? Math.max(0, workHours - 8) : 0;
                
                const cells = row.querySelectorAll('td');
                if (cells[11]) cells[11].textContent = workHours > 0 ? workHours.toFixed(2) : '';
                if (cells[12]) cells[12].textContent = nightHours > 0 ? nightHours.toFixed(2) : '';
                if (cells[13]) cells[13].textContent = overtimeHours > 0 ? overtimeHours.toFixed(2) : '';
            });
        }

        function resetRow(rowIndex) {
            if (!originalShiftData || !originalShiftData[rowIndex]) {
                const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
                if (!row) return;
                
                if (!confirm('この行をクリアしますか？')) {
                    return;
                }
                
                const editableCells = row.querySelectorAll('.editable-cell');
                editableCells.forEach(cell => {
                    cell.textContent = '';
                });
                
                const statusSelect = row.querySelector('.status-select');
                if (statusSelect) statusSelect.value = '';
                
                row.classList.remove('working', 'confirmed');
                
                const confirmBtn = row.querySelector('.row-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = '✓';
                    confirmBtn.title = 'この行を確定';
                    confirmBtn.style.background = '';
                }
                
                updateRowCalculations();
                showStatus('行をクリアしました', 'success');
                return;
            }
            
            if (!confirm('この行を元の状態に戻しますか？')) {
                return;
            }
            
            const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (!row) return;
            
            const originalData = originalShiftData[rowIndex];
            
            const companyCell = row.querySelector('[data-field="company"]');
            if (companyCell) companyCell.textContent = originalData.company;
            
            const timeSlotCell = row.querySelector('[data-field="timeSlot"]');
            if (timeSlotCell) timeSlotCell.textContent = originalData.timeSlot;
            
            const mainJobCell = row.querySelector('[data-field="mainJob"]');
            if (mainJobCell) mainJobCell.textContent = originalData.mainJob;
            
            const nameCell = row.querySelector('[data-field="name"]');
            if (nameCell) nameCell.textContent = originalData.name;
            
            const genderCell = row.querySelector('[data-field="gender"]');
            if (genderCell) genderCell.textContent = originalData.gender;
            
            const hourlyWageCell = row.querySelector('[data-field="hourlyWage"]');
            if (hourlyWageCell) hourlyWageCell.textContent = originalData.hourlyWage;
            
            const transportationCell = row.querySelector('[data-field="transportation"]');
            if (transportationCell) transportationCell.textContent = originalData.transportation;
            
            const startTimeCell = row.querySelector('[data-field="startTime"]');
            if (startTimeCell) startTimeCell.textContent = originalData.startTime;
            
            const endTimeCell = row.querySelector('[data-field="endTime"]');
            if (endTimeCell) endTimeCell.textContent = originalData.endTime;
            
            const breakCell = row.querySelector('[data-field="break"]');
            if (breakCell) breakCell.textContent = originalData.break;
            
            const statusSelect = row.querySelector('.status-select');
            if (statusSelect) statusSelect.value = originalData.status;
            
            if (originalData.isWorking) {
                row.classList.add('working');
            } else {
                row.classList.remove('working');
            }
            
            row.classList.remove('confirmed');
            
            const confirmBtn = row.querySelector('.row-confirm-btn');
            if (confirmBtn) {
                confirmBtn.innerHTML = '✓';
                confirmBtn.title = 'この行を確定';
                confirmBtn.style.background = '';
            }
            
            updateRowCalculations();
            
            row.style.background = 'rgba(33, 150, 243, 0.1)';
            setTimeout(() => {
                row.style.background = '';
            }, 1500);
            
            showStatus('行をリセットしました', 'success');
        }

        function parseTime(timeStr) {
            if (!timeStr || timeStr === '' || timeStr === '：' || timeStr === '　：　') {
                return null;
            }
            
            if (typeof timeStr === 'number') {
                if (timeStr < 1) {
                    return (timeStr * 24) % 24;
                } else if (timeStr > 40000) {
                    const timePart = timeStr % 1;
                    return (timePart * 24) % 24;
                } else {
                    return timeStr % 24;
                }
            }
            
            const timeString = timeStr.toString().trim();
            
            if (timeString === '' || timeString === '：' || timeString === '　：　') {
                return null;
            }
            
            const cleanTimeStr = timeString.replace(/[：\s]/g, ':');
            
            if (cleanTimeStr.includes(':')) {
                const parts = cleanTimeStr.split(':');
                const hours = parseInt(parts[0]) || 0;
                const minutes = parseInt(parts[1]) || 0;
                return (hours % 24) + minutes / 60;
            } else {
                const numValue = parseFloat(cleanTimeStr) || 0;
                return numValue % 24;
            }
        }

        function calculateWorkHours(startTime, endTime, breakTime) {
            if (startTime === null || endTime === null) {
                return 0;
            }
            
            let workHours;
            
            if (isNightShift) {
                if (endTime < startTime) {
                    workHours = (24 + endTime) - startTime;
                } else {
                    workHours = endTime - startTime;
                }
            } else {
                if (endTime < startTime) {
                    workHours = endTime - startTime + 24;
                } else {
                    workHours = endTime - startTime;
                }
            }
            
            if (breakTime !== null && breakTime > 0) {
                workHours -= breakTime;
            }
            
            return Math.max(0, workHours);
        }

        function calculateNightShiftHours(startTime, endTime, breakTime) {
            if (startTime === null || endTime === null) {
                return 0;
            }
            
            const nightStart = 22.0;
            const nightEnd = 5.0;
            let nightHours = 0;
            
            if (endTime < startTime) {
                if (startTime <= nightStart) {
                    nightHours += (24 - nightStart);
                } else if (startTime < 24) {
                    nightHours += (24 - startTime);
                }
                
                if (endTime >= nightEnd) {
                    nightHours += nightEnd;
                } else if (endTime > 0) {
                    nightHours += endTime;
                }
            } else {
                const shiftStart = Math.max(startTime, nightStart);
                const shiftEnd = Math.min(endTime, 24);
                
                if (shiftStart < shiftEnd) {
                    nightHours += (shiftEnd - shiftStart);
                }
                
                if (startTime < nightEnd) {
                    const earlyStart = Math.max(startTime, 0);
                    const earlyEnd = Math.min(endTime, nightEnd);
                    if (earlyStart < earlyEnd) {
                        nightHours += (earlyEnd - earlyStart);
                    }
                }
            }
            
            if (nightHours > 0 && breakTime !== null && breakTime > 0) {
                const breakAdjustment = Math.min(breakTime, nightHours);
                nightHours = Math.max(0, nightHours - breakAdjustment);
            }
            
            return Math.max(0, nightHours);
        }

        function updatePlan(value) {
            planValue = parseFloat(value) || 12200;
            updateCalculations(getCurrentTableData());
        }

        function updateUPH(value) {
            const newUPH = parseFloat(value) || 22;
            if (newUPH !== baseUPH) {
                baseUPH = newUPH;
                isUPHAutoExtracted = false;
                updateCalculations(getCurrentTableData());
                showStatus(`基準UPHを ${baseUPH} に手動変更しました`, 'success');
            }
        }

        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type} show`;
            
            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 3000);
        }

        function showServerInstructions() {
            const instructions = `
🚀 ローカルWebサーバーの起動方法

【Python（推奨）】
1. ファイルがあるフォルダでコマンドプロンプト/ターミナルを開く
2. 実行: python -m http.server 8000
3. ブラウザで: http://localhost:8000

【Node.js】
1. 実行: npx http-server
2. ブラウザで: http://localhost:8080

【VS Code】
1. Live Server拡張機能をインストール
2. HTMLファイルを右クリック → "Open with Live Server"

【PHP】
1. 実行: php -S localhost:8000
2. ブラウザで: http://localhost:8000

サーバー起動後、http://localhost:8000/test.html にアクセスしてください。
`;
            
            alert(instructions);
        }

        function generateAttendanceCheck() {
            if (!document.querySelector('.shift-table')) {
                showStatus('シフト表が生成されていません', 'error');
                return;
            }

            try {
                const targetDate = document.getElementById('targetDate').value;
                const selectedSheet = document.getElementById('sheetSelect').value;
                const dateObj = new Date(targetDate);
                const formattedDate = `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月${dateObj.getDate()}日 ${selectedSheet}シフト表`;

                const attendanceData = [];
                const rows = document.querySelectorAll('#shiftTable tbody tr');
                
                rows.forEach(row => {
                    const statusSelect = row.querySelector('.status-select');
                    const status = statusSelect ? statusSelect.value : '';
                    
                    if (status === '◯') {
                        const cells = row.querySelectorAll('td');
                        const getData = (index) => cells[index] ? cells[index].textContent.trim() : '';
                        
                        const companyName = getData(0);
                        if (!companyName.trim()) return;
                        
                        attendanceData.push({
                            company: companyName,
                            timeSlot: '',
                            mainJob: getData(2),
                            name: getData(3),
                            startTime: ':',
                            endTime: ':',
                            break: ':',
                            healthCheck: '',
                            heatstrokeCheck: '',
                            memo: ''
                        });
                    }
                });

                const calculationData = {
                    totalHC: attendanceData.length,
                    totalLH: parseFloat(document.querySelector('.calc-value')?.textContent) || 0,
                    forecast: fcstValue,
                    planValue: planValue,
                    baseUPH: baseUPH
                };

                const attendanceHTML = createAttendanceHTML(formattedDate, attendanceData, calculationData);
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(attendanceHTML);
                printWindow.document.close();
                
                showStatus('出退勤確認表を生成しました', 'success');
                
            } catch (error) {
                console.error('出退勤確認表生成エラー:', error);
                showStatus('出退勤確認表の生成に失敗しました: ' + error.message, 'error');
            }
        }

        function createAttendanceHTML(dateTitle, data, calculationData) {
            return `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出退勤確認表</title>
    <style>
        @media print { body { margin: 0; } .no-print { display: none; } }
        body { font-family: 'Yu Gothic', 'Meiryo', sans-serif; margin: 15px; background-color: white; font-size: 12px; line-height: 1.2; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .header h1 { margin: 0; font-size: 20px; font-weight: bold; line-height: 1.3; }
        .attendance-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; line-height: 1.1; }
        .attendance-table th, .attendance-table td { border: 1px solid #333; padding: 4px 6px; text-align: center; vertical-align: middle; line-height: 1.1; }
        .attendance-table th { background-color: #f0f0f0; font-weight: bold; font-size: 11px; padding: 5px 6px; }
        .attendance-table td { height: 20px; padding: 3px 6px; }
        .name-cell { text-align: left; padding-left: 8px; min-width: 100px; }
        .company-cell { text-align: left; padding-left: 8px; min-width: 70px; }
        .job-cell { text-align: left; padding-left: 8px; min-width: 85px; }
        .time-cell { width: 55px; font-size: 14px; font-weight: bold; padding: 3px 4px; }
        .memo-cell { width: 100px; padding: 3px 4px; }
        .layer-cell { width: 45px; padding: 3px 4px; }
        .health-cell { width: 60px; padding: 3px 4px; font-size: 10px; }
        .heatstroke-cell { width: 65px; padding: 3px 4px; font-size: 10px; }
        .print-buttons { margin: 15px 0; text-align: center; }
        .print-btn { background-color: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 0 8px; }
        .print-btn:hover { background-color: #45a049; }
        .pdf-btn { background-color: #2196F3; } .pdf-btn:hover { background-color: #1976D2; }
    </style>
</head>
<body>
    <div class="print-buttons no-print">
        <button class="print-btn" onclick="window.print()">🖨️ 印刷</button>
        <button class="print-btn pdf-btn" onclick="window.print()">📄 PDF保存</button>
        <button class="print-btn" onclick="window.close()" style="background-color: #FF5722;">❌ 閉じる</button>
    </div>
    <div class="header">
        <h1>${dateTitle}</h1>
        <p style="margin: 8px 0 0 0; font-size: 13px;">出退勤確認表（基準UPH: ${calculationData.baseUPH}）</p>
    </div>
    <table class="attendance-table">
        <thead>
            <tr><th>会社名</th><th>階層</th><th>メイン業務</th><th>氏名</th><th>開始時間</th><th>終了時間</th><th>休憩</th><th>自己申告<br>体調</th><th>熱中症<br>対策確認</th><th>備考</th></tr>
        </thead>
        <tbody>
            ${data.map(emp => `<tr><td class="company-cell">${emp.company}</td><td class="layer-cell">${emp.timeSlot}</td><td class="job-cell">${emp.mainJob}</td><td class="name-cell">${emp.name}</td><td class="time-cell">${emp.startTime}</td><td class="time-cell">${emp.endTime}</td><td class="time-cell">${emp.break}</td><td class="health-cell">&nbsp;</td><td class="heatstroke-cell">&nbsp;</td><td class="memo-cell">${emp.memo}</td></tr>`).join('')}
            ${Array.from({length: Math.max(0, 20 - data.length)}, () => `<tr><td class="company-cell">&nbsp;</td><td class="layer-cell">&nbsp;</td><td class="job-cell">&nbsp;</td><td class="name-cell">&nbsp;</td><td class="time-cell">:</td><td class="time-cell">:</td><td class="time-cell">:</td><td class="health-cell">&nbsp;</td><td class="heatstroke-cell">&nbsp;</td><td class="memo-cell">&nbsp;</td></tr>`).join('')}
        </tbody>
    </table>
    <div style="margin-top: 20px; text-align: right; font-size: 11px; line-height: 1.3;"><p>責任者確認：_________________　　日付：_______________</p></div>
</body>
</html>`;
        }

        function sendToViewer() {
            if (!document.querySelector('.shift-table')) {
                showStatus('送信するシフト表データがありません', 'error');
                return;
            }

            try {
                const currentData = getCurrentTableData();
                const targetDate = document.getElementById('targetDate').value;
                const selectedSheet = document.getElementById('sheetSelect').value;
                
                const transferData = {
                    employeeData: currentData.map(emp => ({
                        '会社名': emp.company || '',
                        '時間帯': emp.timeSlot || '',
                        'メイン業務': emp.mainJob || '',
                        '氏名': emp.name || '',
                        '性別': emp.gender || '',
                        '時給': emp.hourlyWage || '',
                        '交通費': emp.transportation || '',
                        '開始時間': emp.startTime || '',
                        '終了時間': emp.endTime || '',
                        '休憩': emp.break || '',
                        '勤務状況': emp.status || '',
                        '勤務LH': calculateDisplayLH(emp),
                        '夜勤時間': calculateDisplayNightHours(emp),
                        '残業時間': calculateDisplayOvertimeHours(emp)
                    })),
                    shiftTitle: `${new Date(targetDate).toLocaleDateString('ja-JP')}日 ${selectedSheet}シフト表`,
                    isNightShift: isNightShift,
                    baseUPH: baseUPH,
                    planValue: planValue,
                    fcstValue: fcstValue,
                    transferTimestamp: Date.now(),
                    protocol: window.location.protocol
                };

                console.log('送信データ:', transferData);

                const isFileProtocol = window.location.protocol === 'file:';
                
                if (isFileProtocol) {
                    localStorage.setItem('shiftDataTransfer', JSON.stringify(transferData));
                    localStorage.setItem('shiftDataTransfer_timestamp', Date.now().toString());
                    console.log('file://プロトコル検出: localStorageに保存しました');
                } else {
                    localStorage.setItem('shiftDataTransfer', JSON.stringify(transferData));
                }

                const windowFeatures = isFileProtocol ? 
                    'width=1200,height=800,scrollbars=yes,resizable=yes,location=yes' :
                    'width=1200,height=800,scrollbars=yes,resizable=yes';
                    
                const viewerWindow = window.open('./viewer.html', '_blank', windowFeatures);
                
                if (!viewerWindow) {
                    showStatus('ポップアップがブロックされました。ブラウザ設定を確認してください', 'error');
                    return;
                }

                let attempts = 0;
                const maxAttempts = isFileProtocol ? 20 : 50;
                const attemptInterval = isFileProtocol ? 1000 : 200;
                
                const sendData = () => {
                    attempts++;
                    
                    try {
                        if (viewerWindow.closed) {
                            console.log('ウィンドウが閉じられました');
                            return;
                        }

                        viewerWindow.postMessage({
                            type: 'SHIFT_DATA_TRANSFER',
                            data: transferData
                        }, '*');
                        
                        console.log(`データ送信試行 ${attempts}回目 (${window.location.protocol})`);
                        
                    } catch (error) {
                        console.error(`送信エラー (試行${attempts}回目):`, error);
                    }
                };

                if (isFileProtocol) {
                    showStatus('ビューアを開きました（localStorageでデータ転送）', 'success');
                    
                    setTimeout(() => {
                        for (let i = 0; i < 5; i++) {
                            setTimeout(sendData, i * 2000);
                        }
                    }, 1000);
                    
                } else {
                    let loadCheckInterval;
                    let isDataSent = false;

                    const checkAndSend = () => {
                        if (isDataSent || viewerWindow.closed) {
                            if (loadCheckInterval) clearInterval(loadCheckInterval);
                            return;
                        }

                        try {
                            if (viewerWindow.document && 
                                (viewerWindow.document.readyState === 'complete' || 
                                 viewerWindow.document.readyState === 'interactive')) {
                                
                                if (loadCheckInterval) clearInterval(loadCheckInterval);
                                isDataSent = true;
                                
                                setTimeout(() => {
                                    sendData();
                                    
                                    const retryInterval = setInterval(() => {
                                        if (attempts >= maxAttempts || viewerWindow.closed) {
                                            clearInterval(retryInterval);
                                            return;
                                        }
                                        sendData();
                                    }, attemptInterval);
                                    
                                    setTimeout(() => {
                                        clearInterval(retryInterval);
                                    }, 10000);
                                    
                                }, 800);
                            }
                        } catch (e) {
                            // クロスオリジンエラーは無視して続行
                        }
                    };

                    loadCheckInterval = setInterval(checkAndSend, 100);
                    setTimeout(checkAndSend, 500);
                    
                    setTimeout(() => {
                        if (!isDataSent && !viewerWindow.closed) {
                            console.log('強制送信を実行');
                            isDataSent = true;
                            if (loadCheckInterval) clearInterval(loadCheckInterval);
                            sendData();
                        }
                    }, 3000);

                    showStatus('ビューアウィンドウを開いています...', 'success');
                }

                const confirmationListener = (event) => {
                    if (event.data && event.data.type === 'DATA_RECEIVED_CONFIRMATION') {
                        showStatus('データ転送が完了しました', 'success');
                        window.removeEventListener('message', confirmationListener);
                        localStorage.removeItem('shiftDataTransfer');
                        localStorage.removeItem('shiftDataTransfer_timestamp');
                    }
                };
                
                window.addEventListener('message', confirmationListener);
                
                setTimeout(() => {
                    window.removeEventListener('message', confirmationListener);
                }, 15000);

            } catch (error) {
                console.error('ビューア転送エラー:', error);
                showStatus('ビューアへの転送に失敗しました: ' + error.message, 'error');
            }
        }

        function calculateDisplayLH(emp) {
            if (!emp.isWorking) return '';
            const startTime = parseTime(emp.startTime);
            const endTime = parseTime(emp.endTime);
            const breakTime = parseTime(emp.break);
            if (startTime === null || endTime === null) return '';
            const workHours = calculateWorkHours(startTime, endTime, breakTime);
            return workHours > 0 ? workHours.toFixed(2) : '';
        }

        function calculateDisplayNightHours(emp) {
            if (!emp.isWorking) return '';
            const startTime = parseTime(emp.startTime);
            const endTime = parseTime(emp.endTime);
            const breakTime = parseTime(emp.break);
            if (startTime === null || endTime === null) return '';
            const nightHours = calculateNightShiftHours(startTime, endTime, breakTime);
            return nightHours > 0 ? nightHours.toFixed(2) : '';
        }

        function calculateDisplayOvertimeHours(emp) {
            if (!emp.isWorking) return '';
            const startTime = parseTime(emp.startTime);
            const endTime = parseTime(emp.endTime);
            const breakTime = parseTime(emp.break);
            if (startTime === null || endTime === null) return '';
            const workHours = calculateWorkHours(startTime, endTime, breakTime);
            const overtimeHours = Math.max(0, workHours - 8);
            return overtimeHours > 0 ? overtimeHours.toFixed(2) : '';
        }
    </script>
</body>
</html>
