<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2196F3">
    <meta name="description" content="ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã‚·ãƒ•ãƒˆç®¡ç†ã‚¢ãƒ—ãƒª - Excelé€£æºãƒ»åŸºæº–UPHè‡ªå‹•æŠ½å‡ºå¯¾å¿œ">
    <title>ã‚·ãƒ•ãƒˆç®¡ç†ãƒ—ãƒ­ v4.1 - å®Œå…¨ç‰ˆï¼ˆåŸºæº–UPHè‡ªå‹•æŠ½å‡ºï¼‰</title>
    
    <!-- PWAç”¨ã®ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiMyMTk2RjMiIHJ4PSI0Ii8+PHBhdGggZD0iTTYgOWgxMnYySDE2em0wIDRoMTJ2MkgxNnptMC00aDEyVjlIMTZ6IiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFJklEQVR4nO3d0W4TMRRF0fH//5TyQKnUqI7tmdzeaxFVtO3c2bPGnknSdd33fQBHffrXCwBnCQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQJgCECQBhAkCYABAmAIQJAGECQJgAECYAhAkAYQJAmAAQ9hdNHBXz0j6qYwAAAABJRU5ErkJggg==">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2196F3;
            --primary-dark: #1976D2;
            --secondary-color: #4CAF50;
            --accent-color: #FF9800;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --glass: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        [data-theme="dark"] {
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --glass: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(51, 65, 85, 0.3);
        }

        .viewer-app-btn {
            background: linear-gradient(45deg, #FF9800, #FFB74D);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 8px;
        }

        .viewer-app-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
            background: linear-gradient(45deg, #F57C00, #FF9800);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Noto Sans JP', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            animation: slideDown 0.6s ease-out;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 2.5rem;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-toggle {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            background: var(--surface);
        }

        .install-btn {
            background: linear-gradient(45deg, var(--accent-color), #FF6F00);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
        }

        .step-container {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            animation: slideUp 0.6s ease-out;
            animation-fill-mode: both;
        }

        .step-container:nth-child(2) { animation-delay: 0.1s; }
        .step-container:nth-child(3) { animation-delay: 0.2s; }
        .step-container:nth-child(4) { animation-delay: 0.3s; }

        .step-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .step-number {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .step-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .step-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-top: 4px;
        }

        .upload-zone {
            border: 3px dashed var(--border);
            border-radius: 16px;
            padding: 48px 24px;
            text-align: center;
            background: var(--surface);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: var(--primary-color);
            background: linear-gradient(45deg, rgba(33, 150, 243, 0.05), rgba(76, 175, 80, 0.05));
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 16px;
            animation: bounce 2s infinite;
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .file-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .progress-container {
            margin-top: 16px;
            display: none;
        }

        .progress-bar {
            background: var(--border);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .file-info {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            display: none;
        }

        .select-section {
            display: none;
        }

        .sheet-select {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 200px;
        }

        .sheet-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .date-controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .generate-btn {
            background: linear-gradient(45deg, var(--secondary-color), #388E3C);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        .results-container {
            display: none;
        }

        .calculation-panel {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .calc-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .calc-card {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(76, 175, 80, 0.1));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .calc-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .calc-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .calc-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .calc-unit {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .calc-input {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            width: 100%;
            max-width: 120px;
            margin: 4px auto;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .table-container {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: auto;
        }

        .table-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .shift-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .shift-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .shift-table th:first-child {
            border-radius: 8px 0 0 8px;
        }

        .shift-table th:last-child {
            border-radius: 0 8px 8px 0;
        }

        .shift-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .shift-table tr:hover {
            background: rgba(33, 150, 243, 0.05);
        }

        .working {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(139, 195, 74, 0.1)) !important;
        }

        .confirmed {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.15), rgba(63, 81, 181, 0.15)) !important;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .confirmed .row-confirm-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        .confirmed .row-confirm-btn:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
        }

        .editable-cell {
            background: rgba(255, 193, 7, 0.1) !important;
            cursor: text;
            border-radius: 4px;
            transition: all 0.2s ease;
            min-width: 60px;
            position: relative;
        }

        .editable-cell:hover {
            background: rgba(255, 193, 7, 0.2) !important;
        }

        .editable-cell:focus {
            background: var(--surface) !important;
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }

        .time-cell {
            min-width: 80px;
            font-family: 'Courier New', monospace;
            text-align: center;
        }

        .status-cell {
            padding: 6px 8px;
        }

        .status-select {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 70px;
        }

        .status-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        .status-select option {
            background: var(--surface);
            color: var(--text-primary);
        }

        .action-cell {
            padding: 6px 8px;
            text-align: center;
            width: 100px;
        }

        .row-reset-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 28px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            margin-right: 4px;
        }

        .row-reset-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .row-reset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .row-reset-btn:hover::before {
            left: 100%;
        }

        .row-reset-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .row-reset-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.5);
        }

        .row-confirm-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 28px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .row-confirm-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .row-confirm-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, #43A047 0%, #2E7D32 100%);
        }

        .row-confirm-btn:hover::before {
            left: 100%;
        }

        .row-confirm-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .row-confirm-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5);
        }

        .add-row-btn {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #43A047 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
            flex-shrink: 0;
        }

        .add-row-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, #43A047 0%, #388E3C 100%);
        }

        .add-row-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            flex: 1;
            justify-content: flex-end;
        }

        .action-btn {
            background: linear-gradient(45deg, var(--accent-color), #F57C00);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.3);
        }

        .action-btn.primary {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
        }

        .action-btn.success {
            background: linear-gradient(45deg, var(--secondary-color), #388E3C);
        }

        .action-btn.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .status-message.show {
            transform: translateX(0);
        }

        .status-message.success {
            background: linear-gradient(45deg, var(--secondary-color), #43A047);
        }

        .status-message.error {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .hidden {
            display: none !important;
        }

        /* åŸºæº–UPHè‡ªå‹•æŠ½å‡ºé–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .uph-auto-indicator {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
            display: inline-block;
        }

        .uph-manual-indicator {
            background: linear-gradient(45deg, #FF9800, #FFC107);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
            display: inline-block;
        }

        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                padding: 12px;
            }

            .header {
                padding: 20px;
                border-radius: 16px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .logo {
                font-size: 2rem;
            }

            .title {
                font-size: 1.5rem;
            }

            .step-container {
                padding: 20px;
                border-radius: 16px;
            }

            .upload-zone {
                padding: 32px 16px;
            }

            .date-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .calc-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .action-buttons {
                justify-content: center;
            }

            .shift-table {
                font-size: 0.8rem;
            }

            .shift-table th,
            .shift-table td {
                padding: 8px 6px;
            }

            .status-select {
                max-width: 60px;
                font-size: 0.8rem;
                padding: 2px 4px;
            }

            .row-reset-btn,
            .row-confirm-btn {
                width: 32px;
                height: 24px;
                font-size: 0.7rem;
                border-radius: 6px;
            }

            .action-cell {
                width: 80px;
            }
        }

        @media (max-width: 480px) {
            .step-header {
                flex-direction: column;
                text-align: center;
            }

            .calc-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .header,
            .table-controls,
            .install-btn,
            .theme-toggle,
            .row-reset-btn,
            .row-confirm-btn {
                display: none;
            }

            .step-container {
                background: white;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">ğŸ“Š</div>
                    <div>
                        <h1 class="title">ã‚·ãƒ•ãƒˆç®¡ç†ãƒ—ãƒ­</h1>
                        <p class="subtitle">Professional Shift Management v4.1 å®Œå…¨ç‰ˆï¼ˆåŸºæº–UPHè‡ªå‹•æŠ½å‡ºï¼‰</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="toggleTheme()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
                        <span id="themeIcon">ğŸŒ™</span>
                    </button>
                    <a href="./fukugen.html" target="_blank" class="viewer-app-btn">
                        ğŸ“Š è©³ç´°ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
                    </a>
                    <a href="./mobile.html" target="_blank" class="viewer-app-btn" style="background: linear-gradient(45deg, #9C27B0, #E91E63);">
                        ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ç‰ˆ
                    </a>                    
                    <button class="install-btn" id="installBtn" onclick="installApp()">
                        ğŸ“± ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                    </button>
                </div>
            </div>
        </header>

        <!-- Step 1: File Upload -->
        <section class="step-container">
            <div class="step-header">
                <div class="step-number">1</div>
                <div>
                    <h2 class="step-title">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                    <p class="step-description">æœˆé–“ã‚·ãƒ•ãƒˆè¡¨ã®Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsx/.xlsï¼‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ<br>
                    ğŸ“ˆ åŸºæº–UPHãŒè‡ªå‹•çš„ã«æ¤œå‡ºã•ã‚Œã€æ—¥ä»˜ã«å¿œã˜ã¦åæ˜ ã•ã‚Œã¾ã™<br>
                    âš ï¸ ä¼šç¤¾åãŒç©ºç™½ã®è¡Œã¯è‡ªå‹•çš„ã«é™¤å¤–ã•ã‚Œã¾ã™</p>
                </div>
            </div>
            
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
                <div class="upload-hint">ã¾ãŸã¯ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                <input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls">
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressText">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            
            <div class="file-info" id="fileInfo">
                <div id="fileName"></div>
            </div>
        </section>

        <!-- Step 2: Sheet Selection -->
        <section class="step-container select-section" id="sheetSection">
            <div class="step-header">
                <div class="step-number">2</div>
                <div>
                    <h2 class="step-title">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ</h2>
                    <p class="step-description">åˆ†æã—ãŸã„å‹¤å‹™ã‚·ãƒ¼ãƒˆï¼ˆæ—¥å‹¤ãƒ»å¤œå‹¤ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„<br>
                    ğŸ¯ é¸æŠã—ãŸã‚·ãƒ¼ãƒˆã‹ã‚‰è‡ªå‹•çš„ã«åŸºæº–UPHãŒæŠ½å‡ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
            
            <select class="sheet-select" id="sheetSelect">
                <option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
        </section>

        <!-- Step 3: Date Selection and Generation -->
        <section class="step-container" id="dateSection">
            <div class="step-header">
                <div class="step-number">3</div>
                <div>
                    <h2 class="step-title">æ—¥ä»˜é¸æŠã¨ã‚·ãƒ•ãƒˆè¡¨ç”Ÿæˆ</h2>
                    <p class="step-description">è¡¨ç¤ºã—ãŸã„æ—¥ä»˜ã‚’é¸æŠã—ã¦ã‚·ãƒ•ãƒˆè¡¨ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„<br>
                    ğŸ“… æ—¥ä»˜å¤‰æ›´æ™‚ã«åŸºæº–UPHãŒè‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™</p>
                </div>
            </div>
            
            <div class="date-controls">
                <label for="targetDate">ğŸ“… å¯¾è±¡æ—¥ä»˜:</label>
                <input type="date" class="date-input" id="targetDate">
                <button class="generate-btn" id="generateBtn" onclick="generateDailyShift()" disabled>
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="generateText">ğŸš€ ã‚·ãƒ•ãƒˆè¡¨ã‚’ç”Ÿæˆ</span>
                </button>
            </div>
        </section>

        <!-- Results Section -->
        <div class="results-container" id="resultsContainer">
            <!-- Calculation Panel -->
            <div class="calculation-panel" id="calculationPanel">
                <div class="calc-header">
                    <div class="step-number">ğŸ“ˆ</div>
                    <div>
                        <h3>LHè¨ˆç®—ãƒ»åˆ†æ</h3>
                        <p class="step-description">åŠ´åƒæ™‚é–“ã¨ç”Ÿç”£æ€§ã®è©³ç´°åˆ†æï¼ˆå¤œå‹¤æ‰‹å½“ãƒ»æ®‹æ¥­ä»£è¾¼ã¿ï¼‰<br>
                        ğŸ”„ åŸºæº–UPHã¯å¾“æ¥­å“¡ãƒªã‚¹ãƒˆã‹ã‚‰è‡ªå‹•æŠ½å‡ºã•ã‚Œã¾ã™</p>
                    </div>
                </div>
                <div class="calc-grid" id="calcGrid"></div>
            </div>

            <!-- Data Table -->
            <div class="table-container" id="tableContainer">
                <div class="table-controls">
                    <button class="add-row-btn" onclick="addNewRow()">
                        â• è¡Œã‚’è¿½åŠ 
                    </button>
                    
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="generateAttendanceCheck()">
                            ğŸ“‹ å‡ºé€€å‹¤ç¢ºèªè¡¨
                        </button>
                        <button class="action-btn" onclick="sendToViewer()">
                            ğŸš€ ãƒ“ãƒ¥ãƒ¼ã‚¢ã§ç·¨é›†
                        </button>
                        <button class="action-btn" onclick="exportToExcel()">
                            ğŸ“Š è©³ç´°ãƒ‡ãƒ¼ã‚¿
                        </button>
                        <button class="action-btn" onclick="exportCompanySummary()">
                            ğŸ“ˆ ä¼šç¤¾åˆ¥é›†è¨ˆ
                        </button>
                        <button class="action-btn success" onclick="exportCombinedSummary()">
                            ğŸ”„ æ—¥å‹¤+å¤œå‹¤åˆç®—
                        </button>
                        <button class="action-btn" onclick="testViewerConnection()" style="background: linear-gradient(45deg, #9E9E9E, #757575);">
                            ğŸ”§ é€ä¿¡ãƒ†ã‚¹ãƒˆ
                        </button>
                        <button class="action-btn danger" onclick="resetData()">
                            ğŸ”„ å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
                        </button>
                    </div>
                </div>
                
                <table class="shift-table" id="shiftTable"></table>
            </div>
        </div>
    </div>

    <!-- Status Message -->
    <div class="status-message" id="statusMessage"></div>

    <script>
        // Global variables
        let workbook = null;
        let workbookData = null;
        let dateColumns = [];
        let originalShiftData = [];
        let planValue = 12200;
        let fcstValue = 16273;
        let baseUPH = 22;
        let isNightShift = false;
        let deferredPrompt = null;
        let isUPHAutoExtracted = false;
        let allCompanies = [];

        // App initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            registerServiceWorker();
            setupPWA();
        });

        function exportToExcel() {
            if (!document.querySelector('.shift-table')) {
                showStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const targetDate = document.getElementById('targetDate').value;
                const selectedSheet = document.getElementById('sheetSelect').value;
                const dateObj = new Date(targetDate);
                const formattedDate = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ ${selectedSheet}ã‚·ãƒ•ãƒˆè¡¨`;

                const data = [];
                data.push([formattedDate]);
                data.push([`åŸºæº–UPH: ${baseUPH} ${isUPHAutoExtracted ? '(è‡ªå‹•æŠ½å‡º)' : '(æ‰‹å‹•è¨­å®š)'}`]);
                data.push([]);

                const headers = ['ä¼šç¤¾å', 'æ™‚é–“å¸¯', 'ãƒ¡ã‚¤ãƒ³æ¥­å‹™', 'æ°å', 'æ€§åˆ¥', 'æ™‚çµ¦', 'äº¤é€šè²»', 'é–‹å§‹æ™‚é–“', 'çµ‚äº†æ™‚é–“', 'ä¼‘æ†©', 'å‹¤å‹™çŠ¶æ³', 'å‹¤å‹™LH', 'å¤œå‹¤æ™‚é–“', 'æ®‹æ¥­æ™‚é–“'];
                data.push(headers);

                const tableData = getCurrentTableData();
                tableData.forEach(emp => {
                    const startTime = parseTime(emp.startTime);
                    const endTime = parseTime(emp.endTime);
                    const breakTime = parseTime(emp.break);
                    
                    const workHours = emp.isWorking && startTime !== null && endTime !== null ? 
                        calculateWorkHours(startTime, endTime, breakTime) : 0;
                    const nightHours = emp.isWorking && startTime !== null && endTime !== null ? 
                        calculateNightShiftHours(startTime, endTime, breakTime) : 0;
                    const overtimeHours = emp.isWorking ? Math.max(0, workHours - 8) : 0;
                    
                    data.push([
                        emp.company, emp.timeSlot, emp.mainJob, emp.name, emp.gender,
                        emp.hourlyWage, emp.transportation, emp.startTime, emp.endTime,
                        emp.break, emp.status, 
                        workHours > 0 ? workHours.toFixed(2) : '',
                        nightHours > 0 ? nightHours.toFixed(2) : '',
                        overtimeHours > 0 ? overtimeHours.toFixed(2) : ''
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [
                    { width: 15 }, { width: 10 }, { width: 12 }, { width: 15 }, { width: 8 }, { width: 10 },
                    { width: 12 }, { width: 10 }, { width: 10 }, { width: 8 }, { width: 10 }, { width: 10 }, { width: 10 }, { width: 10 }
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'è©³ç´°ãƒ‡ãƒ¼ã‚¿');
                
                const fileName = targetDate ? `${targetDate}_${selectedSheet}_è©³ç´°ãƒ‡ãƒ¼ã‚¿.xlsx` : `${selectedSheet}_è©³ç´°ãƒ‡ãƒ¼ã‚¿.xlsx`;
                XLSX.writeFile(wb, fileName);
                showStatus('è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function exportCompanySummary() {
            if (!document.querySelector('.shift-table')) {
                showStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            if (!allCompanies || allCompanies.length === 0) {
                showStatus('ä¼šç¤¾ãƒªã‚¹ãƒˆãŒæŠ½å‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const companySummary = generateCompanySummary();
                
                const targetDate = document.getElementById('targetDate').value;
                const selectedSheet = document.getElementById('sheetSelect').value;
                const dateObj = new Date(targetDate);
                const formattedDate = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ ${selectedSheet}`;

                const data = [];
                data.push([formattedDate + ' ä¼šç¤¾åˆ¥é›†è¨ˆ']);
                data.push([`åŸºæº–UPH: ${baseUPH} ${isUPHAutoExtracted ? '(è‡ªå‹•æŠ½å‡º)' : '(æ‰‹å‹•è¨­å®š)'}`]);
                data.push([]);
                
                data.push(['HC']);
                // å…¨ä¼šç¤¾ã‚’å›ºå®šé †åºã§å‡ºåŠ›
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { hc: 0, totalLH: 0, totalCost: 0 };
                    data.push([company, summary.hc || '']);
                });
                
                const totalHC = Object.values(companySummary).reduce((sum, s) => sum + s.hc, 0);
                data.push(['', totalHC]);
                data.push([]);
                
                data.push(['çµŒè²»']);
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { hc: 0, totalLH: 0, totalCost: 0 };
                    const cost = summary.totalCost || 0;
                    data.push([company, cost > 0 ? Math.round(cost) : '']);
                });
                data.push(['', Math.round(Object.values(companySummary).reduce((sum, s) => sum + s.totalCost, 0))]);
                data.push([]);
                
                data.push(['LH']);
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { hc: 0, totalLH: 0, totalCost: 0 };
                    const lh = summary.totalLH || 0;
                    data.push([company, lh > 0 ? Math.round(lh) : '']);
                });
                data.push(['', Math.round(Object.values(companySummary).reduce((sum, s) => sum + s.totalLH, 0))]);

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{ width: 15 }, { width: 12 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ä¼šç¤¾åˆ¥é›†è¨ˆ');
                
                const fileName = targetDate ? `${targetDate}_${selectedSheet}_ä¼šç¤¾åˆ¥é›†è¨ˆ.xlsx` : `${selectedSheet}_ä¼šç¤¾åˆ¥é›†è¨ˆ.xlsx`;
                XLSX.writeFile(wb, fileName);
                showStatus('ä¼šç¤¾åˆ¥é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('ä¼šç¤¾åˆ¥é›†è¨ˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ä¼šç¤¾åˆ¥é›†è¨ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function generateCompanySummary() {
            const tableData = getCurrentTableData();
            const companySummary = {};
            
            tableData.forEach(emp => {
                if (emp.isWorking && emp.company.trim()) {
                    const company = emp.company.trim();
                    const hourlyWageStr = emp.hourlyWage || '0';
                    const transportationStr = emp.transportation || '0';
                    
                    const hourlyWage = parseFloat(String(hourlyWageStr).replace(/[^\d.]/g, '')) || 0;
                    const transportation = parseFloat(String(transportationStr).replace(/[^\d.]/g, '')) || 0;
                    
                    if (!companySummary[company]) {
                        companySummary[company] = { hc: 0, totalLH: 0, totalCost: 0 };
                    }
                    
                    companySummary[company].hc += 1;
                    
                    const startTime = parseTime(emp.startTime);
                    const endTime = parseTime(emp.endTime);
                    const breakTime = parseTime(emp.break);
                    
                    if (startTime !== null && endTime !== null) {
                        const workHours = calculateWorkHours(startTime, endTime, breakTime);
                        const nightHours = calculateNightShiftHours(startTime, endTime, breakTime);
                        const overtimeHours = Math.max(0, workHours - 8);
                        
                        companySummary[company].totalLH += workHours;
                        
                        const regularHours = Math.max(0, workHours - overtimeHours);
                        const baseCost = regularHours * hourlyWage;
                        const overtimeBaseCost = overtimeHours * hourlyWage;
                        const nightAllowance = nightHours * hourlyWage * 0.25;
                        const overtimeAllowance = overtimeHours * hourlyWage * 0.25;
                        
                        companySummary[company].totalCost += baseCost + overtimeBaseCost + nightAllowance + overtimeAllowance + transportation;
                    } else {
                        companySummary[company].totalCost += transportation;
                    }
                }
            });
            
            return companySummary;
        }

        function exportCombinedSummary() {
            if (!workbook) {
                showStatus('Excelãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            if (!allCompanies || allCompanies.length === 0) {
                showStatus('ä¼šç¤¾ãƒªã‚¹ãƒˆãŒæŠ½å‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            const hasDay = workbook.SheetNames.includes('æ—¥å‹¤');
            const hasNight = workbook.SheetNames.includes('å¤œå‹¤');
            
            if (!hasDay && !hasNight) {
                showStatus('æ—¥å‹¤ãƒ»å¤œå‹¤ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const companySummary = generateCombinedCompanySummary();

                const targetDate = document.getElementById('targetDate').value;
                const dateObj = new Date(targetDate);
                const formattedDate = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥`;

                const data = [];
                data.push([formattedDate + ' æ—¥å‹¤+å¤œå‹¤åˆç®—é›†è¨ˆ']);
                
                const availableShifts = [];
                if (hasDay) availableShifts.push('æ—¥å‹¤');
                if (hasNight) availableShifts.push('å¤œå‹¤');
                data.push([`å¯¾è±¡ã‚·ãƒ•ãƒˆ: ${availableShifts.join('ãƒ»')}`]);
                data.push([`åŸºæº–UPH: ${baseUPH} ${isUPHAutoExtracted ? '(è‡ªå‹•æŠ½å‡º)' : '(æ‰‹å‹•è¨­å®š)'}`]);
                data.push([]);
                
                data.push(['HC', '', 'æ—¥å‹¤', 'å¤œå‹¤', 'åˆè¨ˆ']);
                // å…¨ä¼šç¤¾ã‚’å›ºå®šé †åºã§å‡ºåŠ›
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { 
                        hc: 0, totalLH: 0, totalCost: 0, 
                        dayShiftHC: 0, nightShiftHC: 0 
                    };
                    data.push([
                        company, 
                        '', 
                        summary.dayShiftHC || '', 
                        summary.nightShiftHC || '', 
                        summary.hc || ''
                    ]);
                });
                
                const totalHC = Object.values(companySummary).reduce((sum, s) => sum + s.hc, 0);
                const totalDayHC = Object.values(companySummary).reduce((sum, s) => sum + (s.dayShiftHC || 0), 0);
                const totalNightHC = Object.values(companySummary).reduce((sum, s) => sum + (s.nightShiftHC || 0), 0);
                data.push(['åˆè¨ˆ', '', totalDayHC, totalNightHC, totalHC]);
                data.push([]);
                
                data.push(['çµŒè²»']);
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { 
                        hc: 0, totalLH: 0, totalCost: 0, 
                        dayShiftHC: 0, nightShiftHC: 0 
                    };
                    const cost = summary.totalCost || 0;
                    data.push([company, cost > 0 ? Math.round(cost) : '']);
                });
                data.push(['åˆè¨ˆ', Math.round(Object.values(companySummary).reduce((sum, s) => sum + s.totalCost, 0))]);
                data.push([]);
                
                data.push(['LH']);
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { 
                        hc: 0, totalLH: 0, totalCost: 0, 
                        dayShiftHC: 0, nightShiftHC: 0 
                    };
                    const lh = summary.totalLH || 0;
                    data.push([company, lh > 0 ? Math.round(lh) : '']);
                });
                data.push(['åˆè¨ˆ', Math.round(Object.values(companySummary).reduce((sum, s) => sum + s.totalLH, 0))]);

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{ width: 15 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 10 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'æ—¥å‹¤å¤œå‹¤åˆç®—é›†è¨ˆ');
                
                const fileName = targetDate ? `${targetDate}_æ—¥å‹¤å¤œå‹¤åˆç®—é›†è¨ˆ.xlsx` : 'æ—¥å‹¤å¤œå‹¤åˆç®—é›†è¨ˆ.xlsx';
                XLSX.writeFile(wb, fileName);
                showStatus('æ—¥å‹¤+å¤œå‹¤åˆç®—é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('åˆç®—é›†è¨ˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus('åˆç®—é›†è¨ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function generateCombinedCompanySummary() {
            const targetDateStr = document.getElementById('targetDate').value;
            if (!targetDateStr || !workbook) return null;

            const targetDate = new Date(targetDateStr);
            const companySummary = {};
            
            const shiftsToProcess = ['æ—¥å‹¤', 'å¤œå‹¤'];
            
            shiftsToProcess.forEach(sheetName => {
                if (!workbook.SheetNames.includes(sheetName)) return;
                
                try {
                    const worksheet = workbook.Sheets[sheetName];
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (!sheetData || sheetData.length < 2) return;
                    
                    const headerRow = sheetData[0];
                    const sheetDateColumns = [];
                    
                    headerRow.forEach((cell, index) => {
                        if (typeof cell === 'number' && cell >= 45000) {
                            const excelDate = new Date((cell - 25569) * 86400 * 1000);
                            sheetDateColumns.push({
                                index: index,
                                excelValue: cell,
                                date: excelDate
                            });
                        }
                    });
                    
                    let targetColumnIndex = -1;
                    let minDiff = Infinity;
                    
                    sheetDateColumns.forEach(col => {
                        const diff = Math.abs(col.date.getTime() - targetDate.getTime());
                        if (diff < minDiff) {
                            minDiff = diff;
                            targetColumnIndex = col.index;
                        }
                    });
                    
                    if (targetColumnIndex === -1) return;
                    
                    const excludeKeywords = [
                        'PLAN', 'FCST', 'UPH', 'HC', 'LH', 
                        'å‡ºå‹¤HC', 'å‡ºå‹¤LH', 'å¿…è¦LH', 'éä¸è¶³', 'HCæ›ç®—',
                        'å¤œå‹¤æ‰‹å½“', 'æ®‹æ¥­æ‰‹å½“', 'ç·è²»ç”¨', 'å¹³å‡å˜ä¾¡',
                        'å®Ÿç¸¾UPH', 'åŸºæº–UPH', 'FCSTæ•°é‡', 'PLANæ•°é‡'
                    ];
                    
                    for (let i = 1; i < sheetData.length; i++) {
                        const row = sheetData[i];
                        if (!row || row.length === 0) continue;
                        
                        const employeeData = {
                            company: row[0] != null ? String(row[0]) : '',
                            timeSlot: row[1] != null ? String(row[1]) : '',
                            mainJob: row[2] != null ? String(row[2]) : '',
                            name: row[3] != null ? String(row[3]) : '',
                            gender: row[4] != null ? String(row[4]) : '',
                            hourlyWage: row[5] != null ? String(row[5]) : '',
                            transportation: row[6] != null ? String(row[6]) : '',
                            startTime: row[7] != null ? String(row[7]) : '',
                            endTime: row[8] != null ? String(row[8]) : '',
                            break: row[9] != null ? String(row[9]) : '',
                            status: row[targetColumnIndex] != null ? String(row[targetColumnIndex]) : ''
                        };
                        
                        const shouldExclude = excludeKeywords.some(keyword => {
                            return employeeData.company.includes(keyword) ||
                                   employeeData.timeSlot.includes(keyword) ||
                                   employeeData.mainJob.includes(keyword) ||
                                   employeeData.name.includes(keyword) ||
                                   employeeData.gender.includes(keyword);
                        });
                        
                        if (shouldExclude) continue;
                        if (!employeeData.company.trim()) continue;
                        if (!employeeData.name.trim() && !employeeData.company.trim()) continue;
                        if (employeeData.name.trim() && /^\d+$/.test(employeeData.name.trim())) continue;
                        
                        if (employeeData.status === 'â—¯') {
                            const company = employeeData.company.trim();
                            const hourlyWageStr = employeeData.hourlyWage || '0';
                            const transportationStr = employeeData.transportation || '0';
                            
                            const hourlyWage = parseFloat(String(hourlyWageStr).replace(/[^\d.]/g, '')) || 0;
                            const transportation = parseFloat(String(transportationStr).replace(/[^\d.]/g, '')) || 0;
                            
                            if (!companySummary[company]) {
                                companySummary[company] = {
                                    hc: 0, totalLH: 0, totalCost: 0,
                                    dayShiftHC: 0, nightShiftHC: 0
                                };
                            }
                            
                            companySummary[company].hc += 1;
                            
                            if (sheetName === 'å¤œå‹¤') {
                                companySummary[company].nightShiftHC += 1;
                            } else {
                                companySummary[company].dayShiftHC += 1;
                            }
                            
                            const startTime = parseTime(employeeData.startTime);
                            const endTime = parseTime(employeeData.endTime);
                            const breakTime = parseTime(employeeData.break);
                            
                            if (startTime !== null && endTime !== null) {
                                const isCurrentNightShift = sheetName === 'å¤œå‹¤';
                                const workHours = calculateWorkHoursForSheet(startTime, endTime, breakTime, isCurrentNightShift);
                                const nightHours = calculateNightShiftHours(startTime, endTime, breakTime);
                                const overtimeHours = Math.max(0, workHours - 8);
                                
                                companySummary[company].totalLH += workHours;
                                
                                const regularHours = Math.max(0, workHours - overtimeHours);
                                const baseCost = regularHours * hourlyWage;
                                const overtimeBaseCost = overtimeHours * hourlyWage;
                                const nightAllowance = nightHours * hourlyWage * 0.25;
                                const overtimeAllowance = overtimeHours * hourlyWage * 0.25;
                                
                                companySummary[company].totalCost += baseCost + overtimeBaseCost + nightAllowance + overtimeAllowance + transportation;
                            } else {
                                companySummary[company].totalCost += transportation;
                            }
                        }
                    }
                } catch (error) {
                    console.error(`${sheetName}ã‚·ãƒ¼ãƒˆã®å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, error);
                }
            });
            
            return companySummary;
        }

        function calculateWorkHoursForSheet(startTime, endTime, breakTime, isNightShift) {
            if (startTime === null || endTime === null) {
                return 0;
            }
            
            let workHours;
            
            if (isNightShift) {
                if (endTime < startTime) {
                    workHours = (24 + endTime) - startTime;
                } else {
                    workHours = endTime - startTime;
                }
            } else {
                if (endTime < startTime) {
                    workHours = endTime - startTime + 24;
                } else {
                    workHours = endTime - startTime;
                }
            }
            
            if (breakTime !== null && breakTime > 0) {
                workHours -= breakTime;
            }
            
            return Math.max(0, workHours);
        }

        function resetData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                document.body.style.opacity = '0.5';
                setTimeout(() => {
                    location.reload();
                }, 300);
            }
        }

        function testViewerConnection() {
            console.log('=== ãƒ“ãƒ¥ãƒ¼ã‚¢æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            const testData = {
                employeeData: [
                    {
                        'ä¼šç¤¾å': 'ãƒ†ã‚¹ãƒˆä¼šç¤¾A',
                        'æ™‚é–“å¸¯': 'æ—¥å‹¤',
                        'ãƒ¡ã‚¤ãƒ³æ¥­å‹™': 'ãƒ†ã‚¹ãƒˆæ¥­å‹™',
                        'æ°å': 'ãƒ†ã‚¹ãƒˆå¤ªéƒ',
                        'æ€§åˆ¥': 'ç”·',
                        'æ™‚çµ¦': '1000',
                        'äº¤é€šè²»': '500',
                        'é–‹å§‹æ™‚é–“': '9:00',
                        'çµ‚äº†æ™‚é–“': '18:00',
                        'ä¼‘æ†©': '1:00',
                        'å‹¤å‹™çŠ¶æ³': 'â—¯',
                        'å‹¤å‹™LH': '8.00',
                        'å¤œå‹¤æ™‚é–“': '0.00',
                        'æ®‹æ¥­æ™‚é–“': '0.00'
                    }
                ],
                shiftTitle: 'ãƒ†ã‚¹ãƒˆã‚·ãƒ•ãƒˆè¡¨ - ' + new Date().toLocaleString('ja-JP'),
                isNightShift: false,
                baseUPH: 25,
                planValue: 15000,
                fcstValue: 18000,
                transferTimestamp: Date.now()
            };

            console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:', testData);

            const isFileProtocol = window.location.protocol === 'file:';
            
            if (isFileProtocol) {
                try {
                    localStorage.setItem('shiftDataTransfer', JSON.stringify(testData));
                    localStorage.setItem('shiftDataTransfer_timestamp', Date.now().toString());
                    console.log('file://ãƒ—ãƒ­ãƒˆã‚³ãƒ«: localStorageã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜');
                } catch (error) {
                    console.error('localStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    showStatus('localStorageã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return;
                }
            } else {
                localStorage.setItem('shiftDataTransfer', JSON.stringify(testData));
            }
            
            const viewerWindow = window.open('./viewer.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (!viewerWindow) {
                showStatus('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ', 'error');
                return;
            }

            setTimeout(() => {
                try {
                    viewerWindow.postMessage({
                        type: 'SHIFT_DATA_TRANSFER',
                        data: testData
                    }, '*');
                    console.log('PostMessageã§ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡');
                } catch (error) {
                    console.error('PostMessageé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                }
            }, 1000);

            showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§ãƒ“ãƒ¥ãƒ¼ã‚¢ã‚’é–‹ãã¾ã—ãŸ', 'success');
            console.log('=== ãƒ“ãƒ¥ãƒ¼ã‚¢æ¥ç¶šãƒ†ã‚¹ãƒˆå®Œäº† ===');
        }

        function initializeApp() {
            document.getElementById('targetDate').value = new Date().toISOString().split('T')[0];
            setupFileUpload();
            document.getElementById('sheetSelect').addEventListener('change', handleSheetChange);
            document.getElementById('targetDate').addEventListener('change', handleDateChange);
            loadTheme();
            cleanupOldTransferData();
            if (window.location.protocol === 'file:') {
                setTimeout(showFileProtocolWarning, 2000);
            }
            showStatus('ã‚¢ãƒ—ãƒªãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ', 'success');
        }

        function showFileProtocolWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(45deg, #FF5722, #F44336);
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                max-width: 380px;
                z-index: 1001;
                font-size: 0.9rem;
                line-height: 1.4;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;
            
            warningDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px;">âš ï¸ Webã‚µãƒ¼ãƒãƒ¼ã‚’æ¨å¥¨</div>
                <div style="margin-bottom: 12px;">
                    ç¾åœ¨file://ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§å®Ÿè¡Œä¸­ã§ã™ã€‚<br>
                    ã€ŒğŸš€ ãƒ“ãƒ¥ãƒ¼ã‚¢ã§ç·¨é›†ã€æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>
                    <strong>Webã‚µãƒ¼ãƒãƒ¼ã§ã®å®Ÿè¡Œã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚</strong>
                </div>
                <button onclick="this.parentElement.remove(); showServerInstructions();" 
                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
                               color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer;">
                    ğŸ“– ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ–¹æ³•
                </button>
                <button onclick="this.parentElement.remove();" 
                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
                               color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-left: 8px;">
                    âŒ ç†è§£ã—ã¾ã—ãŸ
                </button>
            `;
            
            document.body.appendChild(warningDiv);
            setTimeout(() => {
                if (warningDiv.parentElement) {
                    warningDiv.remove();
                }
            }, 15000);
        }

        function cleanupOldTransferData() {
            try {
                const storedData = localStorage.getItem('shiftDataTransfer');
                if (storedData) {
                    const transferData = JSON.parse(storedData);
                    const currentTime = Date.now();
                    const dataAge = currentTime - transferData.transferTimestamp;
                    if (dataAge > 300000) {
                        localStorage.removeItem('shiftDataTransfer');
                        console.log('å¤ã„è»¢é€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ');
                    }
                }
            } catch (error) {
                localStorage.removeItem('shiftDataTransfer');
            }
        }

        function handleDateChange() {
            if (workbookData && dateColumns.length > 0) {
                extractPlanValue();
                extractFcstValue();
                extractBaseUPH();
                if (document.getElementById('resultsContainer').style.display !== 'none') {
                    const currentData = getCurrentTableData();
                    if (currentData && currentData.length > 0) {
                        updateCalculations(currentData);
                        showStatus(`æ—¥ä»˜å¤‰æ›´ã«ä¼´ã„åŸºæº–UPH: ${baseUPH} ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ`, 'success');
                    }
                }
            }
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
                    const CACHE_NAME = 'shift-app-v4-1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `))
                .then(registration => {
                    console.log('ServiceWorker registered successfully');
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed');
                });
            }
        }

        function setupPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installBtn').style.display = 'block';
            });
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showStatus('ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸï¼', 'success');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBtn').style.display = 'none';
                });
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = 'â˜€ï¸';
            }
        }

        function setupFileUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            uploadZone.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        function handleFileSelect(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showStatus('Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsx/.xlsï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            showProgress(true);
            setTimeout(() => {
                processFile(file);
            }, 100);
        }

        function showProgress(show, progress = 0) {
            const container = document.getElementById('progressContainer');
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            
            if (show) {
                container.style.display = 'block';
                fill.style.width = progress + '%';
                if (progress === 0) {
                    text.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                } else if (progress < 50) {
                    text.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...';
                } else if (progress < 90) {
                    text.textContent = 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—ä¸­...';
                } else {
                    text.textContent = 'å‡¦ç†å®Œäº†';
                }
            } else {
                container.style.display = 'none';
            }
        }

        function processFile(file) {
            const reader = new FileReader();
            
            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    const progress = (e.loaded / e.total) * 100;
                    showProgress(true, progress);
                }
            };
            
            reader.onload = function(e) {
                try {
                    showProgress(true, 90);
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    document.getElementById('fileName').textContent = `âœ… ${file.name} (${formatFileSize(file.size)})`;
                    document.getElementById('fileInfo').style.display = 'block';
                    setupSheetSelection();
                    showProgress(false);
                    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ', 'success');
                } catch (error) {
                    showProgress(false);
                    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function setupSheetSelection() {
            const sheetSelect = document.getElementById('sheetSelect');
            const sheetSection = document.getElementById('sheetSection');
            
            sheetSelect.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            const targetSheets = ['æ—¥å‹¤', 'å¤œå‹¤'];
            let hasSheets = false;
            
            targetSheets.forEach(sheetName => {
                if (workbook.SheetNames.includes(sheetName)) {
                    const option = document.createElement('option');
                    option.value = sheetName;
                    option.textContent = `${sheetName}ã‚·ãƒ•ãƒˆ`;
                    sheetSelect.appendChild(option);
                    hasSheets = true;
                }
            });
            
            if (!hasSheets) {
                sheetSelect.innerHTML = '<option value="">æ—¥å‹¤ãƒ»å¤œå‹¤ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€Œæ—¥å‹¤ã€ã¾ãŸã¯ã€Œå¤œå‹¤ã€ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // å…¨ä¼šç¤¾ãƒªã‚¹ãƒˆã‚’æŠ½å‡º
            extractAllCompanies();
            
            sheetSection.style.display = 'block';
        }

        function extractAllCompanies() {
            const companiesSet = new Set();
            const targetSheets = ['æ—¥å‹¤', 'å¤œå‹¤'];
            
            const excludeKeywords = [
                'PLAN', 'FCST', 'UPH', 'HC', 'LH', 
                'å‡ºå‹¤HC', 'å‡ºå‹¤LH', 'å¿…è¦LH', 'éä¸è¶³', 'HCæ›ç®—',
                'å¤œå‹¤æ‰‹å½“', 'æ®‹æ¥­æ‰‹å½“', 'ç·è²»ç”¨', 'å¹³å‡å˜ä¾¡',
                'å®Ÿç¸¾UPH', 'åŸºæº–UPH', 'FCSTæ•°é‡', 'PLANæ•°é‡'
            ];
            
            targetSheets.forEach(sheetName => {
                if (!workbook.SheetNames.includes(sheetName)) return;
                
                try {
                    const worksheet = workbook.Sheets[sheetName];
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (!sheetData || sheetData.length < 2) return;
                    
                    for (let i = 1; i < sheetData.length; i++) {
                        const row = sheetData[i];
                        if (!row || row.length === 0) continue;
                        
                        const companyName = row[0] != null ? String(row[0]).trim() : '';
                        
                        // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
                        const shouldExclude = excludeKeywords.some(keyword => 
                            companyName.includes(keyword)
                        );
                        
                        if (shouldExclude) continue;
                        if (!companyName) continue;
                        if (/^\d+$/.test(companyName)) continue; // æ•°å­—ã®ã¿ã¯é™¤å¤–
                        
                        companiesSet.add(companyName);
                    }
                } catch (error) {
                    console.error(`${sheetName}ã‚·ãƒ¼ãƒˆã®ä¼šç¤¾æŠ½å‡ºã‚¨ãƒ©ãƒ¼:`, error);
                }
            });
            
            // Gworkerã‚’æœ€åˆã«ã€ãã®å¾Œã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ãƒ»ã‚ã„ã†ãˆãŠé †ã§ã‚½ãƒ¼ãƒˆ
            allCompanies = Array.from(companiesSet).sort((a, b) => {
                if (a === 'Gworker') return -1;
                if (b === 'Gworker') return 1;
                return a.localeCompare(b, 'ja');
            });
            
            console.log('æŠ½å‡ºã•ã‚ŒãŸå…¨ä¼šç¤¾ãƒªã‚¹ãƒˆ:', allCompanies);
        }

        function handleSheetChange(event) {
            const selectedSheet = event.target.value;
            if (!selectedSheet || !workbook) {
                document.getElementById('generateBtn').disabled = true;
                return;
            }

            isNightShift = selectedSheet === 'å¤œå‹¤';

            try {
                const worksheet = workbook.Sheets[selectedSheet];
                workbookData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                analyzeDateColumns();
                extractPlanValue();
                extractFcstValue();
                extractBaseUPH();
                
                document.getElementById('generateBtn').disabled = false;
                const uphStatus = isUPHAutoExtracted ? 'ï¼ˆè‡ªå‹•æŠ½å‡ºï¼‰' : 'ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰';
                showStatus(`ã€Œ${selectedSheet}ã€ã‚·ãƒ¼ãƒˆãŒé¸æŠã•ã‚Œã¾ã—ãŸï¼ˆåŸºæº–UPH: ${baseUPH} ${uphStatus}ï¼‰`, 'success');
            } catch (error) {
                showStatus('ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                document.getElementById('generateBtn').disabled = true;
            }
        }

        function analyzeDateColumns() {
            if (!workbookData || workbookData.length < 2) return;
            
            const headerRow = workbookData[0];
            dateColumns = [];
            
            headerRow.forEach((cell, index) => {
                if (typeof cell === 'number' && cell >= 45000) {
                    const excelDate = new Date((cell - 25569) * 86400 * 1000);
                    dateColumns.push({
                        index: index,
                        excelValue: cell,
                        date: excelDate
                    });
                }
            });
            
            console.log(`${dateColumns.length}å€‹ã®æ—¥ä»˜åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
        }

        function extractPlanValue() {
            if (!workbookData || workbookData.length < 2) return;
            
            const targetDateStr = document.getElementById('targetDate').value;
            if (!targetDateStr) return;
            
            const targetDate = new Date(targetDateStr);
            let targetColumnIndex = -1;
            let minDiff = Infinity;
            
            dateColumns.forEach(col => {
                const diff = Math.abs(col.date.getTime() - targetDate.getTime());
                if (diff < minDiff) {
                    minDiff = diff;
                    targetColumnIndex = col.index;
                }
            });
            
            if (targetColumnIndex === -1) return;
            
            for (let i = 0; i < workbookData.length; i++) {
                const row = workbookData[i];
                if (row && row[4] != null) {
                    const cellValue = String(row[4]).toUpperCase();
                    if (cellValue.includes('PLAN')) {
                        const planRow = workbookData[i];
                        const planCell = planRow[targetColumnIndex];
                        
                        if (typeof planCell === 'number' && planCell > 0 && planCell < 1000000) {
                            planValue = planCell;
                            return;
                        }
                        
                        if (planCell != null) {
                            const numMatch = String(planCell).match(/(\d+)/);
                            if (numMatch) {
                                const extractedNum = parseInt(numMatch[1]);
                                if (extractedNum > 0 && extractedNum < 1000000) {
                                    planValue = extractedNum;
                                    return;
                                }
                            }
                        }
                        break;
                    }
                }
            }
        }

        function extractFcstValue() {
            if (!workbookData || workbookData.length < 2) return;
            
            const targetDateStr = document.getElementById('targetDate').value;
            if (!targetDateStr) return;
            
            const targetDate = new Date(targetDateStr);
            let targetColumnIndex = -1;
            let minDiff = Infinity;
            
            dateColumns.forEach(col => {
                const diff = Math.abs(col.date.getTime() - targetDate.getTime());
                if (diff < minDiff) {
                    minDiff = diff;
                    targetColumnIndex = col.index;
                }
            });
            
            if (targetColumnIndex === -1) return;
            
            for (let i = 0; i < workbookData.length; i++) {
                const row = workbookData[i];
                if (row && row[4] != null) {
                    const cellValue = String(row[4]).toUpperCase();
                    if (cellValue.includes('FCST')) {
                        const fcstRow = workbookData[i];
                        const fcstCell = fcstRow[targetColumnIndex];
                        
                        if (typeof fcstCell === 'number' && fcstCell > 0 && fcstCell < 1000000) {
                            fcstValue = fcstCell;
                            return;
                        }
                        
                        if (fcstCell != null) {
                            const numMatch = String(fcstCell).match(/(\d+)/);
                            if (numMatch) {
                                const extractedNum = parseInt(numMatch[1]);
                                if (extractedNum > 0 && extractedNum < 1000000) {
                                    fcstValue = extractedNum;
                                    return;
                                }
                            }
                        }
                        break;
                    }
                }
            }
        }

        function extractBaseUPH() {
            if (!workbookData || workbookData.length < 2) return;
            
            const targetDateStr = document.getElementById('targetDate').value;
            if (!targetDateStr) return;
            
            const targetDate = new Date(targetDateStr);
            let targetColumnIndex = -1;
            let minDiff = Infinity;
            
            dateColumns.forEach(col => {
                const diff = Math.abs(col.date.getTime() - targetDate.getTime());
                if (diff < minDiff) {
                    minDiff = diff;
                    targetColumnIndex = col.index;
                }
            });
            
            if (targetColumnIndex === -1) return;
            
            const uphPatterns = ['åŸºæº–UPH', 'UPH', 'åŸºæº–', 'BASE UPH', 'BASEUPH', 'æ¨™æº–UPH'];
            
            for (let i = 0; i < workbookData.length; i++) {
                const row = workbookData[i];
                if (!row) continue;
                
                for (let j = 0; j < Math.min(row.length, 10); j++) {
                    if (row[j] != null) {
                        const cellValue = String(row[j]).toUpperCase().replace(/\s/g, '');
                        
                        const isUPHRow = uphPatterns.some(pattern => 
                            cellValue.includes(pattern.toUpperCase().replace(/\s/g, ''))
                        );
                        
                        if (isUPHRow) {
                            const uphCell = row[targetColumnIndex];
                            
                            if (typeof uphCell === 'number' && uphCell > 0 && uphCell < 1000) {
                                baseUPH = uphCell;
                                isUPHAutoExtracted = true;
                                console.log(`åŸºæº–UPH ${baseUPH} ã‚’è‡ªå‹•å–å¾—ã—ã¾ã—ãŸï¼ˆè¡Œ${i+1}, åˆ—${targetColumnIndex+1}ï¼‰`);
                                return;
                            }
                            
                            if (uphCell != null) {
                                const numMatch = String(uphCell).match(/(\d+\.?\d*)/);
                                if (numMatch) {
                                    const extractedNum = parseFloat(numMatch[1]);
                                    if (extractedNum > 0 && extractedNum < 1000) {
                                        baseUPH = extractedNum;
                                        isUPHAutoExtracted = true;
                                        console.log(`åŸºæº–UPH ${baseUPH} ã‚’è‡ªå‹•å–å¾—ã—ã¾ã—ãŸï¼ˆæ–‡å­—åˆ—ã‹ã‚‰è§£æï¼‰`);
                                        return;
                                    }
                                }
                            }
                            break;
                        }
                    }
                }
            }
            
            isUPHAutoExtracted = false;
            console.log(`åŸºæº–UPHãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ ${baseUPH} ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
        }

        function generateDailyShift() {
            if (!workbookData || dateColumns.length === 0) {
                showStatus('ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            const targetDateStr = document.getElementById('targetDate').value;
            if (!targetDateStr) {
                showStatus('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const generateText = document.getElementById('generateText');
            
            generateBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            generateText.textContent = 'ç”Ÿæˆä¸­...';

            setTimeout(() => {
                try {
                    const targetDate = new Date(targetDateStr);
                    
                    let targetColumnIndex = -1;
                    let minDiff = Infinity;
                    
                    dateColumns.forEach(col => {
                        const diff = Math.abs(col.date.getTime() - targetDate.getTime());
                        if (diff < minDiff) {
                            minDiff = diff;
                            targetColumnIndex = col.index;
                        }
                    });

                    if (targetColumnIndex === -1) {
                        throw new Error('æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã«å¯¾å¿œã™ã‚‹åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }

                    const shiftData = [];
                    let workingCount = 0;
                    let excludedCompanyCount = 0;
                    
                    const excludeKeywords = [
                        'PLAN', 'FCST', 'UPH', 'HC', 'LH', 
                        'å‡ºå‹¤HC', 'å‡ºå‹¤LH', 'å¿…è¦LH', 'éä¸è¶³', 'HCæ›ç®—',
                        'å¤œå‹¤æ‰‹å½“', 'æ®‹æ¥­æ‰‹å½“', 'ç·è²»ç”¨', 'å¹³å‡å˜ä¾¡',
                        'å®Ÿç¸¾UPH', 'åŸºæº–UPH', 'FCSTæ•°é‡', 'PLANæ•°é‡'
                    ];
                    
                    for (let i = 1; i < workbookData.length; i++) {
                        const row = workbookData[i];
                        if (!row || row.length === 0) continue;
                        
                        const employeeData = {
                            company: row[0] != null ? String(row[0]) : '',
                            timeSlot: row[1] != null ? String(row[1]) : '',
                            mainJob: row[2] != null ? String(row[2]) : '',
                            name: row[3] != null ? String(row[3]) : '',
                            gender: row[4] != null ? String(row[4]) : '',
                            hourlyWage: row[5] != null ? String(row[5]) : '',
                            transportation: row[6] != null ? String(row[6]) : '',
                            startTime: row[7] != null ? String(row[7]) : '',
                            endTime: row[8] != null ? String(row[8]) : '',
                            break: row[9] != null ? String(row[9]) : '',
                            status: row[targetColumnIndex] != null ? String(row[targetColumnIndex]) : ''
                        };
                        
                        const shouldExclude = excludeKeywords.some(keyword => {
                            return employeeData.company.includes(keyword) ||
                                   employeeData.timeSlot.includes(keyword) ||
                                   employeeData.mainJob.includes(keyword) ||
                                   employeeData.name.includes(keyword) ||
                                   employeeData.gender.includes(keyword);
                        });
                        
                        if (shouldExclude) continue;
                        
                        if (!employeeData.company.trim()) {
                            excludedCompanyCount++;
                            continue;
                        }
                        
                        if (!employeeData.name.trim() && !employeeData.company.trim()) continue;
                        if (employeeData.name.trim() && /^\d+$/.test(employeeData.name.trim())) continue;
                        
                        if (employeeData.status === 'â—¯') {
                            employeeData.isWorking = true;
                            workingCount++;
                        } else if (employeeData.status && employeeData.status !== '') {
                            employeeData.isWorking = false;
                        } else {
                            continue;
                        }
                        
                        shiftData.push(employeeData);
                    }

                    originalShiftData = JSON.parse(JSON.stringify(shiftData));

                    extractPlanValue();
                    extractFcstValue();
                    extractBaseUPH();

                    displayResults(shiftData, targetDate, workingCount);
                    
                    generateBtn.disabled = false;
                    loadingSpinner.style.display = 'none';
                    generateText.textContent = 'ğŸš€ ã‚·ãƒ•ãƒˆè¡¨ã‚’ç”Ÿæˆ';
                    
                    const uphStatus = isUPHAutoExtracted ? 'ï¼ˆè‡ªå‹•æŠ½å‡ºï¼‰' : 'ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰';
                    const excludeMessage = excludedCompanyCount > 0 ? ` | ${excludedCompanyCount}è¡Œé™¤å¤–` : '';
                    showStatus(`${targetDate.toLocaleDateString('ja-JP')}ã®ã‚·ãƒ•ãƒˆè¡¨ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆåŸºæº–UPH: ${baseUPH} ${uphStatus}ï¼‰${excludeMessage}`, 'success');
                    
                    console.log(`ã‚·ãƒ•ãƒˆè¡¨ç”Ÿæˆå®Œäº†:`, {
                        ç·è¡Œæ•°: workbookData.length - 1,
                        æœ‰åŠ¹è¡Œæ•°: shiftData.length,
                        å‡ºå‹¤è€…æ•°: workingCount,
                        ä¼šç¤¾åç©ºç™½é™¤å¤–: excludedCompanyCount
                    });
                    
                } catch (error) {
                    console.error('ã‚·ãƒ•ãƒˆè¡¨ç”Ÿæˆã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                    
                    generateBtn.disabled = false;
                    loadingSpinner.style.display = 'none';
                    generateText.textContent = 'ğŸš€ ã‚·ãƒ•ãƒˆè¡¨ã‚’ç”Ÿæˆ';
                    showStatus('ã‚·ãƒ•ãƒˆè¡¨ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            }, 500);
        }

        function displayResults(data, date, workingCount) {
            document.getElementById('resultsContainer').style.display = 'block';
            updateCalculations(data);
            updateTable(data);
            document.getElementById('resultsContainer').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        function updateCalculations(data) {
            const calcGrid = document.getElementById('calcGrid');
            
            let totalLH = 0;
            let totalCost = 0;
            let totalNightAllowance = 0;
            let totalOvertimeAllowance = 0;
            let workingCount = 0;
            
            data.forEach(emp => {
                if (emp.isWorking) {
                    workingCount++;
                    
                    const startTime = parseTime(emp.startTime);
                    const endTime = parseTime(emp.endTime);
                    const breakTime = parseTime(emp.break);
                    
                    const hourlyWageStr = emp.hourlyWage != null ? String(emp.hourlyWage) : '0';
                    const transportationStr = emp.transportation != null ? String(emp.transportation) : '0';
                    
                    const hourlyWage = parseFloat(hourlyWageStr.replace(/[^\d.]/g, '')) || 0;
                    const transportation = parseFloat(transportationStr.replace(/[^\d.]/g, '')) || 0;
                    
                    if (startTime !== null && endTime !== null) {
                        const workHours = calculateWorkHours(startTime, endTime, breakTime);
                        const nightHours = calculateNightShiftHours(startTime, endTime, breakTime);
                        const overtimeHours = Math.max(0, workHours - 8);
                        
                        totalLH += workHours;
                        
                        const regularHours = Math.max(0, workHours - overtimeHours);
                        const baseCost = regularHours * hourlyWage;
                        const overtimeBaseCost = overtimeHours * hourlyWage;
                        const nightAllowance = nightHours * hourlyWage * 0.25;
                        totalNightAllowance += nightAllowance;
                        const overtimeAllowance = overtimeHours * hourlyWage * 0.25;
                        totalOvertimeAllowance += overtimeAllowance;
                        
                        totalCost += baseCost + overtimeBaseCost + nightAllowance + overtimeAllowance + transportation;
                    } else {
                        totalCost += transportation;
                    }
                }
            });
            
            const requiredLH = planValue / baseUPH;
            const shortage = totalLH - requiredLH;
            const currentUPH = totalLH > 0 ? planValue / totalLH : 0;
            const averageHourlyCost = totalLH > 0 ? totalCost / totalLH : 0;
            
            const uphIndicator = isUPHAutoExtracted ? 
                '<span class="uph-auto-indicator">è‡ªå‹•</span>' : 
                '<span class="uph-manual-indicator">æ‰‹å‹•</span>';
            
            calcGrid.innerHTML = `
                <div class="calc-card">
                    <div class="calc-label">FCSTæ•°é‡</div>
                    <div class="calc-value">${fcstValue.toLocaleString()}</div>
                    <div class="calc-unit">å€‹</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å‡ºå‹¤HC</div>
                    <div class="calc-value">${workingCount}</div>
                    <div class="calc-unit">äºº</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å‡ºå‹¤LH</div>
                    <div class="calc-value">${totalLH.toFixed(1)}</div>
                    <div class="calc-unit">æ™‚é–“</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å¹³å‡å˜ä¾¡</div>
                    <div class="calc-value">Â¥${Math.round(averageHourlyCost).toLocaleString()}</div>
                    <div class="calc-unit">å††/æ™‚</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">PLANæ•°é‡</div>
                    <input type="number" class="calc-input" value="${planValue}" onchange="updatePlan(this.value)">
                    <div class="calc-unit">å€‹</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">åŸºæº–UPH ${uphIndicator}</div>
                    <input type="number" class="calc-input" value="${baseUPH}" onchange="updateUPH(this.value)" step="0.1">
                    <div class="calc-unit">å€‹/æ™‚ ğŸ“Š</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å¿…è¦LH</div>
                    <div class="calc-value">${requiredLH.toFixed(1)}</div>
                    <div class="calc-unit">æ™‚é–“</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å®Ÿç¸¾UPH</div>
                    <div class="calc-value" style="color: ${currentUPH >= baseUPH ? 'var(--secondary-color)' : '#f44336'}">${Math.round(currentUPH)}</div>
                    <div class="calc-unit">å€‹/æ™‚</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">éä¸è¶³</div>
                    <div class="calc-value" style="color: ${shortage >= 0 ? 'var(--secondary-color)' : '#f44336'}">${shortage.toFixed(1)}</div>
                    <div class="calc-unit">æ™‚é–“</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å¤œå‹¤æ‰‹å½“</div>
                    <div class="calc-value">Â¥${Math.round(totalNightAllowance).toLocaleString()}</div>
                    <div class="calc-unit">å†† (22-5æ™‚)</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">æ®‹æ¥­æ‰‹å½“</div>
                    <div class="calc-value">Â¥${Math.round(totalOvertimeAllowance).toLocaleString()}</div>
                    <div class="calc-unit">å†† (8hè¶…)</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">ç·è²»ç”¨</div>
                    <div class="calc-value">Â¥${Math.round(totalCost).toLocaleString()}</div>
                    <div class="calc-unit">å†† (æ‰‹å½“è¾¼)</div>
                </div>
            `;
        }

        function updateTable(data) {
            const table = document.getElementById('shiftTable');
            
            const headers = ['ä¼šç¤¾å', 'æ™‚é–“å¸¯', 'ãƒ¡ã‚¤ãƒ³æ¥­å‹™', 'æ°å', 'æ€§åˆ¥', 'æ™‚çµ¦', 'äº¤é€šè²»', 'é–‹å§‹æ™‚é–“', 'çµ‚äº†æ™‚é–“', 'ä¼‘æ†©', 'å‹¤å‹™çŠ¶æ³', 'å‹¤å‹™LH', 'å¤œå‹¤H', 'æ®‹æ¥­H', 'æ“ä½œ'];
            
            let tableHTML = '<thead><tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            data.forEach((emp, index) => {
                const startTime = parseTime(emp.startTime);
                const endTime = parseTime(emp.endTime);
                const breakTime = parseTime(emp.break);
                
                const workHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateWorkHours(startTime, endTime, breakTime) : 0;
                const nightHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateNightShiftHours(startTime, endTime, breakTime) : 0;
                const overtimeHours = emp.isWorking ? Math.max(0, workHours - 8) : 0;
                
                const statusOptions = ['â—¯', 'æ¬ å‹¤', 'æœ‰ä¼‘'];
                let statusSelect = '<select class="status-select" data-row-index="' + index + '" data-field="status">';
                statusOptions.forEach(option => {
                    const selected = emp.status === option ? ' selected' : '';
                    statusSelect += `<option value="${option}"${selected}>${option}</option>`;
                });
                statusSelect += '</select>';
                
                tableHTML += `
                    <tr class="${emp.isWorking ? 'working' : ''}" data-row-index="${index}">
                        <td class="editable-cell" contenteditable="true" data-field="company">${emp.company}</td>
                        <td class="editable-cell" contenteditable="true" data-field="timeSlot">${emp.timeSlot}</td>
                        <td class="editable-cell" contenteditable="true" data-field="mainJob">${emp.mainJob}</td>
                        <td class="editable-cell" contenteditable="true" data-field="name">${emp.name}</td>
                        <td class="editable-cell" contenteditable="true" data-field="gender">${emp.gender}</td>
                        <td class="editable-cell" contenteditable="true" data-field="hourlyWage">${emp.hourlyWage}</td>
                        <td class="editable-cell" contenteditable="true" data-field="transportation">${emp.transportation}</td>
                        <td class="editable-cell time-cell" contenteditable="true" data-field="startTime">${emp.startTime}</td>
                        <td class="editable-cell time-cell" contenteditable="true" data-field="endTime">${emp.endTime}</td>
                        <td class="editable-cell time-cell" contenteditable="true" data-field="break">${emp.break}</td>
                        <td class="status-cell">${statusSelect}</td>
                        <td>${workHours > 0 ? workHours.toFixed(2) : ''}</td>
                        <td>${nightHours > 0 ? nightHours.toFixed(2) : ''}</td>
                        <td>${overtimeHours > 0 ? overtimeHours.toFixed(2) : ''}</td>
                        <td class="action-cell">
                            <button class="row-reset-btn" onclick="resetRow(${index})" title="ã“ã®è¡Œã‚’ãƒªã‚»ãƒƒãƒˆ">â†º</button>
                            <button class="row-confirm-btn" onclick="confirmRow(${index})" title="ã“ã®è¡Œã‚’ç¢ºå®š">âœ“</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
            
            addEditListeners();
        }

        function addEditListeners() {
            const editableCells = document.querySelectorAll('.editable-cell');
            const statusSelects = document.querySelectorAll('.status-select');
            
            editableCells.forEach(cell => {
                cell.addEventListener('blur', function() {
                    const field = this.getAttribute('data-field');
                    const newValue = this.textContent.trim();
                    
                    if (['hourlyWage', 'transportation'].includes(field)) {
                        const numValue = parseFloat(newValue.replace(/[^\d.]/g, ''));
                        if (!isNaN(numValue) && numValue >= 0) {
                            if (field === 'hourlyWage') {
                                this.textContent = Math.round(numValue).toString();
                            } else if (field === 'transportation') {
                                this.textContent = Math.round(numValue).toString();
                            }
                        } else if (newValue === '') {
                            this.textContent = '';
                        } else {
                            showStatus('æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                            return;
                        }
                    }
                    
                    if (['startTime', 'endTime', 'break', 'hourlyWage', 'transportation'].includes(field)) {
                        updateRowCalculations();
                    }
                    
                    this.style.background = 'rgba(76, 175, 80, 0.2)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 1000);
                    
                    showStatus('å¤‰æ›´ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ', 'success');
                });
                
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                    
                    const field = this.getAttribute('data-field');
                    if (['hourlyWage', 'transportation'].includes(field)) {
                        const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
                        if (!allowedKeys.includes(e.key) && !e.ctrlKey && !e.metaKey) {
                            if (!/[0-9.]/.test(e.key)) {
                                e.preventDefault();
                                return false;
                            }
                            if (e.key === '.' && this.textContent.includes('.')) {
                                e.preventDefault();
                                return false;
                            }
                        }
                    }
                });
                
                cell.addEventListener('focus', function() {
                    const field = this.getAttribute('data-field');
                    if (['hourlyWage', 'transportation'].includes(field)) {
                        const range = document.createRange();
                        range.selectNodeContents(this);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });
            });
            
            statusSelects.forEach(select => {
                select.addEventListener('change', function() {
                    const newStatus = this.value;
                    const row = this.closest('tr');
                    
                    if (['æ¬ å‹¤', 'æœ‰ä¼‘'].includes(newStatus)) {
                        const startTimeCell = row.querySelector('[data-field="startTime"]');
                        const endTimeCell = row.querySelector('[data-field="endTime"]');
                        const breakCell = row.querySelector('[data-field="break"]');
                        
                        if (startTimeCell) startTimeCell.textContent = '';
                        if (endTimeCell) endTimeCell.textContent = '';
                        if (breakCell) breakCell.textContent = '';
                        
                        row.classList.remove('working');
                        showStatus(`${newStatus}ã«è¨­å®šã—ã€æ™‚é–“ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`, 'success');
                    } else if (newStatus === 'â—¯') {
                        row.classList.add('working');
                        
                        const startTimeCell = row.querySelector('[data-field="startTime"]');
                        const endTimeCell = row.querySelector('[data-field="endTime"]');
                        const breakCell = row.querySelector('[data-field="break"]');
                        
                        if (startTimeCell && !startTimeCell.textContent.trim()) {
                            startTimeCell.textContent = isNightShift ? '22:00' : '8:00';
                        }
                        if (endTimeCell && !endTimeCell.textContent.trim()) {
                            endTimeCell.textContent = isNightShift ? '7:00' : '17:00';
                        }
                        if (breakCell && !breakCell.textContent.trim()) {
                            breakCell.textContent = '1:00';
                        }
                        
                        showStatus('å‡ºå‹¤ã«è¨­å®šã—ã¾ã—ãŸ', 'success');
                    } else {
                        row.classList.remove('working');
                    }
                    
                    updateRowCalculations();
                    
                    this.style.background = 'rgba(76, 175, 80, 0.2)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 1000);
                });
            });
        }

        function addNewRow() {
            const newEmployee = {
                company: '',
                timeSlot: '',
                mainJob: '',
                name: '',
                gender: '',
                hourlyWage: '',
                transportation: '',
                startTime: '',
                endTime: '',
                break: '',
                status: '',
                isWorking: false
            };
            
            const table = document.getElementById('shiftTable');
            const tbody = table.querySelector('tbody');
            const currentRows = tbody.querySelectorAll('tr');
            const newIndex = currentRows.length;
            
            const statusOptions = ['â—¯', 'æ¬ å‹¤', 'æœ‰ä¼‘'];
            let statusSelect = '<select class="status-select" data-row-index="' + newIndex + '" data-field="status">';
            statusSelect += '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            statusOptions.forEach(option => {
                statusSelect += `<option value="${option}">${option}</option>`;
            });
            statusSelect += '</select>';
            
            const newRowHTML = `
                <tr class="" data-row-index="${newIndex}">
                    <td class="editable-cell" contenteditable="true" data-field="company">${newEmployee.company}</td>
                    <td class="editable-cell" contenteditable="true" data-field="timeSlot">${newEmployee.timeSlot}</td>
                    <td class="editable-cell" contenteditable="true" data-field="mainJob">${newEmployee.mainJob}</td>
                    <td class="editable-cell" contenteditable="true" data-field="name">${newEmployee.name}</td>
                    <td class="editable-cell" contenteditable="true" data-field="gender">${newEmployee.gender}</td>
                    <td class="editable-cell" contenteditable="true" data-field="hourlyWage">${newEmployee.hourlyWage}</td>
                    <td class="editable-cell" contenteditable="true" data-field="transportation">${newEmployee.transportation}</td>
                    <td class="editable-cell time-cell" contenteditable="true" data-field="startTime">${newEmployee.startTime}</td>
                    <td class="editable-cell time-cell" contenteditable="true" data-field="endTime">${newEmployee.endTime}</td>
                    <td class="editable-cell time-cell" contenteditable="true" data-field="break">${newEmployee.break}</td>
                    <td class="status-cell">${statusSelect}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="action-cell">
                        <button class="row-reset-btn" onclick="resetRow(${newIndex})" title="ã“ã®è¡Œã‚’ãƒªã‚»ãƒƒãƒˆ">â†º</button>
                        <button class="row-confirm-btn" onclick="confirmRow(${newIndex})" title="ã“ã®è¡Œã‚’ç¢ºå®š">âœ“</button>
                    </td>
                </tr>
            `;
            
            tbody.insertAdjacentHTML('beforeend', newRowHTML);
            addEditListeners();
            
            const newRow = tbody.querySelector(`tr[data-row-index="${newIndex}"]`);
            const firstEditableCell = newRow.querySelector('.editable-cell');
            if (firstEditableCell) {
                firstEditableCell.focus();
            }
            
            showStatus('æ–°ã—ã„è¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }

        function confirmRow(rowIndex) {
            const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (!row) {
                showStatus('ç¢ºå®šã™ã‚‹è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            const nameCell = row.querySelector('[data-field="name"]');
            const employeeName = nameCell ? nameCell.textContent.trim() : '';
            
            if (row.classList.contains('confirmed')) {
                row.classList.remove('confirmed');
                
                const confirmBtn = row.querySelector('.row-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = 'âœ“';
                    confirmBtn.title = 'ã“ã®è¡Œã‚’ç¢ºå®š';
                    confirmBtn.style.background = '';
                }
                
                const name = employeeName || 'è¡Œ';
                showStatus(`${name}ã®ç¢ºå®šã‚’è§£é™¤ã—ã¾ã—ãŸ`, 'success');
            } else {
                if (!employeeName.trim()) {
                    showStatus('æ°åã¯å¿…é ˆé …ç›®ã§ã™', 'error');
                    return;
                }
                
                row.classList.add('confirmed');
                
                const confirmBtn = row.querySelector('.row-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = 'âœ“';
                    confirmBtn.title = 'ç¢ºå®šæ¸ˆã¿ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ï¼‰';
                }
                
                const name = employeeName || 'è¡Œ';
                showStatus(`${name}ã‚’ç¢ºå®šã—ã¾ã—ãŸ`, 'success');
                
                row.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    row.style.transform = '';
                }, 200);
            }
        }

        function getCurrentTableData() {
            const rows = document.querySelectorAll('#shiftTable tbody tr');
            const data = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const statusSelect = row.querySelector('.status-select');
                const status = statusSelect ? statusSelect.value : '';
                
                const getData = (index) => {
                    return cells[index] ? cells[index].textContent.trim() : '';
                };
                
                data.push({
                    company: getData(0),
                    timeSlot: getData(1),
                    mainJob: getData(2),
                    name: getData(3),
                    gender: getData(4),
                    hourlyWage: getData(5),
                    transportation: getData(6),
                    startTime: getData(7),
                    endTime: getData(8),
                    break: getData(9),
                    status: status,
                    isWorking: status === 'â—¯'
                });
            });
            
            return data;
        }

        function updateRowCalculations() {
            const currentData = getCurrentTableData();
            updateCalculations(currentData);
            
            const rows = document.querySelectorAll('#shiftTable tbody tr');
            rows.forEach((row, index) => {
                const emp = currentData[index];
                if (!emp) return;
                
                const startTime = parseTime(emp.startTime);
                const endTime = parseTime(emp.endTime);
                const breakTime = parseTime(emp.break);
                
                const workHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateWorkHours(startTime, endTime, breakTime) : 0;
                const nightHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateNightShiftHours(startTime, endTime, breakTime) : 0;
                const overtimeHours = emp.isWorking ? Math.max(0, workHours - 8) : 0;
                
                const cells = row.querySelectorAll('td');
                if (cells[11]) cells[11].textContent = workHours > 0 ? workHours.toFixed(2) : '';
                if (cells[12]) cells[12].textContent = nightHours > 0 ? nightHours.toFixed(2) : '';
                if (cells[13]) cells[13].textContent = overtimeHours > 0 ? overtimeHours.toFixed(2) : '';
            });
        }

        function resetRow(rowIndex) {
            if (!originalShiftData || !originalShiftData[rowIndex]) {
                const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
                if (!row) return;
                
                if (!confirm('ã“ã®è¡Œã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
                
                const editableCells = row.querySelectorAll('.editable-cell');
                editableCells.forEach(cell => {
                    cell.textContent = '';
                });
                
                const statusSelect = row.querySelector('.status-select');
                if (statusSelect) statusSelect.value = '';
                
                row.classList.remove('working', 'confirmed');
                
                const confirmBtn = row.querySelector('.row-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = 'âœ“';
                    confirmBtn.title = 'ã“ã®è¡Œã‚’ç¢ºå®š';
                    confirmBtn.style.background = '';
                }
                
                updateRowCalculations();
                showStatus('è¡Œã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                return;
            }
            
            if (!confirm('ã“ã®è¡Œã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (!row) return;
            
            const originalData = originalShiftData[rowIndex];
            
            const companyCell = row.querySelector('[data-field="company"]');
            if (companyCell) companyCell.textContent = originalData.company;
            
            const timeSlotCell = row.querySelector('[data-field="timeSlot"]');
            if (timeSlotCell) timeSlotCell.textContent = originalData.timeSlot;
            
            const mainJobCell = row.querySelector('[data-field="mainJob"]');
            if (mainJobCell) mainJobCell.textContent = originalData.mainJob;
            
            const nameCell = row.querySelector('[data-field="name"]');
            if (nameCell) nameCell.textContent = originalData.name;
            
            const genderCell = row.querySelector('[data-field="gender"]');
            if (genderCell) genderCell.textContent = originalData.gender;
            
            const hourlyWageCell = row.querySelector('[data-field="hourlyWage"]');
            if (hourlyWageCell) hourlyWageCell.textContent = originalData.hourlyWage;
            
            const transportationCell = row.querySelector('[data-field="transportation"]');
            if (transportationCell) transportationCell.textContent = originalData.transportation;
            
            const startTimeCell = row.querySelector('[data-field="startTime"]');
            if (startTimeCell) startTimeCell.textContent = originalData.startTime;
            
            const endTimeCell = row.querySelector('[data-field="endTime"]');
            if (endTimeCell) endTimeCell.textContent = originalData.endTime;
            
            const breakCell = row.querySelector('[data-field="break"]');
            if (breakCell) breakCell.textContent = originalData.break;
            
            const statusSelect = row.querySelector('.status-select');
            if (statusSelect) statusSelect.value = originalData.status;
            
            if (originalData.isWorking) {
                row.classList.add('working');
            } else {
                row.classList.remove('working');
            }
            
            row.classList.remove('confirmed');
            
            const confirmBtn = row.querySelector('.row-confirm-btn');
            if (confirmBtn) {
                confirmBtn.innerHTML = 'âœ“';
                confirmBtn.title = 'ã“ã®è¡Œã‚’ç¢ºå®š';
                confirmBtn.style.background = '';
            }
            
            updateRowCalculations();
            
            row.style.background = 'rgba(33, 150, 243, 0.1)';
            setTimeout(() => {
                row.style.background = '';
            }, 1500);
            
            showStatus('è¡Œã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
        }

        function parseTime(timeStr) {
            if (!timeStr || timeStr === '' || timeStr === 'ï¼š' || timeStr === 'ã€€ï¼šã€€') {
                return null;
            }
            
            if (typeof timeStr === 'number') {
                if (timeStr < 1) {
                    return (timeStr * 24) % 24;
                } else if (timeStr > 40000) {
                    const timePart = timeStr % 1;
                    return (timePart * 24) % 24;
                } else {
                    return timeStr % 24;
                }
            }
            
            const timeString = timeStr.toString().trim();
            
            if (timeString === '' || timeString === 'ï¼š' || timeString === 'ã€€ï¼šã€€') {
                return null;
            }
            
            const cleanTimeStr = timeString.replace(/[ï¼š\s]/g, ':');
            
            if (cleanTimeStr.includes(':')) {
                const parts = cleanTimeStr.split(':');
                const hours = parseInt(parts[0]) || 0;
                const minutes = parseInt(parts[1]) || 0;
                return (hours % 24) + minutes / 60;
            } else {
                const numValue = parseFloat(cleanTimeStr) || 0;
                return numValue % 24;
            }
        }

        function calculateWorkHours(startTime, endTime, breakTime) {
            if (startTime === null || endTime === null) {
                return 0;
            }
            
            let workHours;
            
            if (isNightShift) {
                if (endTime < startTime) {
                    workHours = (24 + endTime) - startTime;
                } else {
                    workHours = endTime - startTime;
                }
            } else {
                if (endTime < startTime) {
                    workHours = endTime - startTime + 24;
                } else {
                    workHours = endTime - startTime;
                }
            }
            
            if (breakTime !== null && breakTime > 0) {
                workHours -= breakTime;
            }
            
            return Math.max(0, workHours);
        }

        function calculateNightShiftHours(startTime, endTime, breakTime) {
            if (startTime === null || endTime === null) {
                return 0;
            }
            
            const nightStart = 22.0;
            const nightEnd = 5.0;
            let nightHours = 0;
            
            if (endTime < startTime) {
                if (startTime <= nightStart) {
                    nightHours += (24 - nightStart);
                } else if (startTime < 24) {
                    nightHours += (24 - startTime);
                }
                
                if (endTime >= nightEnd) {
                    nightHours += nightEnd;
                } else if (endTime > 0) {
                    nightHours += endTime;
                }
            } else {
                const shiftStart = Math.max(startTime, nightStart);
                const shiftEnd = Math.min(endTime, 24);
                
                if (shiftStart < shiftEnd) {
                    nightHours += (shiftEnd - shiftStart);
                }
                
                if (startTime < nightEnd) {
                    const earlyStart = Math.max(startTime, 0);
                    const earlyEnd = Math.min(endTime, nightEnd);
                    if (earlyStart < earlyEnd) {
                        nightHours += (earlyEnd - earlyStart);
                    }
                }
            }
            
            if (nightHours > 0 && breakTime !== null && breakTime > 0) {
                const breakAdjustment = Math.min(breakTime, nightHours);
                nightHours = Math.max(0, nightHours - breakAdjustment);
            }
            
            return Math.max(0, nightHours);
        }

        function updatePlan(value) {
            planValue = parseFloat(value) || 12200;
            updateCalculations(getCurrentTableData());
        }

        function updateUPH(value) {
            const newUPH = parseFloat(value) || 22;
            if (newUPH !== baseUPH) {
                baseUPH = newUPH;
                isUPHAutoExtracted = false;
                updateCalculations(getCurrentTableData());
                showStatus(`åŸºæº–UPHã‚’ ${baseUPH} ã«æ‰‹å‹•å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
            }
        }

        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type} show`;
            
            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 3000);
        }

        function showServerInstructions() {
            const instructions = `
ğŸš€ ãƒ­ãƒ¼ã‚«ãƒ«Webã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•æ–¹æ³•

ã€Pythonï¼ˆæ¨å¥¨ï¼‰ã€‘
1. ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã§ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ/ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã
2. å®Ÿè¡Œ: python -m http.server 8000
3. ãƒ–ãƒ©ã‚¦ã‚¶ã§: http://localhost:8000

ã€Node.jsã€‘
1. å®Ÿè¡Œ: npx http-server
2. ãƒ–ãƒ©ã‚¦ã‚¶ã§: http://localhost:8080

ã€VS Codeã€‘
1. Live Serveræ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ "Open with Live Server"

ã€PHPã€‘
1. å®Ÿè¡Œ: php -S localhost:8000
2. ãƒ–ãƒ©ã‚¦ã‚¶ã§: http://localhost:8000

ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾Œã€http://localhost:8000/test.html ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
`;
            
            alert(instructions);
        }

        function generateAttendanceCheck() {
            if (!document.querySelector('.shift-table')) {
                showStatus('ã‚·ãƒ•ãƒˆè¡¨ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const targetDate = document.getElementById('targetDate').value;
                const selectedSheet = document.getElementById('sheetSelect').value;
                const dateObj = new Date(targetDate);
                const formattedDate = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ ${selectedSheet}ã‚·ãƒ•ãƒˆè¡¨`;

                const attendanceData = [];
                const rows = document.querySelectorAll('#shiftTable tbody tr');
                
                rows.forEach(row => {
                    const statusSelect = row.querySelector('.status-select');
                    const status = statusSelect ? statusSelect.value : '';
                    
                    if (status === 'â—¯') {
                        const cells = row.querySelectorAll('td');
                        const getData = (index) => cells[index] ? cells[index].textContent.trim() : '';
                        
                        const companyName = getData(0);
                        if (!companyName.trim()) return;
                        
                        attendanceData.push({
                            company: companyName,
                            timeSlot: '',
                            mainJob: getData(2),
                            name: getData(3),
                            startTime: ':',
                            endTime: ':',
                            break: ':',
                            healthCheck: '',
                            heatstrokeCheck: '',
                            memo: ''
                        });
                    }
                });

                const calculationData = {
                    totalHC: attendanceData.length,
                    totalLH: parseFloat(document.querySelector('.calc-value')?.textContent) || 0,
                    forecast: fcstValue,
                    planValue: planValue,
                    baseUPH: baseUPH
                };

                const attendanceHTML = createAttendanceHTML(formattedDate, attendanceData, calculationData);
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(attendanceHTML);
                printWindow.document.close();
                
                showStatus('å‡ºé€€å‹¤ç¢ºèªè¡¨ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('å‡ºé€€å‹¤ç¢ºèªè¡¨ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus('å‡ºé€€å‹¤ç¢ºèªè¡¨ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function createAttendanceHTML(dateTitle, data, calculationData) {
            return `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºé€€å‹¤ç¢ºèªè¡¨</title>
    <style>
        @media print { body { margin: 0; } .no-print { display: none; } }
        body { font-family: 'Yu Gothic', 'Meiryo', sans-serif; margin: 15px; background-color: white; font-size: 12px; line-height: 1.2; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .header h1 { margin: 0; font-size: 20px; font-weight: bold; line-height: 1.3; }
        .attendance-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; line-height: 1.1; }
        .attendance-table th, .attendance-table td { border: 1px solid #333; padding: 4px 6px; text-align: center; vertical-align: middle; line-height: 1.1; }
        .attendance-table th { background-color: #f0f0f0; font-weight: bold; font-size: 11px; padding: 5px 6px; }
        .attendance-table td { height: 20px; padding: 3px 6px; }
        .name-cell { text-align: left; padding-left: 8px; min-width: 100px; }
        .company-cell { text-align: left; padding-left: 8px; min-width: 70px; }
        .job-cell { text-align: left; padding-left: 8px; min-width: 85px; }
        .time-cell { width: 55px; font-size: 14px; font-weight: bold; padding: 3px 4px; }
        .memo-cell { width: 100px; padding: 3px 4px; }
        .layer-cell { width: 45px; padding: 3px 4px; }
        .health-cell { width: 60px; padding: 3px 4px; font-size: 10px; }
        .heatstroke-cell { width: 65px; padding: 3px 4px; font-size: 10px; }
        .print-buttons { margin: 15px 0; text-align: center; }
        .print-btn { background-color: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 0 8px; }
        .print-btn:hover { background-color: #45a049; }
        .pdf-btn { background-color: #2196F3; } .pdf-btn:hover { background-color: #1976D2; }
    </style>
</head>
<body>
    <div class="print-buttons no-print">
        <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
        <button class="print-btn pdf-btn" onclick="window.print()">ğŸ“„ PDFä¿å­˜</button>
        <button class="print-btn" onclick="window.close()" style="background-color: #FF5722;">âŒ é–‰ã˜ã‚‹</button>
    </div>
    <div class="header">
        <h1>${dateTitle}</h1>
        <p style="margin: 8px 0 0 0; font-size: 13px;">å‡ºé€€å‹¤ç¢ºèªè¡¨ï¼ˆåŸºæº–UPH: ${calculationData.baseUPH}ï¼‰</p>
    </div>
    <table class="attendance-table">
        <thead>
            <tr><th>ä¼šç¤¾å</th><th>éšå±¤</th><th>ãƒ¡ã‚¤ãƒ³æ¥­å‹™</th><th>æ°å</th><th>é–‹å§‹æ™‚é–“</th><th>çµ‚äº†æ™‚é–“</th><th>ä¼‘æ†©</th><th>è‡ªå·±ç”³å‘Š<br>ä½“èª¿</th><th>ç†±ä¸­ç—‡<br>å¯¾ç­–ç¢ºèª</th><th>å‚™è€ƒ</th></tr>
        </thead>
        <tbody>
            ${data.map(emp => `<tr><td class="company-cell">${emp.company}</td><td class="layer-cell">${emp.timeSlot}</td><td class="job-cell">${emp.mainJob}</td><td class="name-cell">${emp.name}</td><td class="time-cell">${emp.startTime}</td><td class="time-cell">${emp.endTime}</td><td class="time-cell">${emp.break}</td><td class="health-cell">&nbsp;</td><td class="heatstroke-cell">&nbsp;</td><td class="memo-cell">${emp.memo}</td></tr>`).join('')}
            ${Array.from({length: Math.max(0, 20 - data.length)}, () => `<tr><td class="company-cell">&nbsp;</td><td class="layer-cell">&nbsp;</td><td class="job-cell">&nbsp;</td><td class="name-cell">&nbsp;</td><td class="time-cell">:</td><td class="time-cell">:</td><td class="time-cell">:</td><td class="health-cell">&nbsp;</td><td class="heatstroke-cell">&nbsp;</td><td class="memo-cell">&nbsp;</td></tr>`).join('')}
        </tbody>
    </table>
    <div style="margin-top: 20px; text-align: right; font-size: 11px; line-height: 1.3;"><p>è²¬ä»»è€…ç¢ºèªï¼š_________________ã€€ã€€æ—¥ä»˜ï¼š_______________</p></div>
</body>
</html>`;
        }

        function sendToViewer() {
            if (!document.querySelector('.shift-table')) {
                showStatus('é€ä¿¡ã™ã‚‹ã‚·ãƒ•ãƒˆè¡¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const currentData = getCurrentTableData();
                const targetDate = document.getElementById('targetDate').value;
                const selectedSheet = document.getElementById('sheetSelect').value;
                
                const transferData = {
                    employeeData: currentData.map(emp => ({
                        'ä¼šç¤¾å': emp.company || '',
                        'æ™‚é–“å¸¯': emp.timeSlot || '',
                        'ãƒ¡ã‚¤ãƒ³æ¥­å‹™': emp.mainJob || '',
                        'æ°å': emp.name || '',
                        'æ€§åˆ¥': emp.gender || '',
                        'æ™‚çµ¦': emp.hourlyWage || '',
                        'äº¤é€šè²»': emp.transportation || '',
                        'é–‹å§‹æ™‚é–“': emp.startTime || '',
                        'çµ‚äº†æ™‚é–“': emp.endTime || '',
                        'ä¼‘æ†©': emp.break || '',
                        'å‹¤å‹™çŠ¶æ³': emp.status || '',
                        'å‹¤å‹™LH': calculateDisplayLH(emp),
                        'å¤œå‹¤æ™‚é–“': calculateDisplayNightHours(emp),
                        'æ®‹æ¥­æ™‚é–“': calculateDisplayOvertimeHours(emp)
                    })),
                    shiftTitle: `${new Date(targetDate).toLocaleDateString('ja-JP')}æ—¥ ${selectedSheet}ã‚·ãƒ•ãƒˆè¡¨`,
                    isNightShift: isNightShift,
                    baseUPH: baseUPH,
                    planValue: planValue,
                    fcstValue: fcstValue,
                    transferTimestamp: Date.now(),
                    protocol: window.location.protocol
                };

                console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', transferData);

                const isFileProtocol = window.location.protocol === 'file:';
                
                if (isFileProtocol) {
                    localStorage.setItem('shiftDataTransfer', JSON.stringify(transferData));
                    localStorage.setItem('shiftDataTransfer_timestamp', Date.now().toString());
                    console.log('file://ãƒ—ãƒ­ãƒˆã‚³ãƒ«æ¤œå‡º: localStorageã«ä¿å­˜ã—ã¾ã—ãŸ');
                } else {
                    localStorage.setItem('shiftDataTransfer', JSON.stringify(transferData));
                }

                const windowFeatures = isFileProtocol ? 
                    'width=1200,height=800,scrollbars=yes,resizable=yes,location=yes' :
                    'width=1200,height=800,scrollbars=yes,resizable=yes';
                    
                const viewerWindow = window.open('./viewer.html', '_blank', windowFeatures);
                
                if (!viewerWindow) {
                    showStatus('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                let attempts = 0;
                const maxAttempts = isFileProtocol ? 20 : 50;
                const attemptInterval = isFileProtocol ? 1000 : 200;
                
                const sendData = () => {
                    attempts++;
                    
                    try {
                        if (viewerWindow.closed) {
                            console.log('ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ');
                            return;
                        }

                        viewerWindow.postMessage({
                            type: 'SHIFT_DATA_TRANSFER',
                            data: transferData
                        }, '*');
                        
                        console.log(`ãƒ‡ãƒ¼ã‚¿é€ä¿¡è©¦è¡Œ ${attempts}å›ç›® (${window.location.protocol})`);
                        
                    } catch (error) {
                        console.error(`é€ä¿¡ã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ${attempts}å›ç›®):`, error);
                    }
                };

                if (isFileProtocol) {
                    showStatus('ãƒ“ãƒ¥ãƒ¼ã‚¢ã‚’é–‹ãã¾ã—ãŸï¼ˆlocalStorageã§ãƒ‡ãƒ¼ã‚¿è»¢é€ï¼‰', 'success');
                    
                    setTimeout(() => {
                        for (let i = 0; i < 5; i++) {
                            setTimeout(sendData, i * 2000);
                        }
                    }, 1000);
                    
                } else {
                    let loadCheckInterval;
                    let isDataSent = false;

                    const checkAndSend = () => {
                        if (isDataSent || viewerWindow.closed) {
                            if (loadCheckInterval) clearInterval(loadCheckInterval);
                            return;
                        }

                        try {
                            if (viewerWindow.document && 
                                (viewerWindow.document.readyState === 'complete' || 
                                 viewerWindow.document.readyState === 'interactive')) {
                                
                                if (loadCheckInterval) clearInterval(loadCheckInterval);
                                isDataSent = true;
                                
                                setTimeout(() => {
                                    sendData();
                                    
                                    const retryInterval = setInterval(() => {
                                        if (attempts >= maxAttempts || viewerWindow.closed) {
                                            clearInterval(retryInterval);
                                            return;
                                        }
                                        sendData();
                                    }, attemptInterval);
                                    
                                    setTimeout(() => {
                                        clearInterval(retryInterval);
                                    }, 10000);
                                    
                                }, 800);
                            }
                        } catch (e) {
                            // ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦ç¶šè¡Œ
                        }
                    };

                    loadCheckInterval = setInterval(checkAndSend, 100);
                    setTimeout(checkAndSend, 500);
                    
                    setTimeout(() => {
                        if (!isDataSent && !viewerWindow.closed) {
                            console.log('å¼·åˆ¶é€ä¿¡ã‚’å®Ÿè¡Œ');
                            isDataSent = true;
                            if (loadCheckInterval) clearInterval(loadCheckInterval);
                            sendData();
                        }
                    }, 3000);

                    showStatus('ãƒ“ãƒ¥ãƒ¼ã‚¢ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã„ã¦ã„ã¾ã™...', 'success');
                }

                const confirmationListener = (event) => {
                    if (event.data && event.data.type === 'DATA_RECEIVED_CONFIRMATION') {
                        showStatus('ãƒ‡ãƒ¼ã‚¿è»¢é€ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                        window.removeEventListener('message', confirmationListener);
                        localStorage.removeItem('shiftDataTransfer');
                        localStorage.removeItem('shiftDataTransfer_timestamp');
                    }
                };
                
                window.addEventListener('message', confirmationListener);
                
                setTimeout(() => {
                    window.removeEventListener('message', confirmationListener);
                }, 15000);

            } catch (error) {
                console.error('ãƒ“ãƒ¥ãƒ¼ã‚¢è»¢é€ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ãƒ“ãƒ¥ãƒ¼ã‚¢ã¸ã®è»¢é€ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function calculateDisplayLH(emp) {
            if (!emp.isWorking) return '';
            const startTime = parseTime(emp.startTime);
            const endTime = parseTime(emp.endTime);
            const breakTime = parseTime(emp.break);
            if (startTime === null || endTime === null) return '';
            const workHours = calculateWorkHours(startTime, endTime, breakTime);
            return workHours > 0 ? workHours.toFixed(2) : '';
        }

        function calculateDisplayNightHours(emp) {
            if (!emp.isWorking) return '';
            const startTime = parseTime(emp.startTime);
            const endTime = parseTime(emp.endTime);
            const breakTime = parseTime(emp.break);
            if (startTime === null || endTime === null) return '';
            const nightHours = calculateNightShiftHours(startTime, endTime, breakTime);
            return nightHours > 0 ? nightHours.toFixed(2) : '';
        }

        function calculateDisplayOvertimeHours(emp) {
            if (!emp.isWorking) return '';
            const startTime = parseTime(emp.startTime);
            const endTime = parseTime(emp.endTime);
            const breakTime = parseTime(emp.break);
            if (startTime === null || endTime === null) return '';
            const workHours = calculateWorkHours(startTime, endTime, breakTime);
            const overtimeHours = Math.max(0, workHours - 8);
            return overtimeHours > 0 ? overtimeHours.toFixed(2) : '';
        }
    </script>
</body>
</html>
