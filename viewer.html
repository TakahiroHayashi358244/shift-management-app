<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ v1.1 - ç·¨é›†ãƒ»åˆ†æå¯¾å¿œ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a6fd8;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --glass: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        [data-theme="dark"] {
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --glass: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(51, 65, 85, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Noto Sans JP', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .app-container {
            max-width: 95%;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            animation: slideDown 0.6s ease-out;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 2.5rem;
            background: linear-gradient(45deg, var(--accent-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-toggle {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            background: var(--surface);
        }

        .main-content {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            animation: slideUp 0.8s ease-out;
        }

        .calculation-panel {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .calc-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .calc-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .calc-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .calc-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .calc-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .calc-unit {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .calc-input {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            width: 100%;
            max-width: 120px;
            margin: 4px auto;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .table-container {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: auto;
        }

        .table-header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .add-row-btn {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(240, 147, 251, 0.3);
            white-space: nowrap;
        }

        .add-row-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .action-btn {
            background: linear-gradient(45deg, var(--accent-color), var(--primary-color));
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.3);
        }

        .action-btn.primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        }

        .action-btn.success {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
        }

        .action-btn.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .shift-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .shift-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .shift-table th:first-child {
            border-radius: 8px 0 0 8px;
        }

        .shift-table th:last-child {
            border-radius: 0 8px 8px 0;
        }

        .shift-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .shift-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .working {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(139, 195, 74, 0.1)) !important;
        }

        .confirmed {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)) !important;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .editable-cell {
            background: rgba(240, 147, 251, 0.1) !important;
            cursor: text;
            border-radius: 4px;
            transition: all 0.2s ease;
            min-width: 60px;
            position: relative;
        }

        .editable-cell:hover {
            background: rgba(240, 147, 251, 0.2) !important;
        }

        .editable-cell:focus {
            background: var(--surface) !important;
            outline: 2px solid var(--accent-color);
            outline-offset: -2px;
        }

        .time-cell {
            min-width: 80px;
            font-family: 'Courier New', monospace;
            text-align: center;
        }

        .status-cell {
            padding: 6px 8px;
        }

        .status-select {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 70px;
        }

        .status-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(240, 147, 251, 0.2);
        }

        .action-cell {
            padding: 6px 8px;
            text-align: center;
            width: 100px;
        }

        .row-reset-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 28px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            margin-right: 4px;
        }

        .row-reset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .row-confirm-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 28px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .row-confirm-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, #43A047 0%, #2E7D32 100%);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.5s ease;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loading-detail {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .status-message.show {
            transform: translateX(0);
        }

        .status-message.status-success {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
        }

        .status-message.status-error {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .status-message.status-warning {
            background: linear-gradient(45deg, #FF9800, #FFC107);
        }

        .hidden {
            display: none !important;
        }

        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                padding: 12px;
            }

            .header, .main-content {
                padding: 20px;
                border-radius: 16px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .logo {
                font-size: 2rem;
            }

            .title {
                font-size: 1.5rem;
            }

            .calc-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }

            .table-header-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .shift-table {
                font-size: 0.8rem;
            }

            .shift-table th,
            .shift-table td {
                padding: 8px 6px;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .header-actions,
            .action-buttons,
            .theme-toggle,
            .row-reset-btn,
            .row-confirm-btn,
            .add-row-btn,
            .table-header-actions {
                display: none;
            }

            .main-content {
                background: white;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢</div>
        <div class="loading-detail">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">ğŸ“Š</div>
                    <div>
                        <h1 class="title">ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
                        <p class="subtitle">Professional Shift Viewer v1.1 - ç·¨é›†ãƒ»åˆ†æå¯¾å¿œï¼ˆä¼šç¤¾åˆ¥é›†è¨ˆæ”¹è‰¯ç‰ˆï¼‰</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="toggleTheme()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
                        <span id="themeIcon">ğŸŒ™</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <div class="calculation-panel hidden" id="calculationPanel">
                <div class="calc-header">
                    <div style="font-size: 2rem;">ğŸ“ˆ</div>
                    <div>
                        <h3>LHè¨ˆç®—ãƒ»åˆ†æ</h3>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px;" id="shiftTitle">
                            åŠ´åƒæ™‚é–“ã¨ç”Ÿç”£æ€§ã®è©³ç´°åˆ†æï¼ˆå¤œå‹¤æ‰‹å½“ãƒ»æ®‹æ¥­ä»£è¾¼ã¿ï¼‰
                        </p>
                    </div>
                </div>
                <div class="calc-grid" id="calcGrid"></div>
            </div>

            <div class="table-container hidden" id="tableContainer">
                <div class="table-header-actions">
                    <button class="add-row-btn" onclick="addNewRow()">
                        â• è¡Œã‚’è¿½åŠ 
                    </button>
                    
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="generateAttendanceCheck()">
                            ğŸ“‹ å‡ºé€€å‹¤ç¢ºèªè¡¨
                        </button>
                        <button class="action-btn" onclick="exportToExcel()">
                            ğŸ“Š è©³ç´°ãƒ‡ãƒ¼ã‚¿
                        </button>
                        <button class="action-btn" onclick="exportCompanySummary()">
                            ğŸ“ˆ ä¼šç¤¾åˆ¥é›†è¨ˆ
                        </button>
                        <button class="action-btn success" onclick="backupData()">
                            ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                        </button>
                        <button class="action-btn danger" onclick="clearData()">
                            ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
                
                <table class="shift-table" id="shiftTable"></table>
            </div>

            <!-- åˆæœŸçŠ¶æ…‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="welcome-message" id="welcomeMessage">
                <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                    <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.7;">ğŸ“Š</div>
                    <h3 style="color: var(--text-primary); margin-bottom: 12px;">ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ã¸ã‚ˆã†ã“ã</h3>
                    <p style="line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‹ã‚‰ã€ŒğŸš€ ãƒ“ãƒ¥ãƒ¼ã‚¢ã§ç·¨é›†ã€ãƒœã‚¿ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ã¨ã€<br>
                        ã“ã“ã«ã‚·ãƒ•ãƒˆè¡¨ãŒè¡¨ç¤ºã•ã‚Œã€ç·¨é›†ãƒ»åˆ†æãŒã§ãã¾ã™ã€‚
                    </p>
                    <div style="margin-top: 30px; padding: 20px; background: var(--surface); border-radius: 12px; border: 1px solid var(--border);">
                        <h4 style="color: var(--text-primary); margin-bottom: 12px;">ğŸ“¡ ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ–¹å¼</h4>
                        <div style="font-size: 0.9rem; line-height: 1.5;">
                            â€¢ <strong>PostMessage</strong>: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è»¢é€ï¼ˆæ¨å¥¨ï¼‰<br>
                            â€¢ <strong>localStorage</strong>: ãƒ–ãƒ©ã‚¦ã‚¶ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜<br>
                            â€¢ ä¸¡æ–¹å¯¾å¿œã§ç¢ºå®Ÿãªãƒ‡ãƒ¼ã‚¿è»¢é€ã‚’å®Ÿç¾
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 12px; border: 1px solid var(--border);">
                        <h4 style="color: var(--text-primary); margin-bottom: 8px;">ğŸ¯ v1.1 æ–°æ©Ÿèƒ½</h4>
                        <div style="font-size: 0.9rem; line-height: 1.4;">
                            <strong>ä¼šç¤¾åˆ¥é›†è¨ˆã®æ”¹è‰¯</strong><br>
                            â€¢ å…¨ä¼šç¤¾ã‚’å›ºå®šé †åºã§è¡¨ç¤º<br>
                            â€¢ å‡ºå‹¤ã—ã¦ã„ãªã„ä¼šç¤¾ã¯ç©ºç™½ã§è¡¨ç¤º<br>
                            â€¢ æ—¥åˆ¥æ¯”è¼ƒãŒå®¹æ˜“ã«
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Message -->
    <div class="status-message" id="statusMessage"></div>

    <script>
        // Global variables
        let shiftData = null;
        let baseUPH = 22;
        let planValue = 12200;
        let fcstValue = 16273;
        let isNightShift = false;
        let originalShiftData = [];
        let allCompanies = []; // å…¨ä¼šç¤¾ãƒªã‚¹ãƒˆ

        // App initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== ã‚·ãƒ•ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢åˆæœŸåŒ–é–‹å§‹ ===');
            
            setTimeout(() => {
                initializeViewer();
            }, 1000);
            
            loadTheme();
            setupPostMessageListener();
            checkForStoredData();
        });

        function initializeViewer() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.style.opacity = '0';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
            
            updateStatusIndicator('åˆæœŸåŒ–å®Œäº† - ãƒ‡ãƒ¼ã‚¿å¾…æ©Ÿä¸­', 'success');
            
            // å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
            setInterval(checkForStoredData, 2000);
        }

        // PostMessage listener setup
        function setupPostMessageListener() {
            window.addEventListener('message', function(event) {
                console.log('PostMessageå—ä¿¡:', event);
                
                if (event.data && event.data.type === 'SHIFT_DATA_TRANSFER') {
                    console.log('ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿å—ä¿¡:', event.data.data);
                    processReceivedData(event.data.data);
                    updateStatusIndicator('PostMessageã§ãƒ‡ãƒ¼ã‚¿å—ä¿¡æˆåŠŸ', 'success');
                    
                    // é€ä¿¡å…ƒã«ç¢ºèªã‚’è¿”ã™
                    if (event.source) {
                        try {
                            event.source.postMessage({
                                type: 'DATA_RECEIVED_CONFIRMATION',
                                success: true
                            }, '*');
                        } catch (error) {
                            console.error('ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                        }
                    }
                }
            });
            
            console.log('PostMessageãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
        }

        // Check for stored data in localStorage
        function checkForStoredData() {
            try {
                const storedData = localStorage.getItem('shiftDataTransfer');
                if (storedData) {
                    console.log('localStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹');
                    const data = JSON.parse(storedData);
                    processReceivedData(data);
                    updateStatusIndicator('localStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ', 'success');
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨å¾Œå‰Šé™¤
                    localStorage.removeItem('shiftDataTransfer');
                    localStorage.removeItem('shiftDataTransfer_timestamp');
                }
            } catch (error) {
                console.error('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                updateStatusIndicator('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // Process received shift data
        function processReceivedData(data) {
            if (!data || !data.employeeData) {
                console.error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼:', data);
                updateStatusIndicator('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼', 'error');
                return;
            }

            shiftData = data;
            baseUPH = data.baseUPH || 22;
            planValue = data.planValue || 12200;
            fcstValue = data.fcstValue || 16273;
            isNightShift = data.isNightShift || false;

            // Convert data format to internal structure
            const convertedData = data.employeeData.map(emp => ({
                company: emp['ä¼šç¤¾å'] || '',
                timeSlot: emp['æ™‚é–“å¸¯'] || '',
                mainJob: emp['ãƒ¡ã‚¤ãƒ³æ¥­å‹™'] || '',
                name: emp['æ°å'] || '',
                gender: emp['æ€§åˆ¥'] || '',
                hourlyWage: emp['æ™‚çµ¦'] || '',
                transportation: emp['äº¤é€šè²»'] || '',
                startTime: emp['é–‹å§‹æ™‚é–“'] || '',
                endTime: emp['çµ‚äº†æ™‚é–“'] || '',
                break: emp['ä¼‘æ†©'] || '',
                status: emp['å‹¤å‹™çŠ¶æ³'] || '',
                isWorking: emp['å‹¤å‹™çŠ¶æ³'] === 'â—¯'
            }));

            originalShiftData = JSON.parse(JSON.stringify(convertedData));

            // å…¨ä¼šç¤¾ãƒªã‚¹ãƒˆã‚’æŠ½å‡º
            extractAllCompanies(convertedData);

            // Hide welcome message and show data
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('calculationPanel').classList.remove('hidden');
            document.getElementById('tableContainer').classList.remove('hidden');

            // Update shift title
            const titleElement = document.getElementById('shiftTitle');
            if (titleElement && data.shiftTitle) {
                titleElement.textContent = data.shiftTitle;
            }

            // Display data
            updateCalculations(convertedData);
            updateTable(convertedData);

            updateStatusIndicator(`ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå®Œäº† (${convertedData.length}ä»¶)`, 'success');
            showStatus('ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ', 'success');
        }

        // å…¨ä¼šç¤¾ãƒªã‚¹ãƒˆã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
        function extractAllCompanies(data) {
            const companiesSet = new Set();
            
            const excludeKeywords = [
                'PLAN', 'FCST', 'UPH', 'HC', 'LH', 
                'å‡ºå‹¤HC', 'å‡ºå‹¤LH', 'å¿…è¦LH', 'éä¸è¶³', 'HCæ›ç®—',
                'å¤œå‹¤æ‰‹å½“', 'æ®‹æ¥­æ‰‹å½“', 'ç·è²»ç”¨', 'å¹³å‡å˜ä¾¡',
                'å®Ÿç¸¾UPH', 'åŸºæº–UPH', 'FCSTæ•°é‡', 'PLANæ•°é‡'
            ];
            
            data.forEach(emp => {
                const companyName = emp.company ? emp.company.trim() : '';
                
                // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
                const shouldExclude = excludeKeywords.some(keyword => 
                    companyName.includes(keyword)
                );
                
                if (shouldExclude) return;
                if (!companyName) return;
                if (/^\d+$/.test(companyName)) return; // æ•°å­—ã®ã¿ã¯é™¤å¤–
                
                companiesSet.add(companyName);
            });
            
            // Gworkerã‚’æœ€åˆã«ã€ãã®å¾Œã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ãƒ»ã‚ã„ã†ãˆãŠé †ã§ã‚½ãƒ¼ãƒˆ
            allCompanies = Array.from(companiesSet).sort((a, b) => {
                if (a === 'Gworker') return -1;
                if (b === 'Gworker') return 1;
                return a.localeCompare(b, 'ja');
            });
            
            console.log('æŠ½å‡ºã•ã‚ŒãŸå…¨ä¼šç¤¾ãƒªã‚¹ãƒˆ:', allCompanies);
        }

        // Update status indicator (now just console logging)
        function updateStatusIndicator(message, type) {
            console.log(`[${type.toUpperCase()}] ${new Date().toLocaleTimeString()}: ${message}`);
        }

        // Theme management
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = 'â˜€ï¸';
            }
        }

        // Calculation functions (similar to main app)
        function updateCalculations(data) {
            const calcGrid = document.getElementById('calcGrid');
            
            let totalLH = 0;
            let totalCost = 0;
            let totalNightAllowance = 0;
            let totalOvertimeAllowance = 0;
            let workingCount = 0;
            
            data.forEach(emp => {
                if (emp.isWorking) {
                    workingCount++;
                    
                    const startTime = parseTime(emp.startTime);
                    const endTime = parseTime(emp.endTime);
                    const breakTime = parseTime(emp.break);
                    
                    const hourlyWageStr = emp.hourlyWage != null ? String(emp.hourlyWage) : '0';
                    const transportationStr = emp.transportation != null ? String(emp.transportation) : '0';
                    
                    const hourlyWage = parseFloat(hourlyWageStr.replace(/[^\d.]/g, '')) || 0;
                    const transportation = parseFloat(transportationStr.replace(/[^\d.]/g, '')) || 0;
                    
                    if (startTime !== null && endTime !== null) {
                        const workHours = calculateWorkHours(startTime, endTime, breakTime);
                        const nightHours = calculateNightShiftHours(startTime, endTime, breakTime);
                        const overtimeHours = Math.max(0, workHours - 8);
                        
                        totalLH += workHours;
                        
                        const regularHours = Math.max(0, workHours - overtimeHours);
                        const baseCost = regularHours * hourlyWage;
                        const overtimeBaseCost = overtimeHours * hourlyWage;
                        const nightAllowance = nightHours * hourlyWage * 0.25;
                        totalNightAllowance += nightAllowance;
                        const overtimeAllowance = overtimeHours * hourlyWage * 0.25;
                        totalOvertimeAllowance += overtimeAllowance;
                        
                        totalCost += baseCost + overtimeBaseCost + nightAllowance + overtimeAllowance + transportation;
                    } else {
                        totalCost += transportation;
                    }
                }
            });
            
            const requiredLH = planValue / baseUPH;
            const shortage = totalLH - requiredLH;
            const currentUPH = totalLH > 0 ? planValue / totalLH : 0;
            const hcConversion = shortage / 8;
            const averageHourlyCost = totalLH > 0 ? totalCost / totalLH : 0;
            
            calcGrid.innerHTML = `
                <div class="calc-card">
                    <div class="calc-label">FCSTæ•°é‡</div>
                    <div class="calc-value">${fcstValue.toLocaleString()}</div>
                    <div class="calc-unit">å€‹</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å‡ºå‹¤HC</div>
                    <div class="calc-value">${workingCount}</div>
                    <div class="calc-unit">äºº</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å‡ºå‹¤LH</div>
                    <div class="calc-value">${totalLH.toFixed(1)}</div>
                    <div class="calc-unit">æ™‚é–“</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å¹³å‡å˜ä¾¡</div>
                    <div class="calc-value">Â¥${Math.round(averageHourlyCost).toLocaleString()}</div>
                    <div class="calc-unit">å††/æ™‚</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">PLANæ•°é‡</div>
                    <input type="number" class="calc-input" value="${planValue}" onchange="updatePlan(this.value)">
                    <div class="calc-unit">å€‹</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">åŸºæº–UPH</div>
                    <input type="number" class="calc-input" value="${baseUPH}" onchange="updateUPH(this.value)" step="0.1">
                    <div class="calc-unit">å€‹/æ™‚</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å¿…è¦LH</div>
                    <div class="calc-value">${requiredLH.toFixed(1)}</div>
                    <div class="calc-unit">æ™‚é–“</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å®Ÿç¸¾UPH</div>
                    <div class="calc-value" style="color: ${currentUPH >= baseUPH ? '#4CAF50' : '#f44336'}">${Math.round(currentUPH)}</div>
                    <div class="calc-unit">å€‹/æ™‚</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">éä¸è¶³</div>
                    <div class="calc-value" style="color: ${shortage >= 0 ? '#4CAF50' : '#f44336'}">${shortage.toFixed(1)}</div>
                    <div class="calc-unit">æ™‚é–“</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">HCæ›ç®—</div>
                    <div class="calc-value">${hcConversion.toFixed(1)}</div>
                    <div class="calc-unit">äºº</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">å¤œå‹¤æ‰‹å½“</div>
                    <div class="calc-value">Â¥${Math.round(totalNightAllowance).toLocaleString()}</div>
                    <div class="calc-unit">å†† (22-5æ™‚)</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">æ®‹æ¥­æ‰‹å½“</div>
                    <div class="calc-value">Â¥${Math.round(totalOvertimeAllowance).toLocaleString()}</div>
                    <div class="calc-unit">å†† (8hè¶…)</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">ç·è²»ç”¨</div>
                    <div class="calc-value">Â¥${Math.round(totalCost).toLocaleString()}</div>
                    <div class="calc-unit">å†† (æ‰‹å½“è¾¼)</div>
                </div>
            `;
        }

        function updateTable(data) {
            const table = document.getElementById('shiftTable');
            
            const headers = ['ä¼šç¤¾å', 'æ™‚é–“å¸¯', 'ãƒ¡ã‚¤ãƒ³æ¥­å‹™', 'æ°å', 'æ€§åˆ¥', 'æ™‚çµ¦', 'äº¤é€šè²»', 'é–‹å§‹æ™‚é–“', 'çµ‚äº†æ™‚é–“', 'ä¼‘æ†©', 'å‹¤å‹™çŠ¶æ³', 'å‹¤å‹™LH', 'å¤œå‹¤H', 'æ®‹æ¥­H', 'æ“ä½œ'];
            
            let tableHTML = '<thead><tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            data.forEach((emp, index) => {
                const startTime = parseTime(emp.startTime);
                const endTime = parseTime(emp.endTime);
                const breakTime = parseTime(emp.break);
                
                const workHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateWorkHours(startTime, endTime, breakTime) : 0;
                const nightHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateNightShiftHours(startTime, endTime, breakTime) : 0;
                const overtimeHours = emp.isWorking ? Math.max(0, workHours - 8) : 0;
                
                const statusOptions = ['â—¯', 'æ¬ å‹¤', 'æœ‰ä¼‘'];
                let statusSelect = '<select class="status-select" data-row-index="' + index + '" data-field="status">';
                statusOptions.forEach(option => {
                    const selected = emp.status === option ? ' selected' : '';
                    statusSelect += `<option value="${option}"${selected}>${option}</option>`;
                });
                statusSelect += '</select>';
                
                tableHTML += `
                    <tr class="${emp.isWorking ? 'working' : ''}" data-row-index="${index}">
                        <td class="editable-cell" contenteditable="true" data-field="company">${emp.company}</td>
                        <td class="editable-cell" contenteditable="true" data-field="timeSlot">${emp.timeSlot}</td>
                        <td class="editable-cell" contenteditable="true" data-field="mainJob">${emp.mainJob}</td>
                        <td class="editable-cell" contenteditable="true" data-field="name">${emp.name}</td>
                        <td class="editable-cell" contenteditable="true" data-field="gender">${emp.gender}</td>
                        <td class="editable-cell" contenteditable="true" data-field="hourlyWage">${emp.hourlyWage}</td>
                        <td class="editable-cell" contenteditable="true" data-field="transportation">${emp.transportation}</td>
                        <td class="editable-cell time-cell" contenteditable="true" data-field="startTime">${emp.startTime}</td>
                        <td class="editable-cell time-cell" contenteditable="true" data-field="endTime">${emp.endTime}</td>
                        <td class="editable-cell time-cell" contenteditable="true" data-field="break">${emp.break}</td>
                        <td class="status-cell">${statusSelect}</td>
                        <td>${workHours > 0 ? workHours.toFixed(2) : ''}</td>
                        <td>${nightHours > 0 ? nightHours.toFixed(2) : ''}</td>
                        <td>${overtimeHours > 0 ? overtimeHours.toFixed(2) : ''}</td>
                        <td class="action-cell">
                            <button class="row-reset-btn" onclick="resetRow(${index})" title="ã“ã®è¡Œã‚’ãƒªã‚»ãƒƒãƒˆ">â†º</button>
                            <button class="row-confirm-btn" onclick="confirmRow(${index})" title="ã“ã®è¡Œã‚’ç¢ºå®š">âœ“</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
            
            addEditListeners();
        }

        // Copy utility functions from main app
        function parseTime(timeStr) {
            if (!timeStr || timeStr === '' || timeStr === 'ï¼š' || timeStr === 'ã€€ï¼šã€€') {
                return null;
            }
            
            if (typeof timeStr === 'number') {
                if (timeStr < 1) {
                    return (timeStr * 24) % 24;
                } else if (timeStr > 40000) {
                    const timePart = timeStr % 1;
                    return (timePart * 24) % 24;
                } else {
                    return timeStr % 24;
                }
            }
            
            const timeString = timeStr.toString().trim();
            if (timeString === '' || timeString === 'ï¼š' || timeString === 'ã€€ï¼šã€€') {
                return null;
            }
            
            const cleanTimeStr = timeString.replace(/[ï¼š\s]/g, ':');
            
            if (cleanTimeStr.includes(':')) {
                const parts = cleanTimeStr.split(':');
                const hours = parseInt(parts[0]) || 0;
                const minutes = parseInt(parts[1]) || 0;
                return (hours % 24) + minutes / 60;
            } else {
                const numValue = parseFloat(cleanTimeStr) || 0;
                return numValue % 24;
            }
        }

        function calculateWorkHours(startTime, endTime, breakTime) {
            if (startTime === null || endTime === null) {
                return 0;
            }
            
            let workHours;
            
            if (isNightShift) {
                if (endTime < startTime) {
                    workHours = (24 + endTime) - startTime;
                } else {
                    workHours = endTime - startTime;
                }
            } else {
                if (endTime < startTime) {
                    workHours = endTime - startTime + 24;
                } else {
                    workHours = endTime - startTime;
                }
            }
            
            if (breakTime !== null && breakTime > 0) {
                workHours -= breakTime;
            }
            
            return Math.max(0, workHours);
        }

        function calculateNightShiftHours(startTime, endTime, breakTime) {
            if (startTime === null || endTime === null) {
                return 0;
            }
            
            const nightStart = 22.0;
            const nightEnd = 5.0;
            let nightHours = 0;
            
            if (endTime < startTime) {
                if (startTime <= nightStart) {
                    nightHours += (24 - nightStart);
                } else if (startTime < 24) {
                    nightHours += (24 - startTime);
                }
                
                if (endTime >= nightEnd) {
                    nightHours += nightEnd;
                } else if (endTime > 0) {
                    nightHours += endTime;
                }
            } else {
                const shiftStart = Math.max(startTime, nightStart);
                const shiftEnd = Math.min(endTime, 24);
                
                if (shiftStart < shiftEnd) {
                    nightHours += (shiftEnd - shiftStart);
                }
                
                if (startTime < nightEnd) {
                    const earlyStart = Math.max(startTime, 0);
                    const earlyEnd = Math.min(endTime, nightEnd);
                    if (earlyStart < earlyEnd) {
                        nightHours += (earlyEnd - earlyStart);
                    }
                }
            }
            
            if (nightHours > 0 && breakTime !== null && breakTime > 0) {
                const breakAdjustment = Math.min(breakTime, nightHours);
                nightHours = Math.max(0, nightHours - breakAdjustment);
            }
            
            return Math.max(0, nightHours);
        }

        // Add edit listeners and other functions (similar to main app)
        function addEditListeners() {
            const editableCells = document.querySelectorAll('.editable-cell');
            const statusSelects = document.querySelectorAll('.status-select');
            
            editableCells.forEach(cell => {
                cell.addEventListener('blur', function() {
                    const field = this.getAttribute('data-field');
                    const newValue = this.textContent.trim();
                    
                    if (['hourlyWage', 'transportation'].includes(field)) {
                        const numValue = parseFloat(newValue.replace(/[^\d.]/g, ''));
                        if (!isNaN(numValue) && numValue >= 0) {
                            this.textContent = Math.round(numValue).toString();
                        } else if (newValue === '') {
                            this.textContent = '';
                        } else {
                            showStatus('æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                            return;
                        }
                    }
                    
                    if (['startTime', 'endTime', 'break', 'hourlyWage', 'transportation'].includes(field)) {
                        updateRowCalculations();
                    }
                    
                    this.style.background = 'rgba(240, 147, 251, 0.2)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 1000);
                    
                    showStatus('å¤‰æ›´ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ', 'success');
                });
                
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                    
                    const field = this.getAttribute('data-field');
                    if (['hourlyWage', 'transportation'].includes(field)) {
                        const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
                        if (!allowedKeys.includes(e.key) && !e.ctrlKey && !e.metaKey) {
                            if (!/[0-9.]/.test(e.key)) {
                                e.preventDefault();
                                return false;
                            }
                            if (e.key === '.' && this.textContent.includes('.')) {
                                e.preventDefault();
                                return false;
                            }
                        }
                    }
                });
                
                cell.addEventListener('focus', function() {
                    const field = this.getAttribute('data-field');
                    if (['hourlyWage', 'transportation'].includes(field)) {
                        const range = document.createRange();
                        range.selectNodeContents(this);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });
            });
            
            statusSelects.forEach(select => {
                select.addEventListener('change', function() {
                    const rowIndex = this.getAttribute('data-row-index');
                    const newStatus = this.value;
                    const row = this.closest('tr');
                    
                    if (['æ¬ å‹¤', 'æœ‰ä¼‘'].includes(newStatus)) {
                        const startTimeCell = row.querySelector('[data-field="startTime"]');
                        const endTimeCell = row.querySelector('[data-field="endTime"]');
                        const breakCell = row.querySelector('[data-field="break"]');
                        
                        if (startTimeCell) startTimeCell.textContent = '';
                        if (endTimeCell) endTimeCell.textContent = '';
                        if (breakCell) breakCell.textContent = '';
                        
                        row.classList.remove('working');
                        showStatus(`${newStatus}ã«è¨­å®šã—ã€æ™‚é–“ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`, 'success');
                    } else if (newStatus === 'â—¯') {
                        row.classList.add('working');
                        
                        const startTimeCell = row.querySelector('[data-field="startTime"]');
                        const endTimeCell = row.querySelector('[data-field="endTime"]');
                        const breakCell = row.querySelector('[data-field="break"]');
                        
                        if (startTimeCell && !startTimeCell.textContent.trim()) {
                            startTimeCell.textContent = isNightShift ? '22:00' : '8:00';
                        }
                        if (endTimeCell && !endTimeCell.textContent.trim()) {
                            endTimeCell.textContent = isNightShift ? '7:00' : '17:00';
                        }
                        if (breakCell && !breakCell.textContent.trim()) {
                            breakCell.textContent = '1:00';
                        }
                        
                        showStatus('å‡ºå‹¤ã«è¨­å®šã—ã¾ã—ãŸ', 'success');
                    } else {
                        row.classList.remove('working');
                    }
                    
                    updateRowCalculations();
                    
                    this.style.background = 'rgba(240, 147, 251, 0.2)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 1000);
                });
            });
        }

        function getCurrentTableData() {
            const rows = document.querySelectorAll('#shiftTable tbody tr');
            const data = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const statusSelect = row.querySelector('.status-select');
                const status = statusSelect ? statusSelect.value : '';
                
                const getData = (index) => {
                    return cells[index] ? cells[index].textContent.trim() : '';
                };
                
                data.push({
                    company: getData(0),
                    timeSlot: getData(1),
                    mainJob: getData(2),
                    name: getData(3),
                    gender: getData(4),
                    hourlyWage: getData(5),
                    transportation: getData(6),
                    startTime: getData(7),
                    endTime: getData(8),
                    break: getData(9),
                    status: status,
                    isWorking: status === 'â—¯'
                });
            });
            
            return data;
        }

        function updateRowCalculations() {
            const currentData = getCurrentTableData();
            updateCalculations(currentData);
            
            const rows = document.querySelectorAll('#shiftTable tbody tr');
            rows.forEach((row, index) => {
                const emp = currentData[index];
                if (!emp) return;
                
                const startTime = parseTime(emp.startTime);
                const endTime = parseTime(emp.endTime);
                const breakTime = parseTime(emp.break);
                
                const workHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateWorkHours(startTime, endTime, breakTime) : 0;
                const nightHours = emp.isWorking && startTime !== null && endTime !== null ? 
                    calculateNightShiftHours(startTime, endTime, breakTime) : 0;
                const overtimeHours = emp.isWorking ? Math.max(0, workHours - 8) : 0;
                
                const cells = row.querySelectorAll('td');
                if (cells[11]) cells[11].textContent = workHours > 0 ? workHours.toFixed(2) : '';
                if (cells[12]) cells[12].textContent = nightHours > 0 ? nightHours.toFixed(2) : '';
                if (cells[13]) cells[13].textContent = overtimeHours > 0 ? overtimeHours.toFixed(2) : '';
            });
        }

        function addNewRow() {
            const newEmployee = {
                company: '',
                timeSlot: '',
                mainJob: '',
                name: '',
                gender: '',
                hourlyWage: '',
                transportation: '',
                startTime: '',
                endTime: '',
                break: '',
                status: '',
                isWorking: false
            };
            
            const table = document.getElementById('shiftTable');
            const tbody = table.querySelector('tbody');
            const currentRows = tbody.querySelectorAll('tr');
            const newIndex = currentRows.length;
            
            const statusOptions = ['â—¯', 'æ¬ å‹¤', 'æœ‰ä¼‘'];
            let statusSelect = '<select class="status-select" data-row-index="' + newIndex + '" data-field="status">';
            statusSelect += '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            statusOptions.forEach(option => {
                statusSelect += `<option value="${option}">${option}</option>`;
            });
            statusSelect += '</select>';
            
            const newRowHTML = `
                <tr class="" data-row-index="${newIndex}">
                    <td class="editable-cell" contenteditable="true" data-field="company">${newEmployee.company}</td>
                    <td class="editable-cell" contenteditable="true" data-field="timeSlot">${newEmployee.timeSlot}</td>
                    <td class="editable-cell" contenteditable="true" data-field="mainJob">${newEmployee.mainJob}</td>
                    <td class="editable-cell" contenteditable="true" data-field="name">${newEmployee.name}</td>
                    <td class="editable-cell" contenteditable="true" data-field="gender">${newEmployee.gender}</td>
                    <td class="editable-cell" contenteditable="true" data-field="hourlyWage">${newEmployee.hourlyWage}</td>
                    <td class="editable-cell" contenteditable="true" data-field="transportation">${newEmployee.transportation}</td>
                    <td class="editable-cell time-cell" contenteditable="true" data-field="startTime">${newEmployee.startTime}</td>
                    <td class="editable-cell time-cell" contenteditable="true" data-field="endTime">${newEmployee.endTime}</td>
                    <td class="editable-cell time-cell" contenteditable="true" data-field="break">${newEmployee.break}</td>
                    <td class="status-cell">${statusSelect}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="action-cell">
                        <button class="row-reset-btn" onclick="resetRow(${newIndex})" title="ã“ã®è¡Œã‚’ãƒªã‚»ãƒƒãƒˆ">â†º</button>
                        <button class="row-confirm-btn" onclick="confirmRow(${newIndex})" title="ã“ã®è¡Œã‚’ç¢ºå®š">âœ“</button>
                    </td>
                </tr>
            `;
            
            tbody.insertAdjacentHTML('beforeend', newRowHTML);
            addEditListeners();
            
            const newRow = tbody.querySelector(`tr[data-row-index="${newIndex}"]`);
            const firstEditableCell = newRow.querySelector('.editable-cell');
            if (firstEditableCell) {
                firstEditableCell.focus();
            }
            
            showStatus('æ–°ã—ã„è¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }

        function confirmRow(rowIndex) {
            const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (!row) {
                showStatus('ç¢ºå®šã™ã‚‹è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            const nameCell = row.querySelector('[data-field="name"]');
            const employeeName = nameCell ? nameCell.textContent.trim() : '';
            
            if (row.classList.contains('confirmed')) {
                row.classList.remove('confirmed');
                const confirmBtn = row.querySelector('.row-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = 'âœ“';
                    confirmBtn.title = 'ã“ã®è¡Œã‚’ç¢ºå®š';
                    confirmBtn.style.background = '';
                }
                
                const name = employeeName || 'è¡Œ';
                showStatus(`${name}ã®ç¢ºå®šã‚’è§£é™¤ã—ã¾ã—ãŸ`, 'success');
            } else {
                if (!employeeName.trim()) {
                    showStatus('æ°åã¯å¿…é ˆé …ç›®ã§ã™', 'error');
                    return;
                }
                
                row.classList.add('confirmed');
                const confirmBtn = row.querySelector('.row-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = 'âœ“';
                    confirmBtn.title = 'ç¢ºå®šæ¸ˆã¿ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ï¼‰';
                }
                
                const name = employeeName || 'è¡Œ';
                showStatus(`${name}ã‚’ç¢ºå®šã—ã¾ã—ãŸ`, 'success');
                
                row.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    row.style.transform = '';
                }, 200);
            }
        }

        function resetRow(rowIndex) {
            if (!originalShiftData || !originalShiftData[rowIndex]) {
                const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
                if (!row) return;
                
                if (!confirm('ã“ã®è¡Œã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
                
                const editableCells = row.querySelectorAll('.editable-cell');
                editableCells.forEach(cell => {
                    cell.textContent = '';
                });
                
                const statusSelect = row.querySelector('.status-select');
                if (statusSelect) statusSelect.value = '';
                
                row.classList.remove('working', 'confirmed');
                
                const confirmBtn = row.querySelector('.row-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = 'âœ“';
                    confirmBtn.title = 'ã“ã®è¡Œã‚’ç¢ºå®š';
                    confirmBtn.style.background = '';
                }
                
                updateRowCalculations();
                showStatus('è¡Œã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                return;
            }
            
            if (!confirm('ã“ã®è¡Œã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (!row) return;
            
            const originalData = originalShiftData[rowIndex];
            
            const companyCell = row.querySelector('[data-field="company"]');
            if (companyCell) companyCell.textContent = originalData.company;
            
            const timeSlotCell = row.querySelector('[data-field="timeSlot"]');
            if (timeSlotCell) timeSlotCell.textContent = originalData.timeSlot;
            
            const mainJobCell = row.querySelector('[data-field="mainJob"]');
            if (mainJobCell) mainJobCell.textContent = originalData.mainJob;
            
            const nameCell = row.querySelector('[data-field="name"]');
            if (nameCell) nameCell.textContent = originalData.name;
            
            const genderCell = row.querySelector('[data-field="gender"]');
            if (genderCell) genderCell.textContent = originalData.gender;
            
            const hourlyWageCell = row.querySelector('[data-field="hourlyWage"]');
            if (hourlyWageCell) hourlyWageCell.textContent = originalData.hourlyWage;
            
            const transportationCell = row.querySelector('[data-field="transportation"]');
            if (transportationCell) transportationCell.textContent = originalData.transportation;
            
            const startTimeCell = row.querySelector('[data-field="startTime"]');
            if (startTimeCell) startTimeCell.textContent = originalData.startTime;
            
            const endTimeCell = row.querySelector('[data-field="endTime"]');
            if (endTimeCell) endTimeCell.textContent = originalData.endTime;
            
            const breakCell = row.querySelector('[data-field="break"]');
            if (breakCell) breakCell.textContent = originalData.break;
            
            const statusSelect = row.querySelector('.status-select');
            if (statusSelect) statusSelect.value = originalData.status;
            
            if (originalData.isWorking) {
                row.classList.add('working');
            } else {
                row.classList.remove('working');
            }
            
            row.classList.remove('confirmed');
            
            const confirmBtn = row.querySelector('.row-confirm-btn');
            if (confirmBtn) {
                confirmBtn.innerHTML = 'âœ“';
                confirmBtn.title = 'ã“ã®è¡Œã‚’ç¢ºå®š';
                confirmBtn.style.background = '';
            }
            
            updateRowCalculations();
            
            row.style.background = 'rgba(102, 126, 234, 0.1)';
            setTimeout(() => {
                row.style.background = '';
            }, 1500);
            
            showStatus('è¡Œã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
        }

        function updatePlan(value) {
            planValue = parseFloat(value) || 12200;
            updateCalculations(getCurrentTableData());
        }

        function updateUPH(value) {
            baseUPH = parseFloat(value) || 22;
            updateCalculations(getCurrentTableData());
            showStatus(`åŸºæº–UPHã‚’ ${baseUPH} ã«æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
        }

        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type} show`;
            
            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 3000);
        }

        // Export functions
        function generateAttendanceCheck() {
            if (!document.querySelector('.shift-table')) {
                showStatus('ã‚·ãƒ•ãƒˆè¡¨ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const shiftTitle = document.getElementById('shiftTitle').textContent || 'ã‚·ãƒ•ãƒˆè¡¨';

                const attendanceData = [];
                const rows = document.querySelectorAll('#shiftTable tbody tr');
                
                rows.forEach(row => {
                    const statusSelect = row.querySelector('.status-select');
                    const status = statusSelect ? statusSelect.value : '';
                    
                    if (status === 'â—¯') {
                        const cells = row.querySelectorAll('td');
                        const getData = (index) => cells[index] ? cells[index].textContent.trim() : '';
                        
                        const companyName = getData(0);
                        if (!companyName.trim()) return;
                        
                        attendanceData.push({
                            company: companyName,
                            timeSlot: '',
                            mainJob: getData(2),
                            name: getData(3),
                            startTime: ':',
                            endTime: ':',
                            break: ':',
                            healthCheck: '',
                            heatstrokeCheck: '',
                            memo: ''
                        });
                    }
                });

                const calculationData = {
                    totalHC: attendanceData.length,
                    totalLH: parseFloat(document.querySelector('.calc-value')?.textContent) || 0,
                    forecast: fcstValue,
                    planValue: planValue,
                    baseUPH: baseUPH
                };

                const attendanceHTML = createAttendanceHTML(shiftTitle, attendanceData, calculationData);
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(attendanceHTML);
                printWindow.document.close();
                
                showStatus('å‡ºé€€å‹¤ç¢ºèªè¡¨ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('å‡ºé€€å‹¤ç¢ºèªè¡¨ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus('å‡ºé€€å‹¤ç¢ºèªè¡¨ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function createAttendanceHTML(dateTitle, data, calculationData) {
            return `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºé€€å‹¤ç¢ºèªè¡¨</title>
    <style>
        @media print { body { margin: 0; } .no-print { display: none; } }
        body { font-family: 'Yu Gothic', 'Meiryo', sans-serif; margin: 15px; background-color: white; font-size: 12px; line-height: 1.2; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .header h1 { margin: 0; font-size: 20px; font-weight: bold; line-height: 1.3; }
        .attendance-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; line-height: 1.1; }
        .attendance-table th, .attendance-table td { border: 1px solid #333; padding: 4px 6px; text-align: center; vertical-align: middle; line-height: 1.1; }
        .attendance-table th { background-color: #f0f0f0; font-weight: bold; font-size: 11px; padding: 5px 6px; }
        .attendance-table td { height: 20px; padding: 3px 6px; }
        .name-cell { text-align: left; padding-left: 8px; min-width: 100px; }
        .company-cell { text-align: left; padding-left: 8px; min-width: 70px; }
        .job-cell { text-align: left; padding-left: 8px; min-width: 85px; }
        .time-cell { width: 55px; font-size: 14px; font-weight: bold; padding: 3px 4px; }
        .memo-cell { width: 100px; padding: 3px 4px; }
        .layer-cell { width: 45px; padding: 3px 4px; }
        .health-cell { width: 60px; padding: 3px 4px; font-size: 10px; }
        .heatstroke-cell { width: 65px; padding: 3px 4px; font-size: 10px; }
        .print-buttons { margin: 15px 0; text-align: center; }
        .print-btn { background-color: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 0 8px; }
        .print-btn:hover { background-color: #5a6fd8; }
        .pdf-btn { background-color: #764ba2; } .pdf-btn:hover { background-color: #6b46c1; }
    </style>
</head>
<body>
    <div class="print-buttons no-print">
        <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
        <button class="print-btn pdf-btn" onclick="window.print()">ğŸ“„ PDFä¿å­˜</button>
        <button class="print-btn" onclick="window.close()" style="background-color: #FF5722;">âŒ é–‰ã˜ã‚‹</button>
    </div>
    <div class="header">
        <h1>${dateTitle}</h1>
        <p style="margin: 8px 0 0 0; font-size: 13px;">å‡ºé€€å‹¤ç¢ºèªè¡¨ï¼ˆåŸºæº–UPH: ${calculationData.baseUPH}ï¼‰</p>
    </div>
    <table class="attendance-table">
        <thead>
            <tr><th>ä¼šç¤¾å</th><th>éšå±¤</th><th>ãƒ¡ã‚¤ãƒ³æ¥­å‹™</th><th>æ°å</th><th>é–‹å§‹æ™‚é–“</th><th>çµ‚äº†æ™‚é–“</th><th>ä¼‘æ†©</th><th>è‡ªå·±ç”³å‘Š<br>ä½“èª¿</th><th>ç†±ä¸­ç—‡<br>å¯¾ç­–ç¢ºèª</th><th>å‚™è€ƒ</th></tr>
        </thead>
        <tbody>
            ${data.map(emp => `<tr><td class="company-cell">${emp.company}</td><td class="layer-cell">${emp.timeSlot}</td><td class="job-cell">${emp.mainJob}</td><td class="name-cell">${emp.name}</td><td class="time-cell">${emp.startTime}</td><td class="time-cell">${emp.endTime}</td><td class="time-cell">${emp.break}</td><td class="health-cell">&nbsp;</td><td class="heatstroke-cell">&nbsp;</td><td class="memo-cell">${emp.memo}</td></tr>`).join('')}
            ${Array.from({length: Math.max(0, 20 - data.length)}, () => `<tr><td class="company-cell">&nbsp;</td><td class="layer-cell">&nbsp;</td><td class="job-cell">&nbsp;</td><td class="name-cell">&nbsp;</td><td class="time-cell">:</td><td class="time-cell">:</td><td class="time-cell">:</td><td class="health-cell">&nbsp;</td><td class="heatstroke-cell">&nbsp;</td><td class="memo-cell">&nbsp;</td></tr>`).join('')}
        </tbody>
    </table>
    <div style="margin-top: 20px; text-align: right; font-size: 11px; line-height: 1.3;"><p>è²¬ä»»è€…ç¢ºèªï¼š_________________ã€€ã€€æ—¥ä»˜ï¼š_______________</p></div>
</body>
</html>`;
        }

        function exportToExcel() {
            if (!document.querySelector('.shift-table')) {
                showStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const shiftTitle = document.getElementById('shiftTitle').textContent || 'ã‚·ãƒ•ãƒˆè¡¨';

                const data = [];
                data.push([shiftTitle]);
                data.push([`åŸºæº–UPH: ${baseUPH}`]);
                data.push([]);

                const headers = ['ä¼šç¤¾å', 'æ™‚é–“å¸¯', 'ãƒ¡ã‚¤ãƒ³æ¥­å‹™', 'æ°å', 'æ€§åˆ¥', 'æ™‚çµ¦', 'äº¤é€šè²»', 'é–‹å§‹æ™‚é–“', 'çµ‚äº†æ™‚é–“', 'ä¼‘æ†©', 'å‹¤å‹™çŠ¶æ³', 'å‹¤å‹™LH', 'å¤œå‹¤æ™‚é–“', 'æ®‹æ¥­æ™‚é–“'];
                data.push(headers);

                const tableData = getCurrentTableData();
                tableData.forEach(emp => {
                    const startTime = parseTime(emp.startTime);
                    const endTime = parseTime(emp.endTime);
                    const breakTime = parseTime(emp.break);
                    
                    const workHours = emp.isWorking && startTime !== null && endTime !== null ? 
                        calculateWorkHours(startTime, endTime, breakTime) : 0;
                    const nightHours = emp.isWorking && startTime !== null && endTime !== null ? 
                        calculateNightShiftHours(startTime, endTime, breakTime) : 0;
                    const overtimeHours = emp.isWorking ? Math.max(0, workHours - 8) : 0;
                    
                    data.push([
                        emp.company, emp.timeSlot, emp.mainJob, emp.name, emp.gender,
                        emp.hourlyWage, emp.transportation, emp.startTime, emp.endTime,
                        emp.break, emp.status, 
                        workHours > 0 ? workHours.toFixed(2) : '',
                        nightHours > 0 ? nightHours.toFixed(2) : '',
                        overtimeHours > 0 ? overtimeHours.toFixed(2) : ''
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [
                    { width: 15 }, { width: 10 }, { width: 12 }, { width: 15 }, { width: 8 }, { width: 10 },
                    { width: 12 }, { width: 10 }, { width: 10 }, { width: 8 }, { width: 10 }, { width: 10 }, { width: 10 }, { width: 10 }
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'è©³ç´°ãƒ‡ãƒ¼ã‚¿');
                
                const fileName = `ãƒ“ãƒ¥ãƒ¼ã‚¢ç·¨é›†_è©³ç´°ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showStatus('è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function exportCompanySummary() {
            if (!document.querySelector('.shift-table')) {
                showStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            if (!allCompanies || allCompanies.length === 0) {
                showStatus('ä¼šç¤¾ãƒªã‚¹ãƒˆãŒæŠ½å‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const companySummary = generateCompanySummary();
                const shiftTitle = document.getElementById('shiftTitle').textContent || 'ã‚·ãƒ•ãƒˆè¡¨';

                const data = [];
                data.push([shiftTitle + ' ä¼šç¤¾åˆ¥é›†è¨ˆ']);
                data.push([`åŸºæº–UPH: ${baseUPH}`]);
                data.push([]);
                
                data.push(['HC']);
                // å…¨ä¼šç¤¾ã‚’å›ºå®šé †åºã§å‡ºåŠ›
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { hc: 0, totalLH: 0, totalCost: 0 };
                    data.push([company, summary.hc || '']);
                });
                
                const totalHC = Object.values(companySummary).reduce((sum, s) => sum + s.hc, 0);
                data.push(['', totalHC]);
                data.push([]);
                
                data.push(['çµŒè²»']);
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { hc: 0, totalLH: 0, totalCost: 0 };
                    const cost = summary.totalCost || 0;
                    data.push([company, cost > 0 ? Math.round(cost) : '']);
                });
                data.push(['', Math.round(Object.values(companySummary).reduce((sum, s) => sum + s.totalCost, 0))]);
                data.push([]);
                
                data.push(['LH']);
                allCompanies.forEach(company => {
                    const summary = companySummary[company] || { hc: 0, totalLH: 0, totalCost: 0 };
                    const lh = summary.totalLH || 0;
                    data.push([company, lh > 0 ? Math.round(lh) : '']);
                });
                data.push(['', Math.round(Object.values(companySummary).reduce((sum, s) => sum + s.totalLH, 0))]);

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{ width: 15 }, { width: 12 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ä¼šç¤¾åˆ¥é›†è¨ˆ');
                
                const fileName = `ãƒ“ãƒ¥ãƒ¼ã‚¢ç·¨é›†_ä¼šç¤¾åˆ¥é›†è¨ˆ_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showStatus('ä¼šç¤¾åˆ¥é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('ä¼šç¤¾åˆ¥é›†è¨ˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ä¼šç¤¾åˆ¥é›†è¨ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function generateCompanySummary() {
            const tableData = getCurrentTableData();
            const companySummary = {};
            
            tableData.forEach(emp => {
                if (emp.isWorking && emp.company.trim()) {
                    const company = emp.company.trim();
                    const hourlyWageStr = emp.hourlyWage || '0';
                    const transportationStr = emp.transportation || '0';
                    
                    const hourlyWage = parseFloat(String(hourlyWageStr).replace(/[^\d.]/g, '')) || 0;
                    const transportation = parseFloat(String(transportationStr).replace(/[^\d.]/g, '')) || 0;
                    
                    if (!companySummary[company]) {
                        companySummary[company] = { hc: 0, totalLH: 0, totalCost: 0 };
                    }
                    
                    companySummary[company].hc += 1;
                    
                    const startTime = parseTime(emp.startTime);
                    const endTime = parseTime(emp.endTime);
                    const breakTime = parseTime(emp.break);
                    
                    if (startTime !== null && endTime !== null) {
                        const workHours = calculateWorkHours(startTime, endTime, breakTime);
                        const nightHours = calculateNightShiftHours(startTime, endTime, breakTime);
                        const overtimeHours = Math.max(0, workHours - 8);
                        
                        companySummary[company].totalLH += workHours;
                        
                        const regularHours = Math.max(0, workHours - overtimeHours);
                        const baseCost = regularHours * hourlyWage;
                        const overtimeBaseCost = overtimeHours * hourlyWage;
                        const nightAllowance = nightHours * hourlyWage * 0.25;
                        const overtimeAllowance = overtimeHours * hourlyWage * 0.25;
                        
                        companySummary[company].totalCost += baseCost + overtimeBaseCost + nightAllowance + overtimeAllowance + transportation;
                    } else {
                        companySummary[company].totalCost += transportation;
                    }
                }
            });
            
            return companySummary;
        }

        function backupData() {
            if (!shiftData) {
                showStatus('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const currentData = getCurrentTableData();
                const backupData = {
                    originalData: shiftData,
                    currentData: currentData,
                    calculations: {
                        baseUPH: baseUPH,
                        planValue: planValue,
                        fcstValue: fcstValue,
                        isNightShift: isNightShift
                    },
                    allCompanies: allCompanies,
                    timestamp: new Date().toISOString(),
                    version: '1.1'
                };

                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_v1.1_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function clearData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                shiftData = null;
                originalShiftData = [];
                allCompanies = [];
                
                document.getElementById('calculationPanel').classList.add('hidden');
                document.getElementById('tableContainer').classList.add('hidden');
                document.getElementById('welcomeMessage').style.display = 'block';
                
                localStorage.removeItem('shiftDataTransfer');
                localStorage.removeItem('shiftDataTransfer_timestamp');
                
                updateStatusIndicator('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'warning');
                showStatus('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ', 'success');
            }
        }

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', e);
            updateStatusIndicator('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        });

        console.log('=== ã‚·ãƒ•ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ v1.1 èª­ã¿è¾¼ã¿å®Œäº† ===');
    </script>
</body>
</html>
